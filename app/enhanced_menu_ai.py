"""
Enhanced Menu AI vá»›i Multi-AI Support
Há»— trá»£ fallback giá»¯a nhiá»u AI providers
"""

from flask import current_app
import logging

logger = logging.getLogger(__name__)

class EnhancedMenuAI:
    def __init__(self):
        """Initialize Enhanced Menu AI vá»›i multi-provider support"""
        self.current_provider = "gemini"  # Default
        self.multi_ai_service = None
        self._init_multi_ai()
    
    def _init_multi_ai(self):
        """Initialize Multi-AI Service náº¿u available"""
        try:
            from .multi_ai_service import MultiAIService
            import sys
            import os
            
            # Add parent directory to path
            current_dir = os.path.dirname(os.path.abspath(__file__))
            parent_dir = os.path.dirname(current_dir)
            if parent_dir not in sys.path:
                sys.path.append(parent_dir)
            
            from multi_ai_config import MultiAIConfig
            
            config = MultiAIConfig.get_config()
            if config:
                self.multi_ai_service = MultiAIService(config)
                logger.info("âœ… Enhanced Menu AI initialized with Multi-AI support")
            else:
                logger.warning("âš ï¸ No AI providers configured, using fallback")
        except Exception as e:
            logger.warning(f"âš ï¸ Multi-AI not available: {e}")
    
    def generate_menu(self, age_group="2-3 tuá»•i", dietary_requirements="", 
                     available_ingredients="", use_multi_ai=True):
        """
        Generate menu vá»›i multi-AI fallback support
        """
        # Táº¡o prompt cho menu
        prompt = self._create_menu_prompt(age_group, dietary_requirements, available_ingredients)
        
        # Try Multi-AI first if available and enabled
        if use_multi_ai and self.multi_ai_service:
            logger.info("ğŸš€ Using Multi-AI Service for menu generation")
            result = self.multi_ai_service.generate_text(prompt)
            
            if result["success"]:
                logger.info(f"âœ… Menu generated by {result['provider'].upper()}")
                return self._parse_menu_response(result["content"], result["provider"])
            else:
                logger.warning(f"âš ï¸ Multi-AI failed: {result['error']}")
                # Fallback to original gemini service
        
        # Fallback to original Gemini service
        logger.info("ğŸ”„ Falling back to original Gemini service")
        return self._fallback_gemini_menu(age_group, dietary_requirements, available_ingredients)
    
    def _create_menu_prompt(self, age_group, dietary_requirements, available_ingredients):
        """Táº¡o prompt cho AI menu generation"""
        prompt = f"""
Báº¡n lÃ  chuyÃªn gia dinh dÆ°á»¡ng tráº» em. Táº¡o thá»±c Ä‘Æ¡n tuáº§n cho tráº» {age_group}.

YÃŠU Cáº¦U:
- Äá»™ tuá»•i: {age_group}
- YÃªu cáº§u Ä‘áº·c biá»‡t: {dietary_requirements if dietary_requirements else "KhÃ´ng cÃ³"}
- NguyÃªn liá»‡u cÃ³ sáºµn: {available_ingredients if available_ingredients else "NguyÃªn liá»‡u thÃ´ng thÆ°á»ng"}

Táº O THá»°C ÄÆ N CHO 6 NGÃ€Y (Thá»© 2 - Thá»© 7):
Má»—i ngÃ y gá»“m:
- Bá»¯a sÃ¡ng
- Phá»¥ sÃ¡ng  
- Bá»¯a trÆ°a
- TrÃ¡ng miá»‡ng
- Bá»¯a xáº¿
- Bá»¯a xáº¿ chiá»u

Format tráº£ vá»:
**Thá»© 2:**
â€¢ SÃ¡ng: [MÃ³n Äƒn]
â€¢ Phá»¥ sÃ¡ng: [MÃ³n Äƒn]
â€¢ TrÆ°a: [MÃ³n Äƒn]
â€¢ TrÃ¡ng miá»‡ng: [MÃ³n Äƒn]
â€¢ Xáº¿: [MÃ³n Äƒn]  
â€¢ Xáº¿ chiá»u: [MÃ³n Äƒn]

[Tiáº¿p tá»¥c cho cÃ¡c ngÃ y khÃ¡c...]

**Ghi chÃº dinh dÆ°á»¡ng:**
[LÆ°u Ã½ vá» dinh dÆ°á»¡ng phÃ¹ há»£p cho Ä‘á»™ tuá»•i]
"""
        return prompt
    
    def _parse_menu_response(self, content, provider):
        """Parse AI response thÃ nh format menu"""
        try:
            # Simple parsing Ä‘á»ƒ extract menu items
            lines = content.split('\n')
            menu_items = []
            
            current_day = ""
            for line in lines:
                line = line.strip()
                if line.startswith('**Thá»©'):
                    current_day = line.replace('**', '').replace(':', '')
                    menu_items.append(f"ğŸ“… **{current_day}:**")
                elif line.startswith('â€¢') and current_day:
                    menu_items.append(f"  {line}")
                elif line and not line.startswith('**') and current_day:
                    if len(menu_items) > 0 and not menu_items[-1].startswith('  â€¢'):
                        menu_items.append(line)
            
            # Add provider info
            menu_items.extend([
                "",
                f"ğŸ¤– **Generated by:** {provider.upper()}",
                f"âš¡ **Status:** Menu created successfully âœ…"
            ])
            
            return menu_items
            
        except Exception as e:
            logger.error(f"âŒ Error parsing menu response: {e}")
            return [
                "âŒ Lá»—i khi xá»­ lÃ½ menu tá»« AI",
                f"ğŸ¤– Provider: {provider}",
                "ğŸ”„ Vui lÃ²ng thá»­ láº¡i"
            ]
    
    def _fallback_gemini_menu(self, age_group, dietary_requirements, available_ingredients):
        """Fallback to original Gemini menu service"""
        try:
            from .menu_ai import get_ai_menu_suggestions
            return get_ai_menu_suggestions(
                age_group=age_group,
                dietary_requirements=dietary_requirements,
                available_ingredients=available_ingredients
            )
        except Exception as e:
            logger.error(f"âŒ Fallback Gemini menu failed: {e}")
            return [
                "âŒ KhÃ´ng thá»ƒ táº¡o menu tá»« AI",
                "ğŸ”„ Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng vÃ  thá»­ láº¡i",
                f"ğŸ“ Error: {str(e)[:100]}"
            ]

# Global instance
enhanced_menu_ai = EnhancedMenuAI()

def get_ai_menu_suggestions_enhanced(age_group="2-3 tuá»•i", dietary_requirements="", 
                                   count=5, available_ingredients="", use_multi_ai=True):
    """
    Enhanced menu generation vá»›i multi-AI support
    """
    return enhanced_menu_ai.generate_menu(
        age_group=age_group,
        dietary_requirements=dietary_requirements, 
        available_ingredients=available_ingredients,
        use_multi_ai=use_multi_ai
    )

# Backward compatibility
def get_ai_menu_suggestions(age_group="2-3 tuá»•i", dietary_requirements="", count=5, available_ingredients=""):
    """Original function vá»›i enhanced fallback"""
    # Try enhanced version first
    try:
        return get_ai_menu_suggestions_enhanced(
            age_group=age_group,
            dietary_requirements=dietary_requirements,
            available_ingredients=available_ingredients,
            use_multi_ai=True
        )
    except Exception as e:
        logger.warning(f"âš ï¸ Enhanced menu failed, using original: {e}")
        
        # Original fallback code
        from .gemini_service import gemini_service
        
        print(f"ğŸš€ [FALLBACK] Original Gemini AI for {age_group}")
        
        age_months = 24
        if "1-3" in age_group:
            age_months = 24
        elif "3-5" in age_group:
            age_months = 48
        elif "1-5" in age_group:
            age_months = 36

        try:
            result = gemini_service.generate_menu_suggestions(
                age_months=age_months,
                available_ingredients=available_ingredients,
                dietary_preferences=dietary_requirements
            )
            
            if isinstance(result, dict) and 'weekly_menu' in result:
                suggestions = []
                days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat']
                day_names = ['Thá»© 2', 'Thá»© 3', 'Thá»© 4', 'Thá»© 5', 'Thá»© 6', 'Thá»© 7']
                slots = ['morning', 'snack', 'dessert', 'lunch', 'afternoon', 'lateafternoon']
                slot_names = ['SÃ¡ng', 'Phá»¥ sÃ¡ng', 'TrÃ¡ng miá»‡ng', 'TrÆ°a', 'Xáº¿', 'Xáº¿ chiá»u']
                
                for i, day in enumerate(days):
                    suggestions.append(f"ğŸ“… **{day_names[i]}:**")
                    day_menu = result['weekly_menu'][day]
                    for j, slot in enumerate(slots):
                        meal = day_menu.get(slot, 'MÃ³n Äƒn dinh dÆ°á»¡ng')
                        suggestions.append(f"  â€¢ {slot_names[j]}: {meal}")
                    suggestions.append("")
                
                suggestions.extend([
                    "ğŸ“Š **Tá»•ng káº¿t:**",
                    f"â€¢ Tá»•ng sá»‘ bá»¯a Äƒn: {result.get('total_meals', 36)}",
                    "â€¢ Tráº¡ng thÃ¡i: Thá»±c Ä‘Æ¡n Ä‘Ã£ táº¡o âœ… (Fallback mode)"
                ])
                
                return suggestions
            else:
                return ["âŒ KhÃ´ng thá»ƒ táº¡o thá»±c Ä‘Æ¡n", "ğŸ”„ Vui lÃ²ng thá»­ láº¡i"]
                
        except Exception as e:
            logger.error(f"âŒ Original menu generation failed: {e}")
            return ["âŒ Lá»—i AI service", f"ğŸ“ {str(e)[:100]}"]
