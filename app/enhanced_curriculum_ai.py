"""
Enhanced Curriculum AI v·ªõi Multi-AI Support
H·ªó tr·ª£ fallback gi·ªØa nhi·ªÅu AI providers
"""

import logging

logger = logging.getLogger(__name__)

class EnhancedCurriculumAI:
    def __init__(self):
        """Initialize Enhanced Curriculum AI v·ªõi multi-provider support"""
        self.current_provider = "gemini"  # Default
        self.multi_ai_service = None
        self._init_multi_ai()
    
    def _init_multi_ai(self):
        """Initialize Multi-AI Service n·∫øu available"""
        try:
            from .multi_ai_service import MultiAIService
            import sys
            import os
            
            # Add parent directory to path
            current_dir = os.path.dirname(os.path.abspath(__file__))
            parent_dir = os.path.dirname(current_dir)
            if parent_dir not in sys.path:
                sys.path.append(parent_dir)
            
            from multi_ai_config import MultiAIConfig
            
            config = MultiAIConfig.get_config()
            if config:
                self.multi_ai_service = MultiAIService(config)
                logger.info("‚úÖ Enhanced Curriculum AI initialized with Multi-AI support")
            else:
                logger.warning("‚ö†Ô∏è No AI providers configured, using fallback")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è Multi-AI not available: {e}")
    
    def generate_curriculum_suggestions(self, age_group="2-3 tu·ªïi", week_number=1, themes="", special_focus=""):
        """
        Generate curriculum suggestions - compatible v·ªõi routes.py
        """
        return self.generate_curriculum(age_group, week_number, use_multi_ai=True)
    
    def generate_curriculum(self, age_group="2-3 tu·ªïi", week_number=1, use_multi_ai=True):
        """
        Generate curriculum v·ªõi multi-AI fallback support
        Returns structured data that matches the curriculum template
        """
        # T·∫°o prompt cho curriculum
        prompt = self._create_curriculum_prompt(age_group, week_number)
        
        # Try Multi-AI first if available and enabled
        if use_multi_ai and self.multi_ai_service:
            logger.info("üöÄ Using Multi-AI Service for curriculum generation")
            result = self.multi_ai_service.generate_text(prompt)
            
            if result["success"]:
                logger.info(f"‚úÖ Curriculum generated by {result['provider'].upper()}")
                
                # DEBUG: Log raw AI response to understand quality issues
                logger.info(f"üîç [DEBUG] Raw AI response length: {len(result['content'])} chars")
                logger.info(f"üîç [DEBUG] Raw AI response preview: {result['content'][:500]}...")
                
                parsed_result = self._parse_curriculum_response(result["content"], result["provider"])
                
                if parsed_result.get("success"):
                    # DEBUG: Log parsed data to check quality
                    data = parsed_result.get('data', {})
                    logger.info(f"üîç [DEBUG] Parsed days: {list(data.keys())}")
                    if 'mon' in data:
                        sample_activities = list(data['mon'].values())[:3]
                        logger.info(f"üîç [DEBUG] Sample Monday activities: {sample_activities}")
                    
                    return parsed_result
                else:
                    logger.warning(f"‚ö†Ô∏è Parsing failed: {parsed_result.get('error')}")
                    # Fallback to original curriculum service
            else:
                logger.warning(f"‚ö†Ô∏è Multi-AI failed: {result['error']}")
                # Fallback to original curriculum service
        
        # Fallback to original Curriculum service
        logger.info("üîÑ Falling back to original Curriculum service")
        return self._fallback_curriculum(age_group, week_number)

    def _create_curriculum_prompt(self, age_group, week_number):
        """T·∫°o prompt cho AI curriculum generation theo template th·ª±c t·∫ø v·ªõi output c·ª• th·ªÉ"""
        prompt = f"""
B·∫°n l√† chuy√™n gia gi√°o d·ª•c m·∫ßm non. T·∫°o ch∆∞∆°ng tr√¨nh h·ªçc tu·∫ßn {week_number} cho tr·∫ª {age_group} theo m·∫´u d·ª± √°n ho·∫°t ƒë·ªông th·ª±c t·∫ø.

Y√äU C·∫¶U QUAN TR·ªåNG:
- T·∫°o ho·∫°t ƒë·ªông C·ª§ TH·ªÇ, CHI TI·∫æT cho t·ª´ng khung gi·ªù
- M·ªói ho·∫°t ƒë·ªông ph·∫£i c√≥ t√™n r√µ r√†ng v√† m√¥ t·∫£ ng·∫Øn g·ªçn
- Ph√π h·ª£p v·ªõi ƒë·ªô tu·ªïi {age_group}
- Theo ƒë√∫ng khung gi·ªù c·ªë ƒë·ªãnh

CH·ªåN CH·ª¶ ƒê·ªÄ PH√ô H·ª¢P CHO TU·∫¶N {week_number}:
(V√≠ d·ª•: "Th·∫ø gi·ªõi ƒë·ªông v·∫≠t", "Gia ƒë√¨nh y√™u th∆∞∆°ng", "M√†u s·∫Øc v√† h√¨nh kh·ªëi", "Th·∫ø gi·ªõi c√¢y c·ªè", "C√°c ngh·ªÅ nghi·ªáp", "Ph∆∞∆°ng ti·ªán giao th√¥ng")

FORMAT TR·∫¢ V·ªÄ - T·ª™NG NG√ÄY C·ª§ TH·ªÇ:

**Th·ª© 2:**
morning_1: ƒê√≥n tr·∫ª, massage k√≠ch th√≠ch gi√°c quan v·ªõi b√≥ng m·ªÅm, ƒÉn s√°ng (ch√°o g√†, b√°nh m√¨, s·ªØa)
morning_2: Th·ªÉ d·ª•c s√°ng - B√†i "Th·ªè con nh·∫£y nh√≥t", tr√≤ chuy·ªán v·ªÅ ch·ªß ƒë·ªÅ tu·∫ßn, ki·ªÉm tra th√¢n th·ªÉ
morning_3: HƒêNT - Quan s√°t ƒë·ªông v·∫≠t trong v∆∞·ªùn (chim, b∆∞·ªõm, ki·∫øn)
morning_4: English: Animals - Dog/Woof, Cat/Meow, Bird/Tweet, Fish/Splash + games "What is it?"
morning_5: Kh√°m ph√° ƒë·ªông v·∫≠t c√≥ 4 ch√¢n - Quan s√°t h√¨nh ·∫£nh, m√¥ ph·ªèng di chuy·ªÉn, h·ªçc t√™n g·ªçi
morning_6: V·ªá sinh tay ch√¢n, ƒÉn tr∆∞a (c∆°m, th·ªãt, rau), ng·ªß tr∆∞a v·ªõi nh·∫°c ru √™m d·ªãu
afternoon_1: Lego time - X√¢y d·ª±ng nh√† cho th√∫ c∆∞ng (ch√≥, m√®o) v·ªõi h∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc
afternoon_2: U·ªëng n∆∞·ªõc √©p tr√°i c√¢y, v·∫≠n ƒë·ªông nh·∫π - nh·∫£y nh∆∞ th·ªè, b√≤ nh∆∞ m√®o, ƒÉn x·∫ø b√°nh quy
afternoon_3: Yoga ƒë·ªông v·∫≠t - T∆∞ th·∫ø m√®o, t∆∞ th·∫ø ch√≥, t∆∞ th·∫ø r·∫Øn + th·ªü s√¢u
afternoon_4: Ho·∫°t ƒë·ªông t·ª± do - Xem s√°ch tranh v·ªÅ ƒë·ªông v·∫≠t, ƒë·ª£i b·ªë m·∫π ƒë·∫øn ƒë√≥n

**Th·ª© 3:**
morning_1: ƒê√≥n tr·∫ª, STEAM - Kh√°m ph√° √¢m thanh ƒë·ªông v·∫≠t qua ƒë·ªì ch∆°i, ƒÉn s√°ng
morning_2: Th·ªÉ d·ª•c s√°ng - B√†i "G√† m√°i v·ªõi ƒë√†n con", th·∫£o lu·∫≠n v·ªÅ gi·∫•c m∆° c·ªßa tr·∫ª
morning_3: HƒêNT - Thu th·∫≠p l√° c√¢y ƒë·ªÉ l√†m th·ª©c ƒÉn gi·∫£ cho ƒë·ªông v·∫≠t
morning_4: English Review - Animal sounds v·ªõi tr√≤ ch∆°i ƒëo√°n √¢m thanh, h√°t "Old MacDonald"
morning_5: T√¨m hi·ªÉu ƒë·ªông v·∫≠t ƒÉn c·ªè - Th·ªè, d√™, b√≤ qua h√¨nh ·∫£nh v√† video ng·∫Øn
morning_6: V·ªá sinh, ƒÉn tr∆∞a (b√∫n th·ªãt n∆∞·ªõng, canh chua), ng·ªß tr∆∞a
afternoon_1: Ho·∫°t ƒë·ªông v·ªõi gi√°o c·ª• - Gh√©p h√¨nh 12 m·∫£nh ƒë·ªông v·∫≠t, x·∫øp h√¨nh kh·ªëi th√†nh chu·ªìng
afternoon_2: U·ªëng n∆∞·ªõc, ƒÉn x·∫ø (chu·ªëi, s·ªØa chua), v·∫≠n ƒë·ªông - b·∫Øt ch∆∞·ªõc ti·∫øng ƒë·ªông v·∫≠t
afternoon_3: V·∫Ω v√† t√¥ m√†u ƒë·ªông v·∫≠t y√™u th√≠ch - Cung c·∫•p m·∫´u ƒë∆°n gi·∫£n ƒë·ªÉ tr·∫ª t√¥
afternoon_4: K·ªÉ chuy·ªán "Ba ch√∫ heo con", chu·∫©n b·ªã ƒë·ªì d√πng c√° nh√¢n

**Th·ª© 4 - Th·ª© 4 vui v·∫ª:**
morning_1: ƒê√≥n tr·∫ª, ho·∫°t ƒë·ªông ƒë·∫∑c bi·ªát - Trang tr√≠ m·∫∑t n·∫° ƒë·ªông v·∫≠t ƒë∆°n gi·∫£n, ƒÉn s√°ng
morning_2: Th·ªÉ d·ª•c ƒë·∫∑c bi·ªát - M√∫a theo nh·∫°c "Jungle Boogie", tr√≤ chuy·ªán vui v·∫ª
morning_3: HƒêNT ƒë·∫∑c bi·ªát - Tr√≤ ch∆°i "SƒÉn t√¨m kho b√°u ƒë·ªông v·∫≠t" trong s√¢n ch∆°i
morning_4: English Fun Day - Animal charades, h√°t "If You're Happy and You Know It" phi√™n b·∫£n ƒë·ªông v·∫≠t
morning_5: Th·ª© 4 vui v·∫ª - L√†m b√°nh quy h√¨nh ƒë·ªông v·∫≠t ƒë∆°n gi·∫£n (kh√¥ng n∆∞·ªõng)
morning_6: V·ªá sinh, ƒÉn tr∆∞a (c∆°m chi√™n d∆∞∆°ng ch√¢u), ng·ªß tr∆∞a
afternoon_1: Ho·∫°t ƒë·ªông ƒë·∫∑c bi·ªát - K·ªãch m√∫a "R·ª´ng xanh v√† nh·ªØng ng∆∞·ªùi b·∫°n"
afternoon_2: Ti·ªác nh·ªè - ƒÇn b√°nh quy ƒë√£ l√†m, u·ªëng n∆∞·ªõc cam
afternoon_3: Yoga th∆∞ gi√£n - T∆∞ th·∫ø th∆∞ gi√£n, nghe nh·∫°c chill
afternoon_4: Xem phim ho·∫°t h√¨nh ng·∫Øn v·ªÅ ƒë·ªông v·∫≠t, chia s·∫ª c·∫£m x√∫c

**Th·ª© 5:**
morning_1: ƒê√≥n tr·∫ª, STEAM - Kh√°m ph√° k·∫øt c·∫•u l√¥ng v≈©, v·∫£y c√° qua k√≠nh l√∫p, ƒÉn s√°ng
morning_2: Th·ªÉ d·ª•c s√°ng - B√†i "Voi con", chia s·∫ª v·ªÅ ho·∫°t ƒë·ªông h√¥m qua
morning_3: HƒêNT - ChƒÉm s√≥c c√¢y xanh, t∆∞·ªõi n∆∞·ªõc cho c√¢y (m√¥i tr∆∞·ªùng cho ƒë·ªông v·∫≠t)
morning_4: English: Zoo animals - Elephant, Lion, Monkey, Giraffe + tr√≤ ch∆°i "Zoo keeper"
morning_5: ƒê·ªông v·∫≠t hoang d√£ - T√¨m hi·ªÉu s∆∞ t·ª≠, voi, kh·ªâ qua tranh ·∫£nh l·ªõn v√† m√¥ ph·ªèng
morning_6: V·ªá sinh, ƒÉn tr∆∞a (ph·ªü g√†, nem), ng·ªß tr∆∞a
afternoon_1: Lego n√¢ng cao - X√¢y d·ª±ng v∆∞·ªùn th√∫ mini c√≥ nhi·ªÅu khu v·ª±c kh√°c nhau
afternoon_2: U·ªëng n∆∞·ªõc, ƒÉn x·∫ø (b√°nh flan), v·∫≠n ƒë·ªông - ch·∫°y nh∆∞ b√°o, ƒëi ch·∫≠m nh∆∞ r√πa
afternoon_3: Th·ª±c h√†nh t·ª´ v·ª±ng - Ch·ªâ v√† ƒë·ªçc t√™n ƒë·ªông v·∫≠t qua flashcard l·ªõn
afternoon_4: Ho·∫°t ƒë·ªông y√™n tƒ©nh - X·∫øp puzzle ƒë·ªông v·∫≠t, ƒë·ªçc s√°ch

**Th·ª© 6:**
morning_1: ƒê√≥n tr·∫ª, STEAM - Quan s√°t t·ªï chim nh·ªè (m√¥ h√¨nh), ƒÉn s√°ng
morning_2: Th·ªÉ d·ª•c s√°ng - B√†i "B∆∞∆°m b∆∞·ªõm bay bay", t·ªïng k·∫øt tu·∫ßn h·ªçc
morning_3: HƒêNT - Thu g·ªçn ƒë·ªì ch∆°i, s·∫Øp x·∫øp g√≥c thi√™n nhi√™n
morning_4: English Review - √în t·∫≠p t·∫•t c·∫£ t·ª´ v·ª±ng ƒë·ªông v·∫≠t tu·∫ßn qua v·ªõi tr√≤ ch∆°i bingo
morning_5: T·ªïng k·∫øt ch·ªß ƒë·ªÅ - Tr√¨nh b√†y ƒë·ªông v·∫≠t y√™u th√≠ch, chia s·∫ª ƒëi·ªÅu h·ªçc ƒë∆∞·ª£c
morning_6: V·ªá sinh, ƒÉn tr∆∞a (c∆°m g√† x·ªëi m·ª°), ng·ªß tr∆∞a
afternoon_1: Ho·∫°t ƒë·ªông t·ªïng k·∫øt - L√†m cu·ªën s√°ch nh·ªè v·ªÅ ƒë·ªông v·∫≠t v·ªõi h√¨nh v·∫Ω c·ªßa tr·∫ª
afternoon_2: U·ªëng n∆∞·ªõc, ƒÉn x·∫ø cu·ªëi tu·∫ßn (b√°nh kem nh·ªè), v·∫≠n ƒë·ªông t·ª± do
afternoon_3: Ti·∫øt m·ª•c cu·ªëi tu·∫ßn - Tr·∫ª tr√¨nh di·ªÖn m√¥ ph·ªèng ƒë·ªông v·∫≠t y√™u th√≠ch
afternoon_4: D·ªçn d·∫πp, chia s·∫ª k·∫ø ho·∫°ch cu·ªëi tu·∫ßn, ƒë√≥n b·ªë m·∫π

L∆ØU √ù:
- M·ªói ho·∫°t ƒë·ªông ph·∫£i C·ª§ TH·ªÇ, c√≥ t√™n r√µ r√†ng
- Bao g·ªìm c·∫£ ƒë·ªì ƒÉn, ƒë·ªì ch∆°i, ph∆∞∆°ng ph√°p c·ª• th·ªÉ
- Khuy·∫øn kh√≠ch s·ª± tham gia t√≠ch c·ª±c c·ªßa tr·∫ª
- Ch√∫ √Ω an to√†n v√† ph√π h·ª£p ƒë·ªô tu·ªïi {age_group}
"""
        return prompt
        return prompt
    
    def _parse_curriculum_response(self, content, provider):
        """Parse AI response th√†nh format curriculum template structure"""
        try:
            import json
            import re
            
            print(f"üîç [DEBUG] Parsing curriculum response from {provider}")
            print(f"üîç [DEBUG] Content length: {len(content)}")
            print(f"üîç [DEBUG] First 500 chars: {content[:500]}")
            
            # Define the curriculum structure matching the template (5 days only: Mon-Fri)
            curriculum_data = {
                'mon': {}, 'tue': {}, 'wed': {}, 'thu': {}, 'fri': {}
            }
            
            morning_slots = ['morning_1', 'morning_2', 'morning_3', 'morning_4', 'morning_5', 'morning_6']
            afternoon_slots = ['afternoon_1', 'afternoon_2', 'afternoon_3', 'afternoon_4']
            
            # Initialize with sample activities (fallback)
            sample_activities = {
                'morning_1': 'ƒê√≥n tr·∫ª, massage k√≠ch th√≠ch gi√°c quan, ƒÉn s√°ng',
                'morning_2': 'Th·ªÉ d·ª•c bu·ªïi s√°ng, tr√≤ chuy·ªán ƒë·∫ßu ng√†y',
                'morning_3': 'Ho·∫°t ƒë·ªông ngo√†i tr·ªùi (HƒêNT)',
                'morning_4': 'English: Vocabulary + Structure',
                'morning_5': 'Ho·∫°t ƒë·ªông h·ªçc t·∫≠p ch√≠nh',
                'morning_6': 'V·ªá sinh, ƒÉn tr∆∞a, ng·ªß tr∆∞a',
                'afternoon_1': 'Ho·∫°t ƒë·ªông Lego/Gi√°o c·ª•',
                'afternoon_2': 'U·ªëng n∆∞·ªõc, v·∫≠n ƒë·ªông nh·∫π, ƒÉn x·∫ø',
                'afternoon_3': 'Yoga/Dance, ho·∫°t ƒë·ªông s√°ng t·∫°o',
                'afternoon_4': 'Tr·∫£ tr·∫ª, trao ƒë·ªïi v·ªõi ph·ª• huynh'
            }
            
            # Initialize with sample activities for all days
            days = ['mon', 'tue', 'wed', 'thu', 'fri']
            for day in days:
                for slot in morning_slots + afternoon_slots:
                    curriculum_data[day][slot] = sample_activities.get(slot, f"Ho·∫°t ƒë·ªông {slot}")
            
            # Parse the AI response
            lines = content.split('\n')
            current_day = None
            day_mapping = {
                'Th·ª© 2': 'mon', 'Th·ª© hai': 'mon', 'Monday': 'mon', 'TH·ª® 2': 'mon',
                'Th·ª© 3': 'tue', 'Th·ª© ba': 'tue', 'Tuesday': 'tue', 'TH·ª® 3': 'tue',
                'Th·ª© 4': 'wed', 'Th·ª© t∆∞': 'wed', 'Wednesday': 'wed', 'TH·ª® 4': 'wed',
                'Th·ª© 5': 'thu', 'Th·ª© nƒÉm': 'thu', 'Thursday': 'thu', 'TH·ª® 5': 'thu',
                'Th·ª© 6': 'fri', 'Th·ª© s√°u': 'fri', 'Friday': 'fri', 'TH·ª® 6': 'fri'
            }
            
            activity_count = 0
            
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                # Detect day headers (more flexible)
                day_detected = False
                for day_name, day_code in day_mapping.items():
                    if day_name in line or f"**{day_name}" in line:
                        current_day = day_code
                        day_detected = True
                        print(f"üîç [DEBUG] Detected day: {day_name} -> {day_code}")
                        break
                
                if day_detected:
                    continue
                
                # Try to parse activity lines with various formats
                if current_day and ':' in line:
                    # Handle direct slot mapping
                    for slot in morning_slots + afternoon_slots:
                        if line.startswith(f"{slot}:"):
                            content_text = line.replace(f"{slot}:", "").strip()
                            if content_text and len(content_text) > 5:
                                curriculum_data[current_day][slot] = content_text
                                activity_count += 1
                                print(f"‚úÖ [DEBUG] Mapped {current_day}.{slot}: {content_text[:50]}...")
                            break
                    
                    # Handle time-based mapping (Vietnamese format)
                    time_patterns = {
                        '7h-8h': 'morning_1', '7:00-8:00': 'morning_1',
                        '8h-8h30': 'morning_2', '8:00-8:30': 'morning_2',
                        '8h30-9h': 'morning_3', '8:30-9:00': 'morning_3',
                        '9h-9h30': 'morning_4', '9:00-9:30': 'morning_4',
                        '9h30-10h': 'morning_5', '9:30-10:00': 'morning_5',
                        '10h30-14h': 'morning_6', '10:30-14:00': 'morning_6',
                        '14h15-15h': 'afternoon_1', '14:15-15:00': 'afternoon_1',
                        '15h-15h30': 'afternoon_2', '15:00-15:30': 'afternoon_2',
                        '15h45-16h': 'afternoon_3', '15:45-16:00': 'afternoon_3',
                        '16h-17h': 'afternoon_4', '16:00-17:00': 'afternoon_4'
                    }
                    
                    for time_pattern, slot in time_patterns.items():
                        if time_pattern in line:
                            content_text = line.split(':', 1)[-1].strip()
                            if content_text and len(content_text) > 5:
                                curriculum_data[current_day][slot] = content_text
                                activity_count += 1
                                print(f"‚úÖ [DEBUG] Time-mapped {current_day}.{slot}: {content_text[:50]}...")
                            break
            
            print(f"üîç [DEBUG] Total activities parsed: {activity_count}")
            print(f"üîç [DEBUG] Sample curriculum_data: {curriculum_data['mon']}")
            
            # Convert to JSON format like the existing curriculum system
            curriculum_json = json.dumps(curriculum_data, ensure_ascii=False)
            
            # Return in the format expected by the curriculum system
            return {
                'success': True,
                'content': curriculum_json,
                'provider': provider,
                'data': curriculum_data,
                'message': f"‚úÖ Ch∆∞∆°ng tr√¨nh h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi {provider.upper()}"
            }
            
        except Exception as e:
            logger.error(f"‚ùå Error parsing curriculum response: {e}")
            print(f"‚ùå [DEBUG] Parse error: {e}")
            print(f"‚ùå [DEBUG] Content that failed: {content[:200]}...")
            return {
                'success': False,
                'error': f"L·ªói x·ª≠ l√Ω ch∆∞∆°ng tr√¨nh h·ªçc t·ª´ AI: {str(e)}",
                'provider': provider
            }
    
    def _fallback_curriculum(self, age_group, week_number):
        """Fallback to original Curriculum service with structured format"""
        try:
            from .curriculum_ai import CurriculumAIService
            import json
            
            service = CurriculumAIService()
            result = service.generate_curriculum_suggestions(age_group, week_number)
            
            if result and "error" not in result:
                # Convert old format to new structured format
                curriculum_data = self._convert_legacy_to_structured(result, week_number)
                
                return {
                    'success': True,
                    'content': json.dumps(curriculum_data, ensure_ascii=False),
                    'provider': 'gemini_fallback',
                    'data': curriculum_data,
                    'message': "‚úÖ Ch∆∞∆°ng tr√¨nh h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi GEMINI (Fallback)"
                }
            else:
                return {
                    'success': False,
                    'error': "Kh√¥ng th·ªÉ t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc t·ª´ AI",
                    'provider': 'fallback'
                }
                
        except Exception as e:
            logger.error(f"‚ùå Fallback curriculum failed: {e}")
            return {
                'success': False,
                'error': f"Kh√¥ng th·ªÉ t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc t·ª´ AI: {str(e)[:100]}",
                'provider': 'fallback'
            }
    
    def _convert_legacy_to_structured(self, legacy_result, week_number):
        """Convert legacy curriculum format to structured template format"""
        # Create empty structured data (5 days only)
        curriculum_data = {
            'mon': {}, 'tue': {}, 'wed': {}, 'thu': {}, 'fri': {}
        }
        
        morning_slots = ['morning_1', 'morning_2', 'morning_3', 'morning_4', 'morning_5', 'morning_6']
        afternoon_slots = ['afternoon_1', 'afternoon_2', 'afternoon_3', 'afternoon_4']
        
        # Initialize with realistic activities based on template
        default_activities = {
            'morning_1': 'ƒê√≥n tr·∫ª, STEAM (massage k√≠ch th√≠ch gi√°c quan), ƒÉn s√°ng',
            'morning_2': 'Th·ªÉ d·ª•c bu·ªïi s√°ng, tr√≤ chuy·ªán ƒë·∫ßu ng√†y, ki·ªÉm tra th√¢n th·ªÉ',
            'morning_3': 'HƒêNT (Ho·∫°t ƒë·ªông ngo√†i tr·ªùi)',
            'morning_4': f'English: Vocabulary + Structure - Tu·∫ßn {week_number}',
            'morning_5': f'Ho·∫°t ƒë·ªông h·ªçc t·∫≠p ch√≠nh - Tu·∫ßn {week_number}',
            'morning_6': 'V·ªá sinh ƒÉn tr∆∞a ‚Äì ng·ªß tr∆∞a',
            'afternoon_1': 'Ho·∫°t ƒë·ªông bu·ªïi chi·ªÅu (Lego time/Gi√°o c·ª•)',
            'afternoon_2': 'U·ªëng n∆∞·ªõc ‚Äì v·∫≠n ƒë·ªông nh·∫π ‚Äì ƒÉn chi·ªÅu',
            'afternoon_3': 'Yoga/Dance, ho·∫°t ƒë·ªông s√°ng t·∫°o',
            'afternoon_4': 'Tr·∫£ tr·∫ª ‚Äì Trao ƒë·ªïi v·ªõi ph·ª• huynh'
        }
        
        # Special activities for Wednesday (Th·ª© 4 vui v·∫ª)
        wed_activities = {
            'morning_4': 'English: Th·ª© 4 vui v·∫ª - Games and Fun Activities',
            'morning_5': 'Th·ª© 4 vui v·∫ª - Ho·∫°t ƒë·ªông ƒë·∫∑c bi·ªát',
            'afternoon_1': 'Th·ª© 4 vui v·∫ª - Ho·∫°t ƒë·ªông s√°ng t·∫°o ƒë·∫∑c bi·ªát'
        }
        
        # Fill with activities for all days (5 days only)
        days = ['mon', 'tue', 'wed', 'thu', 'fri']
        for day in days:
            for slot in morning_slots + afternoon_slots:
                if day == 'wed' and slot in wed_activities:
                    curriculum_data[day][slot] = wed_activities[slot]
                else:
                    curriculum_data[day][slot] = default_activities.get(slot, f"Ho·∫°t ƒë·ªông {slot}")
        
        # Try to extract content from legacy result if it's a list
        if isinstance(legacy_result, list) and legacy_result:
            content_text = " ".join(str(item) for item in legacy_result if str(item).strip())
            
            # Use the content as main learning activity for morning_5
            if content_text and len(content_text) > 10:
                for day in days:
                    if day != 'wed':  # Keep Wednesday special
                        curriculum_data[day]['morning_5'] = f"H·ªçc t·∫≠p: {content_text[:100]}..."
        
        return curriculum_data

# Global instance
enhanced_curriculum_ai = EnhancedCurriculumAI()

def get_ai_curriculum_suggestions_enhanced(age_group="2-3 tu·ªïi", week_number=1, use_multi_ai=True):
    """
    Enhanced curriculum generation v·ªõi multi-AI support
    Returns structured data for template compatibility
    """
    result = enhanced_curriculum_ai.generate_curriculum(
        age_group=age_group,
        week_number=week_number,
        use_multi_ai=use_multi_ai
    )
    
    # Return the structured result
    return result

# Backward compatibility - updated to work with new structure
def get_ai_curriculum_suggestions(age_group="2-3 tu·ªïi", week_number=1):
    """Original function v·ªõi enhanced fallback - returns structured data"""
    # Try enhanced version first
    try:
        result = get_ai_curriculum_suggestions_enhanced(
            age_group=age_group,
            week_number=week_number,
            use_multi_ai=True
        )
        
        # Return the structured result for template compatibility
        return result
        
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è Enhanced curriculum failed, using original: {e}")
        
        # Original fallback - but convert to structured format
        try:
            from .curriculum_ai import CurriculumAIService
            import json
            
            service = CurriculumAIService()
            legacy_result = service.generate_curriculum_suggestions(age_group, week_number)
            
            if legacy_result:
                # Convert legacy to structured format
                curriculum_data = enhanced_curriculum_ai._convert_legacy_to_structured(legacy_result, week_number)
                
                return {
                    'success': True,
                    'content': json.dumps(curriculum_data, ensure_ascii=False),
                    'provider': 'gemini_legacy',
                    'data': curriculum_data,
                    'message': "‚úÖ Ch∆∞∆°ng tr√¨nh h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o b·ªüi GEMINI (Legacy)"
                }
            else:
                return {
                    'success': False,
                    'error': "Kh√¥ng th·ªÉ t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc",
                    'provider': 'legacy_fallback'
                }
                
        except Exception as e:
            logger.error(f"‚ùå Original curriculum generation failed: {e}")
            return {
                'success': False,
                'error': f"L·ªói AI service: {str(e)[:100]}",
                'provider': 'error'
            }
