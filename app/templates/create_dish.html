{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-primary">Tạo món ăn mới</h2>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="name" class="form-label">Tên món ăn</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Mô tả</label>
            <textarea class="form-control" id="description" name="description" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label style="font-size: 0.9em;">Dùng cho bữa nào:</label>
            <div>
                {% set meal_labels = {'morning':'Sáng','snack':'Phụ sáng','dessert':'Tráng miệng','lunch':'Trưa','afternoon':'Xế','lateafternoon':'Xế chiều'} %}
                {% for meal in ['morning','snack','dessert','lunch','afternoon','lateafternoon'] %}
                    <span style="margin-right:6px;">
                        <input type="checkbox" name="meal_times" value="{{ meal }}">
                        <label style="margin-left:2px;">{{ meal_labels[meal] }}</label>
                    </span>
                {% endfor %}
            </div>
        </div>
        <h5>Nguyên liệu</h5>
        <div id="ingredients-list">
            <div class="row mb-2 ingredient-row">
                <div class="col-md-6">
                    <input type="text" class="form-control ingredient-search" placeholder="Tìm nguyên liệu..." autocomplete="off" list="ingredient-suggestions-0">
                    <input type="hidden" name="ingredient_id" class="ingredient-id-hidden" required>
                    <datalist id="ingredient-suggestions-0">
                        {% for p in products %}
                        <option value="{{ p.name }} ({{ p.unit }})" data-id="{{ p.id }}" data-unit="{{ p.unit }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" min="0" name="quantity" class="form-control" placeholder="Khối lượng" required>
                </div>
                <div class="col-md-3">
                    <select name="unit" class="form-select ingredient-unit" required>
                        <option value="">-- Đơn vị --</option>
                        {% for u in product_units %}
                        <option value="{{ u }}">{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-remove-ingredient">&times;</button>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-secondary mb-3" id="add-ingredient">+ Thêm nguyên liệu</button>
        <br>
        <button type="submit" class="btn btn-primary">Lưu món ăn</button>
        <a href="{{ url_for('main.dish_list') }}" class="btn btn-secondary">Hủy</a>
    </form>
</div>
<script>
    // Global products data for search
    var productsData = [
        {% for p in products %}
        {id: {{ p.id }}, name: "{{ p.name }}", unit: "{{ p.unit }}"}{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    var datalistCounter = 1;
    
    // Setup ingredient search with autocomplete
    function setupIngredientSearch(row) {
        var searchInput = row.querySelector('.ingredient-search');
        var hiddenInput = row.querySelector('.ingredient-id-hidden');
        var unitSelect = row.querySelector('select[name="unit"]');
        
        if (!searchInput || !hiddenInput || !unitSelect) return;
        
        // When user types, show suggestions
        searchInput.addEventListener('input', function(e) {
            var value = e.target.value.toLowerCase();
            hiddenInput.value = ''; // Clear hidden ID until valid selection
            
            // Find matching product
            var match = productsData.find(function(p) {
                return (p.name + ' (' + p.unit + ')').toLowerCase() === value.toLowerCase();
            });
            
            if (match) {
                hiddenInput.value = match.id;
                // Auto-select unit
                for (var i = 0; i < unitSelect.options.length; i++) {
                    if (unitSelect.options[i].value === match.unit) {
                        unitSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        });
        
        // When user selects from datalist
        searchInput.addEventListener('change', function(e) {
            var value = e.target.value.toLowerCase();
            var match = productsData.find(function(p) {
                return (p.name + ' (' + p.unit + ')').toLowerCase() === value.toLowerCase();
            });
            
            if (match) {
                hiddenInput.value = match.id;
                searchInput.value = match.name + ' (' + match.unit + ')';
                // Auto-select unit
                for (var i = 0; i < unitSelect.options.length; i++) {
                    if (unitSelect.options[i].value === match.unit) {
                        unitSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        });
    }
    
    // Setup all existing rows
    document.querySelectorAll('.ingredient-row').forEach(function(row) {
        setupIngredientSearch(row);
    });
    
    document.getElementById('add-ingredient').onclick = function() {
        var row = document.querySelector('.ingredient-row').cloneNode(true);
        row.querySelectorAll('input').forEach(function(el) { el.value = ''; });
        row.querySelectorAll('select').forEach(function(el) { el.selectedIndex = 0; });
        
        // Update datalist id for new row
        var datalist = row.querySelector('datalist');
        if (datalist) {
            datalist.id = 'ingredient-suggestions-' + datalistCounter;
            row.querySelector('.ingredient-search').setAttribute('list', datalist.id);
            datalistCounter++;
        }
        
        document.getElementById('ingredients-list').appendChild(row);
        setupIngredientSearch(row);
    };
    document.getElementById('ingredients-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-ingredient')) {
            var rows = document.querySelectorAll('.ingredient-row');
            if (rows.length > 1) e.target.closest('.ingredient-row').remove();
        }
    });
</script>
{% endblock %}
