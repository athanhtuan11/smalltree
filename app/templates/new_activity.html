{% extends 'base.html' %}
{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .quill-editor { min-height:180px; }
    @media (max-width: 576px) {
        .quill-editor { min-height:120px; }
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="mb-4 fw-bold" style="color:#43a047;">Đăng bài viết mới</h2>
    <form method="POST" enctype="multipart/form-data" id="activity-form">
        <!-- Temporarily bypass JavaScript for debugging -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="title" class="form-label">Tiêu đề <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="title" name="title" required placeholder="Nhập tiêu đề bài viết">
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Nội dung <span class="text-danger">*</span></label>
            <div id="quillEditor" class="quill-editor bg-white"></div>
            <input type="hidden" name="description" id="description">
        </div>
        <div class="mb-3">
            <label for="background" class="form-label">Chọn hình nền cho bài viết</label>
            <input type="file" class="form-control" id="background" name="background" accept="image/*">
            <div id="preview-bg" class="mt-3" style="display:none;">
                <img id="preview-img" src="#" alt="Preview" style="max-width:100%; border-radius:16px; filter: blur(4px) brightness(0.8);">
            </div>
        </div>
        <div class="mb-3">
            <label for="class_id" class="form-label">Đăng cho lớp</label>
            <select class="form-select" id="class_id" name="class_id">
                <option value="0">Tất cả khách vãng lai</option>
                {% for c in classes %}
                <option value="{{ c.id }}" {% if form.class_id.data == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="date" class="form-label">Ngày đăng <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="date" name="date" required value="{{ form.date.data if form and form.date.data else current_date_iso }}">
        </div>
        <div class="mb-3">
            <label for="images" class="form-label">Ảnh hoạt động (không giới hạn số lượng - tự động chia batch)</label>
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple onchange="showFileInfo()">
            
            <!-- Thông tin file -->
            <div id="file-info" class="mt-2" style="background: #e8f5e9; padding: 10px; border-radius: 5px; display: none;">
                <small>
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    <strong>Đã chọn:</strong> <span id="file-count">0</span> ảnh 
                    (<span id="total-size">0 MB</span>)
                    <br>
                    <i class="bi bi-info-circle-fill text-info me-1"></i>
                    Hệ thống sẽ tự động chia thành <span id="batch-count">1</span> lần upload
                </small>
            </div>
            
            <!-- Progress bar upload batch -->
            <div id="batch-progress" class="mt-2" style="display:none;">
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                         role="progressbar" style="width: 0%" id="batch-bar">
                        <span id="batch-text">0%</span>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="bi bi-cloud-upload-fill me-1"></i>
                    Đang upload batch <span id="current-batch">0</span>/<span id="total-batch">0</span> 
                    - <span id="uploaded-count">0</span>/<span id="total-files">0</span> ảnh
                </small>
            </div>
        </div>
        <button type="button" class="btn btn-success" id="submit-btn" onclick="handleSubmit(event)">
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            <span id="btn-text">Đăng bài</span>
        </button>
        <a href="/activities" class="btn btn-outline-secondary ms-2">Quay lại</a>
    </form>
</div>
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
var quill = new Quill('#quillEditor', {
    theme: 'snow',
    placeholder: 'Nhập nội dung bài viết...',
    modules: {
        toolbar: [
            [{ header: [1, 2, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ list: 'ordered'}, { list: 'bullet' }],
            ['link', 'image'],
            ['clean']
        ]
    }
});

// Hiển thị thông tin file đã chọn
function showFileInfo() {
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    const fileInfo = document.getElementById('file-info');
    
    if (files.length === 0) {
        fileInfo.style.display = 'none';
        return;
    }
    
    // Tính tổng dung lượng
    const totalBytes = files.reduce((sum, file) => sum + file.size, 0);
    const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);
    
    // Tính số batch (mỗi batch 20 ảnh hoặc 30MB)
    const BATCH_SIZE = 20;
    const MAX_BATCH_MB = 30;
    const batchCount = Math.ceil(files.length / BATCH_SIZE);
    
    // Hiển thị thông tin
    document.getElementById('file-count').textContent = files.length;
    document.getElementById('total-size').textContent = totalMB;
    document.getElementById('batch-count').textContent = batchCount;
    fileInfo.style.display = 'block';
    
    console.log(`Đã chọn ${files.length} ảnh (${totalMB}MB), sẽ chia thành ${batchCount} batch`);
}

// Xử lý submit với batch upload
async function handleSubmit(event) {
    if (event) event.preventDefault();
    
    // Lấy nội dung Quill
    document.getElementById('description').value = quill.root.innerHTML;
    
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const spinner = submitBtn.querySelector('.spinner-border');
    
    // Validate form
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    
    if (!title || !description) {
        alert('Vui lòng nhập đầy đủ tiêu đề và nội dung!');
        return;
    }
    
    // Disable button
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        // Bước 1: Tạo activity (không có ảnh)
        btnText.textContent = 'Đang tạo bài viết...';
        const activityId = await createActivity();
        
        if (!activityId) {
            throw new Error('Không thể tạo bài viết');
        }
        
        // Bước 2: Upload ảnh theo batch (nếu có)
        if (files.length > 0) {
            btnText.textContent = `Đang upload ${files.length} ảnh...`;
            await uploadImagesBatch(activityId, files);
        }
        
        // Thành công
        alert(`Đã đăng bài viết thành công${files.length > 0 ? ` với ${files.length} ảnh` : ''}!`);
        window.location.href = '/activities';
        
    } catch (error) {
        console.error('Lỗi:', error);
        alert('Có lỗi xảy ra: ' + error.message);
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
        btnText.textContent = 'Đăng bài';
    }
}

// Tạo activity (KHÔNG upload ảnh - chỉ metadata)
async function createActivity() {
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('[name="csrf_token"]').value);
    formData.append('title', document.getElementById('title').value.trim());
    formData.append('description', document.getElementById('description').value.trim());
    formData.append('date', document.getElementById('date').value);
    formData.append('class_id', document.getElementById('class_id').value);
    
    // Background image (nếu có)
    const bgFile = document.getElementById('background').files[0];
    if (bgFile) {
        formData.append('background', bgFile);
    }
    
    // KHÔNG gửi images field - sẽ upload riêng sau
    
    console.log('[DEBUG] Creating activity with data:', {
        title: formData.get('title'),
        description: formData.get('description'),
        date: formData.get('date'),
        class_id: formData.get('class_id'),
        has_background: !!bgFile
    });
    
    const response = await fetch('/activities/new?api=1', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Tạo bài viết thất bại');
    }
    
    const result = await response.json();
    console.log('[DEBUG] Create activity result:', result);
    
    if (!result.success || !result.activity_id) {
        throw new Error('Không nhận được activity_id từ server');
    }
    return result.activity_id;
}

// Upload ảnh theo batch
async function uploadImagesBatch(activityId, files) {
    const BATCH_SIZE = 20; // 20 ảnh mỗi batch
    const totalBatches = Math.ceil(files.length / BATCH_SIZE);
    
    const batchProgress = document.getElementById('batch-progress');
    const batchBar = document.getElementById('batch-bar');
    const batchText = document.getElementById('batch-text');
    const currentBatchEl = document.getElementById('current-batch');
    const totalBatchEl = document.getElementById('total-batch');
    const uploadedCountEl = document.getElementById('uploaded-count');
    const totalFilesEl = document.getElementById('total-files');
    
    batchProgress.style.display = 'block';
    totalBatchEl.textContent = totalBatches;
    totalFilesEl.textContent = files.length;
    
    let uploadedCount = 0;
    
    for (let i = 0; i < totalBatches; i++) {
        const start = i * BATCH_SIZE;
        const end = Math.min(start + BATCH_SIZE, files.length);
        const batch = files.slice(start, end);
        
        currentBatchEl.textContent = i + 1;
        
        // Upload batch này
        const formData = new FormData();
        formData.append('csrf_token', document.querySelector('[name="csrf_token"]').value);
        formData.append('activity_id', activityId);
        
        batch.forEach(file => {
            formData.append('images', file);
        });
        
        const response = await fetch('/upload_activity_images', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Upload batch ${i + 1} thất bại`);
        }
        
        uploadedCount += batch.length;
        uploadedCountEl.textContent = uploadedCount;
        
        // Update progress bar
        const percent = ((i + 1) / totalBatches) * 100;
        batchBar.style.width = percent + '%';
        batchText.textContent = Math.round(percent) + '%';
        
        // Delay ngắn giữa các batch
        if (i < totalBatches - 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
}

// Debug function (giữ lại cho tương thích)
function debugFiles() {
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    const debugInfo = document.getElementById('debug-info');
    const debugText = document.getElementById('debug-text');
    
    debugInfo.style.display = 'block';
    
    if (files.length === 0) {
        debugText.innerHTML = 'Chưa chọn file nào';
    } else {
        let info = `Đã chọn ${files.length} file(s):<br>`;
        files.forEach((file, index) => {
            info += `${index + 1}. ${file.name} (${(file.size / 1024).toFixed(1)}KB, ${file.type})<br>`;
        });
        debugText.innerHTML = info;
    }
    
    console.log('File selection changed:', files);
}

function submitQuillContent() {
    document.getElementById('description').value = quill.root.innerHTML;
    
    // Kiểm tra nếu có ảnh được chọn
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    
    // Debug: In ra thông tin chi tiết
    console.log('=== CLIENT-SIDE DEBUG ===');
    console.log('Số ảnh được chọn:', files.length);
    console.log('Chi tiết files:', files);
    console.log('FileInput element:', fileInput);
    console.log('FileInput value:', fileInput.value);
    console.log('FileInput files property:', fileInput.files);
    
    // Kiểm tra form data sẽ được gửi
    const formData = new FormData(document.getElementById('activity-form'));
    console.log('FormData entries:');
    for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
            console.log(key + ':', value.name, '(' + value.size + ' bytes)');
        } else {
            console.log(key + ':', value);
        }
    }
    
    // Kiểm tra từng file
    files.forEach((file, index) => {
        console.log(`File ${index + 1}:`, {
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
        });
    });
    
    // Alert để dễ thấy
    if (files.length > 0) {
        alert(`DEBUG: Đã chọn ${files.length} file(s). Check console for details.`);
    } else {
        alert('DEBUG: Không có file nào được chọn!');
    }
    
    // Đơn giản hóa: LUÔN dùng traditional upload để test
    console.log('Sử dụng traditional upload để test');
    return true; // Submit form bình thường
}

// Hàm nén ảnh client-side - Tối ưu cho 60-70 ảnh
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.6) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // Tính toán kích thước mới giữ tỷ lệ
            let { width, height } = img;
            if (width > height) {
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Vẽ và nén ảnh
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        
        img.src = URL.createObjectURL(file);
    });
}

// Nén và upload batch
async function compressAndUploadImages(files) {
    const submitBtn = document.getElementById('submit-btn');
    const compressProgress = document.getElementById('compress-progress');
    const compressBar = document.getElementById('compress-bar');
    const compressText = document.getElementById('compress-text');
    const uploadProgress = document.getElementById('upload-progress');
    
    submitBtn.querySelector('.spinner-border').classList.remove('d-none');
    submitBtn.disabled = true;
    compressProgress.style.display = 'block';
    
    const compressedFiles = [];
    
    // Bước 1: Nén tất cả ảnh
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            const compressed = await compressImage(file);
            compressedFiles.push({
                file: compressed,
                name: file.name.replace(/\.[^/.]+$/, '.jpg') // Đổi extension thành .jpg
            });
        }
        
        const percent = ((i + 1) / files.length) * 100;
        compressBar.style.width = percent + '%';
        compressText.textContent = `${i + 1}/${files.length}`;
    }
    
    // Bước 2: Upload từng batch nhỏ (3 ảnh/lần để tránh timeout với 60-70 ảnh)
    compressProgress.style.display = 'none';
    uploadProgress.style.display = 'block';
    
    const batchSize = 3;  // Giảm từ 5 xuống 3 cho ổn định
    let uploaded = 0;
    
    for (let i = 0; i < compressedFiles.length; i += batchSize) {
        const batch = compressedFiles.slice(i, i + batchSize);
        try {
            const result = await uploadBatch(batch);
            uploaded += result.uploaded || batch.length;
        } catch (error) {
            console.error(`Batch ${Math.floor(i/batchSize) + 1} failed:`, error);
            // Tiếp tục với batch tiếp theo thay vì dừng hoàn toàn
        }
        
        const percent = (uploaded / compressedFiles.length) * 100;
        uploadProgress.querySelector('.progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent = `${uploaded}/${compressedFiles.length}`;
        
        // Thêm delay nhỏ giữa các batch để giảm tải server
        if (i + batchSize < compressedFiles.length) {
            await new Promise(resolve => setTimeout(resolve, 500)); // 0.5s delay
        }
    }
    
    // Submit form cuối cùng không có ảnh (đã upload riêng)
    const form = document.getElementById('activity-form');
    const imageInput = document.getElementById('images');
    imageInput.remove(); // Xóa input file để không upload lại
    form.submit();
}

// Upload 1 batch ảnh với retry logic
async function uploadBatch(compressedFiles, retryCount = 0) {
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
    
    const activityId = window.currentActivityId; // Sẽ được set từ server
    if (!activityId) {
        console.error('No activity ID found');
        throw new Error('No activity ID');
    }
    
    compressedFiles.forEach((item, index) => {
        formData.append('batch_images', item.file, item.name);
    });
    formData.append('activity_id', activityId);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout
        
        const response = await fetch('/activities/upload-batch', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Batch uploaded successfully:', result);
        return result;
    } catch (error) {
        console.error('Upload batch error:', error);
        
        // Retry logic cho network errors (tối đa 2 lần)
        if (retryCount < 2 && (error.name === 'AbortError' || error.message.includes('fetch'))) {
            console.log(`Retrying batch upload (attempt ${retryCount + 1}/2)...`);
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s
            return uploadBatch(compressedFiles, retryCount + 1);
        }
        
        throw error;
    }
}

// Set activity ID từ server (nếu có temp_activity_id trong session)
{% if session.get('temp_activity_id') %}
window.currentActivityId = {{ session.get('temp_activity_id') }};
console.log('Activity ID loaded:', window.currentActivityId);
{% endif %}
</script>
{% endblock %}
