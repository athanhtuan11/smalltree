{% extends 'base.html' %}
{% block content %}            <div class="form-text text-success">
                <strong>üöÄ T·ª± ƒë·ªông t·ªëi ∆∞u h√≥a ·∫£nh:</strong>
                <ul class="mb-1 mt-1">
                    <li>‚úÖ Ch·∫•p nh·∫≠n m·ªçi k√≠ch th∆∞·ªõc - t·ª± ƒë·ªông resize v·ªÅ 1200x900px</li>
                    <li>‚úÖ Ch·∫•p nh·∫≠n m·ªçi ƒë·ªãnh d·∫°ng ·∫£nh - t·ª± ƒë·ªông chuy·ªÉn v·ªÅ JPEG</li> 
                    <li>‚úÖ T·ª± ƒë·ªông n√©n ƒë·ªÉ gi·∫£m dung l∆∞·ª£ng xu·ªëng ~200-500KB/·∫£nh</li>
                    <li>‚úÖ Kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng - upload tho·∫£i m√°i!</li>
                    <li>üéØ <strong>Kh√¥ng bao gi·ªù b√°o l·ªói</strong> - h·ªá th·ªëng s·∫Ω t·ª± s·ª≠a t·∫•t c·∫£</li>
                </ul>
            </div>ll CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .quill-editor { min-height:180px; }
    @media (max-width: 576px) {
        .quill-editor { min-height:120px; }
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="mb-4 fw-bold" style="color:#43a047;">ƒêƒÉng b√†i vi·∫øt m·ªõi</h2>
    <form method="POST" enctype="multipart/form-data" id="activity-form">
        <!-- Temporarily bypass JavaScript for debugging -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="title" class="form-label">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="title" name="title" required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt">
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">N·ªôi dung <span class="text-danger">*</span></label>
            <div id="quillEditor" class="quill-editor bg-white"></div>
            <input type="hidden" name="description" id="description">
        </div>
        <div class="mb-3">
            <label for="background" class="form-label">Ch·ªçn h√¨nh n·ªÅn cho b√†i vi·∫øt</label>
            <input type="file" class="form-control" id="background" name="background" accept="image/*">
            <div id="preview-bg" class="mt-3" style="display:none;">
                <img id="preview-img" src="#" alt="Preview" style="max-width:100%; border-radius:16px; filter: blur(4px) brightness(0.8);">
            </div>
        </div>
        <div class="mb-3">
            <label for="class_id" class="form-label">ƒêƒÉng cho l·ªõp</label>
            <select class="form-select" id="class_id" name="class_id">
                <option value="0">T·∫•t c·∫£ kh√°ch v√£ng lai</option>
                {% for c in classes %}
                <option value="{{ c.id }}" {% if form.class_id.data == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="date" class="form-label">Ng√†y ƒëƒÉng <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="date" name="date" required value="{{ form.date.data if form and form.date.data else current_date_iso }}">
        </div>
        <div class="mb-3">
            <label for="images" class="form-label">·∫¢nh ho·∫°t ƒë·ªông (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple onchange="debugFiles()">
            <div class="form-text text-success">
                <strong>ÔøΩ ƒê√£ t·ªëi ∆∞u h√≥a upload:</strong>
                <ul class="mb-1 mt-1">
                    <li>T·ªëi ƒëa 50MB cho t·∫•t c·∫£ ·∫£nh (kho·∫£ng 50-100 ·∫£nh)</li>
                    <li>M·ªói ·∫£nh t·ªëi ƒëa 10MB, s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông n√©n v·ªÅ 1200x900px</li>
                    <li>ƒê·ªãnh d·∫°ng h·ªó tr·ª£: JPG, PNG, GIF, JFIF</li>
                    <li>X·ª≠ l√Ω t·ª´ng ·∫£nh m·ªôt ƒë·ªÉ tr√°nh l·ªói 413</li>
                </ul>
            </div>
            <!-- Debug info ƒë·ªÉ test -->
            <div id="debug-info" class="mt-2" style="background: #f8f9fa; padding: 10px; border-radius: 5px; display: none;">
                <small><strong>Debug:</strong> <span id="debug-text">Ch∆∞a ch·ªçn file n√†o</span></small>
            </div>
            <div id="compress-progress" class="mt-2" style="display:none;">
                <div class="progress mb-2">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="compress-bar"></div>
                </div>
                <small class="text-muted">ƒêang n√©n ·∫£nh: <span id="compress-text">0/0</span></small>
            </div>
            <div id="upload-progress" class="mt-2" style="display:none;">
                <div class="progress">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted mt-1 d-block">ƒêang upload: <span id="progress-text">0/0</span></small>
            </div>
        </div>
        <button type="submit" class="btn btn-success" id="submit-btn" onclick="document.getElementById('description').value = quill.root.innerHTML;">
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            ƒêƒÉng b√†i
        </button>
        <a href="/activities" class="btn btn-outline-secondary ms-2">Quay l·∫°i</a>
    </form>
</div>
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
var quill = new Quill('#quillEditor', {
    theme: 'snow',
    placeholder: 'Nh·∫≠p n·ªôi dung b√†i vi·∫øt...',
    modules: {
        toolbar: [
            [{ header: [1, 2, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ list: 'ordered'}, { list: 'bullet' }],
            ['link', 'image'],
            ['clean']
        ]
    }
});
// Debug function ƒë·ªÉ test file selection
function debugFiles() {
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    const debugInfo = document.getElementById('debug-info');
    const debugText = document.getElementById('debug-text');
    
    debugInfo.style.display = 'block';
    
    if (files.length === 0) {
        debugText.innerHTML = 'Ch∆∞a ch·ªçn file n√†o';
    } else {
        let info = `ƒê√£ ch·ªçn ${files.length} file(s):<br>`;
        files.forEach((file, index) => {
            info += `${index + 1}. ${file.name} (${(file.size / 1024).toFixed(1)}KB, ${file.type})<br>`;
        });
        debugText.innerHTML = info;
    }
    
    console.log('File selection changed:', files);
}

function submitQuillContent() {
    document.getElementById('description').value = quill.root.innerHTML;
    
    // Ki·ªÉm tra n·∫øu c√≥ ·∫£nh ƒë∆∞·ª£c ch·ªçn
    const fileInput = document.getElementById('images');
    const files = Array.from(fileInput.files);
    
    // Debug: In ra th√¥ng tin chi ti·∫øt
    console.log('=== CLIENT-SIDE DEBUG ===');
    console.log('S·ªë ·∫£nh ƒë∆∞·ª£c ch·ªçn:', files.length);
    console.log('Chi ti·∫øt files:', files);
    console.log('FileInput element:', fileInput);
    console.log('FileInput value:', fileInput.value);
    console.log('FileInput files property:', fileInput.files);
    
    // Ki·ªÉm tra form data s·∫Ω ƒë∆∞·ª£c g·ª≠i
    const formData = new FormData(document.getElementById('activity-form'));
    console.log('FormData entries:');
    for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
            console.log(key + ':', value.name, '(' + value.size + ' bytes)');
        } else {
            console.log(key + ':', value);
        }
    }
    
    // Ki·ªÉm tra t·ª´ng file
    files.forEach((file, index) => {
        console.log(`File ${index + 1}:`, {
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
        });
    });
    
    // Alert ƒë·ªÉ d·ªÖ th·∫•y
    if (files.length > 0) {
        alert(`DEBUG: ƒê√£ ch·ªçn ${files.length} file(s). Check console for details.`);
    } else {
        alert('DEBUG: Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn!');
    }
    
    // ƒê∆°n gi·∫£n h√≥a: LU√îN d√πng traditional upload ƒë·ªÉ test
    console.log('S·ª≠ d·ª•ng traditional upload ƒë·ªÉ test');
    return true; // Submit form b√¨nh th∆∞·ªùng
}

// H√†m n√©n ·∫£nh client-side - T·ªëi ∆∞u cho 60-70 ·∫£nh
function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.6) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // T√≠nh to√°n k√≠ch th∆∞·ªõc m·ªõi gi·ªØ t·ª∑ l·ªá
            let { width, height } = img;
            if (width > height) {
                if (width > maxWidth) {
                    height = height * (maxWidth / width);
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = width * (maxHeight / height);
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // V·∫Ω v√† n√©n ·∫£nh
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        
        img.src = URL.createObjectURL(file);
    });
}

// N√©n v√† upload batch
async function compressAndUploadImages(files) {
    const submitBtn = document.getElementById('submit-btn');
    const compressProgress = document.getElementById('compress-progress');
    const compressBar = document.getElementById('compress-bar');
    const compressText = document.getElementById('compress-text');
    const uploadProgress = document.getElementById('upload-progress');
    
    submitBtn.querySelector('.spinner-border').classList.remove('d-none');
    submitBtn.disabled = true;
    compressProgress.style.display = 'block';
    
    const compressedFiles = [];
    
    // B∆∞·ªõc 1: N√©n t·∫•t c·∫£ ·∫£nh
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            const compressed = await compressImage(file);
            compressedFiles.push({
                file: compressed,
                name: file.name.replace(/\.[^/.]+$/, '.jpg') // ƒê·ªïi extension th√†nh .jpg
            });
        }
        
        const percent = ((i + 1) / files.length) * 100;
        compressBar.style.width = percent + '%';
        compressText.textContent = `${i + 1}/${files.length}`;
    }
    
    // B∆∞·ªõc 2: Upload t·ª´ng batch nh·ªè (3 ·∫£nh/l·∫ßn ƒë·ªÉ tr√°nh timeout v·ªõi 60-70 ·∫£nh)
    compressProgress.style.display = 'none';
    uploadProgress.style.display = 'block';
    
    const batchSize = 3;  // Gi·∫£m t·ª´ 5 xu·ªëng 3 cho ·ªïn ƒë·ªãnh
    let uploaded = 0;
    
    for (let i = 0; i < compressedFiles.length; i += batchSize) {
        const batch = compressedFiles.slice(i, i + batchSize);
        try {
            const result = await uploadBatch(batch);
            uploaded += result.uploaded || batch.length;
        } catch (error) {
            console.error(`Batch ${Math.floor(i/batchSize) + 1} failed:`, error);
            // Ti·∫øp t·ª•c v·ªõi batch ti·∫øp theo thay v√¨ d·ª´ng ho√†n to√†n
        }
        
        const percent = (uploaded / compressedFiles.length) * 100;
        uploadProgress.querySelector('.progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent = `${uploaded}/${compressedFiles.length}`;
        
        // Th√™m delay nh·ªè gi·ªØa c√°c batch ƒë·ªÉ gi·∫£m t·∫£i server
        if (i + batchSize < compressedFiles.length) {
            await new Promise(resolve => setTimeout(resolve, 500)); // 0.5s delay
        }
    }
    
    // Submit form cu·ªëi c√πng kh√¥ng c√≥ ·∫£nh (ƒë√£ upload ri√™ng)
    const form = document.getElementById('activity-form');
    const imageInput = document.getElementById('images');
    imageInput.remove(); // X√≥a input file ƒë·ªÉ kh√¥ng upload l·∫°i
    form.submit();
}

// Upload 1 batch ·∫£nh v·ªõi retry logic
async function uploadBatch(compressedFiles, retryCount = 0) {
    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
    
    const activityId = window.currentActivityId; // S·∫Ω ƒë∆∞·ª£c set t·ª´ server
    if (!activityId) {
        console.error('No activity ID found');
        throw new Error('No activity ID');
    }
    
    compressedFiles.forEach((item, index) => {
        formData.append('batch_images', item.file, item.name);
    });
    formData.append('activity_id', activityId);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout
        
        const response = await fetch('/activities/upload-batch', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Batch uploaded successfully:', result);
        return result;
    } catch (error) {
        console.error('Upload batch error:', error);
        
        // Retry logic cho network errors (t·ªëi ƒëa 2 l·∫ßn)
        if (retryCount < 2 && (error.name === 'AbortError' || error.message.includes('fetch'))) {
            console.log(`Retrying batch upload (attempt ${retryCount + 1}/2)...`);
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s
            return uploadBatch(compressedFiles, retryCount + 1);
        }
        
        throw error;
    }
}

// Set activity ID t·ª´ server (n·∫øu c√≥ temp_activity_id trong session)
{% if session.get('temp_activity_id') %}
window.currentActivityId = {{ session.get('temp_activity_id') }};
console.log('Activity ID loaded:', window.currentActivityId);
{% endif %}
</script>
{% endblock %}
