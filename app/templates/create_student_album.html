{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success">
            <i class="fas fa-plus"></i> T·∫°o Album M·ªõi cho {{ student.name }}
        </h2>
        <a href="{{ url_for('main.student_albums_detail', student_id=student.id) }}" 
           class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-graduate"></i> {{ student.name }} 
                        <small>({{ student.student_code or 'N/A' }} - {{ student.class_name or 'Ch∆∞a ph√¢n l·ªõp' }})</small>
                    </h5>
                </div>
                
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="albumForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Basic Info -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">
                                    <i class="fas fa-heading"></i> Ti√™u ƒë·ªÅ album <span class="text-danger">*</span>
                                </label>
                                <input type="text" name="title" class="form-control" required
                                       placeholder="VD: Ng√†y ƒë·∫ßu ti√™n ƒëi h·ªçc, Sinh nh·∫≠t l·∫ßn th·ª© 3...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-star"></i> Lo·∫°i m·ªëc ph√°t tri·ªÉn
                                </label>
                                <select name="milestone_type" class="form-select">
                                    <option value="academic">üéì H·ªçc t·∫≠p</option>
                                    <option value="social">üë• X√£ h·ªôi</option>
                                    <option value="physical">üèÉ V·∫≠n ƒë·ªông</option>
                                    <option value="creative">üé® S√°ng t·∫°o</option>
                                    <option value="other" selected>‚≠ê Kh√°c</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-align-left"></i> M√¥ t·∫£
                            </label>
                            <textarea name="description" class="form-control" rows="3"
                                      placeholder="M√¥ t·∫£ v·ªÅ s·ª± ki·ªán, ho·∫°t ƒë·ªông ho·∫∑c m·ªëc ph√°t tri·ªÉn n√†y..."></textarea>
                        </div>

                        <!-- Timeline Info -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-calendar-alt"></i> NƒÉm h·ªçc
                                </label>
                                <input type="text" name="school_year" class="form-control" 
                                       placeholder="VD: 2024-2025" value="2024-2025">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-calendar"></i> H·ªçc k·ª≥
                                </label>
                                <select name="semester" class="form-select">
                                    <option value="">Ch·ªçn h·ªçc k·ª≥</option>
                                    <option value="HK1">H·ªçc k·ª≥ 1</option>
                                    <option value="HK2">H·ªçc k·ª≥ 2</option>
                                    <option value="H√®">H√®</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-child"></i> ƒê·ªô tu·ªïi khi ch·ª•p
                                </label>
                                <input type="text" name="age_at_time" class="form-control" 
                                       placeholder="VD: 3 tu·ªïi 2 th√°ng">
                            </div>
                        </div>

                        <!-- Photo Upload -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-images"></i> ·∫¢nh cho album
                            </label>
                            <div class="border rounded p-3 bg-light">
                                <input type="file" name="photos" class="form-control mb-3" 
                                       multiple accept="image/*" id="photoInput">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    C√≥ th·ªÉ ch·ªçn nhi·ªÅu ·∫£nh c√πng l√∫c. ƒê·ªãnh d·∫°ng: JPG, PNG, GIF. T·ªëi ƒëa 10MB m·ªói ·∫£nh.
                                </small>
                                
                                <!-- Preview Container -->
                                <div id="photoPreview" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save"></i> T·∫°o Album
                            </button>
                            <a href="{{ url_for('main.student_albums_detail', student_id=student.id) }}" 
                               class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> H·ªßy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.photo-preview-item {
    position: relative;
    display: inline-block;
    margin: 5px;
    border: 2px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}

.photo-preview-img {
    width: 120px;
    height: 120px;
    object-fit: cover;
}

.photo-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    font-size: 12px;
    cursor: pointer;
}

.photo-caption-input {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    padding: 5px;
    font-size: 11px;
}

.photo-caption-input::placeholder {
    color: #ccc;
}

@media (max-width: 768px) {
    .photo-preview-img {
        width: 80px;
        height: 80px;
    }
    
    .card-body {
        padding: 1rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    let selectedFiles = [];

    photoInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        files.forEach((file, index) => {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert(`File "${file.name}" kh√¥ng ph·∫£i l√† ·∫£nh!`);
                return;
            }
            
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert(`File "${file.name}" qu√° l·ªõn! T·ªëi ƒëa 10MB.`);
                return;
            }
            
            selectedFiles.push(file);
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'photo-preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="photo-preview-img" alt="Preview">
                    <button type="button" class="photo-remove-btn" onclick="removePhoto(${selectedFiles.length - 1})">
                        <i class="fas fa-times"></i>
                    </button>
                    <input type="text" class="photo-caption-input" placeholder="Ch√∫ th√≠ch ·∫£nh..." 
                           name="caption_${selectedFiles.length - 1}">
                `;
                
                photoPreview.appendChild(previewItem);
                
                // Add first image indicator
                if (selectedFiles.length === 1) {
                    const firstLabel = document.createElement('small');
                    firstLabel.className = 'text-success d-block mt-2';
                    firstLabel.innerHTML = '<i class="fas fa-star"></i> ·∫¢nh ƒë·∫ßu ti√™n s·∫Ω l√†m ·∫£nh ƒë·∫°i di·ªán album';
                    photoPreview.appendChild(firstLabel);
                }
            };
            
            reader.readAsDataURL(file);
        });
        
        // Update file input
        updateFileInput();
    });

    window.removePhoto = function(index) {
        selectedFiles.splice(index, 1);
        photoPreview.innerHTML = '';
        
        // Rebuild preview
        selectedFiles.forEach((file, newIndex) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'photo-preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" class="photo-preview-img" alt="Preview">
                    <button type="button" class="photo-remove-btn" onclick="removePhoto(${newIndex})">
                        <i class="fas fa-times"></i>
                    </button>
                    <input type="text" class="photo-caption-input" placeholder="Ch√∫ th√≠ch ·∫£nh..." 
                           name="caption_${newIndex}">
                `;
                
                photoPreview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
        
        updateFileInput();
    };

    function updateFileInput() {
        // Create new FileList
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        photoInput.files = dt.files;
    }
    
    // Form validation
    document.getElementById('albumForm').addEventListener('submit', function(e) {
        const title = document.querySelector('input[name="title"]').value.trim();
        
        if (!title) {
            e.preventDefault();
            alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ album!');
            return;
        }
        
        if (selectedFiles.length === 0) {
            if (!confirm('B·∫°n ch∆∞a ch·ªçn ·∫£nh n√†o. C√≥ mu·ªën t·∫°o album tr·ªëng kh√¥ng?')) {
                e.preventDefault();
                return;
            }
        }
        
        // Show loading
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o album...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}
