{% extends 'base.html' %}
{% block content %}
<style>
    .invoice-table-mobile { font-size:0.75em; }
    .invoice-table-desktop { font-size:1em; }
    .invoice-btn-mobile { width:100%; margin-bottom:8px; font-size:0.95em; }
    .invoice-btn-group-mobile { display:flex; flex-direction:column; gap:8px; }
    .invoice-table-mobile td, .invoice-table-mobile th { padding:0.15em 0.06em; }
    .invoice-table-wrapper { border:1.5px solid #c8e6c9; border-radius:0; box-shadow:none; background:#fff; margin-left:-12px; margin-right:-12px; }
    
    /* Checkbox styling */
    .form-check-input { margin: 0 auto; display: block; }
    
    /* Mobile specific adjustments for more columns */
    @media (max-width: 768px) {
        .invoice-table-mobile { font-size:0.7em; }
        .invoice-table-mobile td, .invoice-table-mobile th { padding:0.1em 0.04em; }
        .invoice-table-wrapper { margin-left:-16px; margin-right:-16px; border-radius:0; }
    }
    
    @media (max-width: 576px) {
        .invoice-table-mobile { font-size:0.65em; }
        .invoice-table-wrapper { margin-left:-20px; margin-right:-20px; }
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <div class="d-flex flex-column flex-md-row gap-2 mb-3 invoice-btn-group-mobile">
        <a href="{{ url_for('main.attendance_history', month=selected_month) }}" class="btn btn-secondary fw-bold {% if mobile %}invoice-btn-mobile{% endif %}">Quay l·∫°i l·ªãch s·ª≠ ƒëi·ªÉm danh</a>
    </div>
    <h2 class="fw-bold text-center mb-3" style="color:#43a047; font-size:1.1em;">H√≥a ƒë∆°n thanh to√°n th√°ng {{ selected_month }}</h2>
    
    <!-- Quick control buttons -->
    <div class="row mb-2">
        <div class="col-md-6">
            <button type="button" class="btn btn-sm btn-outline-success" onclick="toggleAllEnglish()">Toggle Anh vƒÉn t·∫•t c·∫£</button>
            <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="toggleAllSteamax()">Toggle STEAMAX t·∫•t c·∫£</button>
        </div>
    </div>
    
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="table-responsive invoice-table-wrapper">
            <table class="table table-bordered align-middle {% if mobile %}invoice-table-mobile{% else %}invoice-table-desktop{% endif %}">
                <thead class="table-success">
                    <tr>
                        <th></th>
                        <th>H·ªç v√† t√™n</th>
                        <th>Ng√†y sinh</th>
                        <th>S·ªë ng√†y c√≥ m·∫∑t</th>
                        <th>S·ªë ng√†y v·∫Øng kh√¥ng ph√©p</th>
                        <th>S·ªë ng√†y v·∫Øng c√≥ ph√©p</th>
                        <th>H·ªçc ti·∫øng anh</th>
                        <th>STEAMAX</th>
                        <th>Ti·ªÅn h·ªçc ph√≠</th>
                        <th>T·ªïng ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td><input type="checkbox" name="student_ids" value="{{ student.id }}" checked></td>
                        <td>{{ student.name }}</td>
                        <td>{% if student.birth_date %}{{ student.birth_date | datetimeformat('d/m/Y') }}{% else %}-{% endif %}</td>
                        <td>{{ attendance_days[student.id] }}</td>
                        <td>{{ absent_unexcused_days[student.id] }}</td>
                        <td>{{ absent_excused_days[student.id] }}</td>
                        <td>
                            <input type="checkbox" name="english_{{ student.id }}" value="1" 
                                   {% if services_dict.get(student.id) and services_dict[student.id].has_english %}checked{% endif %}
                                   class="form-check-input english-checkbox" 
                                   data-student-id="{{ student.id }}">
                        </td>
                        <td>
                            <input type="checkbox" name="steamax_{{ student.id }}" value="1" 
                                   {% if services_dict.get(student.id) and services_dict[student.id].has_steamax %}checked{% endif %}
                                   class="form-check-input steamax-checkbox" 
                                   data-student-id="{{ student.id }}">
                        </td>
                        <td>
                            {% set age = student_ages[student.id] %}
                            {% if age == 0 %}1,850,000ƒë
                            {% elif age == 1 %}1,850,000ƒë
                            {% elif age == 2 %}1,750,000ƒë
                            {% elif age == 3 %}1,650,000ƒë
                            {% elif age == 4 %}1,550,000ƒë
                            {% else %}1,500,000ƒë
                            {% endif %}
                        </td>
                        <td>
                            {% set tuition = 1850000 if age == 1 else 1750000 if age == 2 else 1650000 if age == 3 else 1550000 if age == 4 else 1500000 %}
                            {% set meal_cost = (attendance_days[student.id] + absent_unexcused_days[student.id]) * 38000 %}
                            {% set base_total = meal_cost + tuition %}
                            {% set english_cost = 250000 if services_dict[student.id].has_english else 0 %}
                            {% set steamax_cost = 200000 if services_dict[student.id].has_steamax else 0 %}
                            {% set total = base_total + english_cost + steamax_cost %}
                            <span class="total-amount" data-student-id="{{ student.id }}" 
                                  data-base-total="{{ base_total }}" 
                                  data-english="250000" 
                                  data-steamax="200000">
                                {{ "{:,}".format(total) }}ƒë
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="submit" name="export_word" value="1" class="btn btn-primary {% if mobile %}invoice-btn-mobile{% endif %}">Xu·∫•t Word cho h·ªçc sinh ƒë√£ ch·ªçn</button>
    </form>
    {% if invoices %}
    <h3 class="mt-4">K·∫øt qu·∫£ h√≥a ƒë∆°n</h3>
    <ul>
        {% for invoice in invoices %}
        <li>{{ invoice }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<script>
// T·ª± ƒë·ªông t√≠nh l·∫°i t·ªïng ti·ªÅn khi checkbox thay ƒë·ªïi
document.addEventListener('DOMContentLoaded', function() {
    const englishCheckboxes = document.querySelectorAll('.english-checkbox');
    const steamaxCheckboxes = document.querySelectorAll('.steamax-checkbox');
    
    // L·∫•y th√°ng hi·ªán t·∫°i t·ª´ URL ho·∫∑c page
    const currentMonth = '{{ selected_month }}';
    
    function updateTotal(studentId) {
        const totalSpan = document.querySelector(`[data-student-id="${studentId}"].total-amount`);
        const englishCheckbox = document.querySelector(`input[name="english_${studentId}"]`);
        const steamaxCheckbox = document.querySelector(`input[name="steamax_${studentId}"]`);
        
        if (totalSpan && englishCheckbox && steamaxCheckbox) {
            const baseTotal = parseInt(totalSpan.dataset.baseTotal);
            const englishCost = englishCheckbox.checked ? 250000 : 0;
            const steamaxCost = steamaxCheckbox.checked ? 200000 : 0;
            const newTotal = baseTotal + englishCost + steamaxCost;
            
            // Format s·ªë v·ªõi d·∫•u ph·∫©y
            totalSpan.textContent = newTotal.toLocaleString('vi-VN') + 'ƒë';
        }
    }
    
    function saveServiceData(studentId, serviceType, checked) {
        const data = {
            child_id: parseInt(studentId),
            month: currentMonth,
            has_english: serviceType === 'english' ? checked : document.querySelector(`input[name="english_${studentId}"]`).checked,
            has_steamax: serviceType === 'steamax' ? checked : document.querySelector(`input[name="steamax_${studentId}"]`).checked
        };
        
        console.log('üíæ Saving service data:', data);
        
        fetch('/api/save_monthly_service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('‚úÖ ƒê√£ l∆∞u d·ªãch v·ª• cho h·ªçc sinh ' + studentId + ', th√°ng ' + currentMonth);
            } else {
                console.error('‚ùå L·ªói l∆∞u d·ªãch v·ª•:', result.error);
            }
        })
        .catch(error => {
            console.error('‚ùå L·ªói network:', error);
        });
    }
    
    // G·∫Øn event listener cho t·∫•t c·∫£ checkbox
    englishCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const studentId = this.dataset.studentId;
            updateTotal(studentId);
            saveServiceData(studentId, 'english', this.checked);
        });
    });
    
    steamaxCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const studentId = this.dataset.studentId;
            updateTotal(studentId);
            saveServiceData(studentId, 'steamax', this.checked);
        });
    });
    
    // T√≠nh t·ªïng ban ƒë·∫ßu cho t·∫•t c·∫£ h·ªçc sinh khi trang load
    const allStudentIds = new Set();
    englishCheckboxes.forEach(cb => allStudentIds.add(cb.dataset.studentId));
    steamaxCheckboxes.forEach(cb => allStudentIds.add(cb.dataset.studentId));
    
    allStudentIds.forEach(studentId => {
        updateTotal(studentId);
    });
});

// Toggle functions cho quick controls
function toggleAllEnglish() {
    const checkboxes = document.querySelectorAll('.english-checkbox');
    const firstChecked = checkboxes[0] ? checkboxes[0].checked : false;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !firstChecked;
        const studentId = checkbox.dataset.studentId;
        updateTotal(studentId);
        saveServiceData(studentId, 'english', checkbox.checked);
    });
}

function toggleAllSteamax() {
    const checkboxes = document.querySelectorAll('.steamax-checkbox');
    const firstChecked = checkboxes[0] ? checkboxes[0].checked : false;
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = !firstChecked;
        const studentId = checkbox.dataset.studentId;
        updateTotal(studentId);
        saveServiceData(studentId, 'steamax', checkbox.checked);
    });
}

function updateTotal(studentId) {
    const totalSpan = document.querySelector(`[data-student-id="${studentId}"].total-amount`);
    const englishCheckbox = document.querySelector(`input[name="english_${studentId}"]`);
    const steamaxCheckbox = document.querySelector(`input[name="steamax_${studentId}"]`);
    
    if (totalSpan && englishCheckbox && steamaxCheckbox) {
        const baseTotal = parseInt(totalSpan.dataset.baseTotal);
        const englishCost = englishCheckbox.checked ? 250000 : 0;
        const steamaxCost = steamaxCheckbox.checked ? 200000 : 0;
        const newTotal = baseTotal + englishCost + steamaxCost;
        
        // Format s·ªë v·ªõi d·∫•u ph·∫©y
        totalSpan.textContent = newTotal.toLocaleString('vi-VN') + 'ƒë';
    }
}
</script>

{% endblock %}
