{% extends 'base.html' %}
{% block content %}
<style>
    .attendance-table-mobile { font-size:0.85em; }
    .attendance-table-desktop { font-size:1em; }
    .attendance-btn-mobile { width:100%; margin-bottom:8px; font-size:0.95em; }
    .attendance-btn-group-mobile { display:flex; flex-direction:column; gap:8px; }
    .attendance-radio-mobile .form-check-input { width:1.1em; height:1.1em; }
    .attendance-radio-mobile .form-check-label { font-size:0.92em; margin-left:3px; }
    .attendance-table-mobile thead th { position:sticky; top:0; background:#c8e6c9; z-index:2; }
    .attendance-table-mobile td, .attendance-table-mobile th { padding:0.18em 0.08em; }
    .attendance-table-wrapper { border:1.5px solid #c8e6c9; border-radius:0; box-shadow:none; background:#fff; margin-left:-12px; margin-right:-12px; }
    .attendance-scroll-hint { font-size:0.92em; color:#388e3c; text-align:center; margin-bottom:3px; }
    @media (max-width: 576px) {
        .attendance-table-wrapper { margin-left:-16px; margin-right:-16px; border-radius:0; }
    }
    </style>
<style>
    /* Header bảng điểm danh và nhận xét: chữ đậm, màu xanh đậm, nền sáng */
    .attendance-header-custom th,
    .student-note-header-custom th {
        color: #256029 !important;
        background: #e8f5e9 !important;
        font-weight: bold;
        font-size: 1em;
        border-bottom: 2px solid #a5d6a7;
    }
</style>
<style>
    /* Tối ưu giao diện nhận xét từng học sinh */
    .student-note-block {
        background: #fffde7;
        border: 2px solid #ffe082;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.08);
        padding: 10px 8px 2px 8px;
        margin-top: 8px;
        margin-bottom: 18px;
    }
    .student-note-table th, .student-note-table td {
        background: transparent !important;
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="fw-bold text-center mb-3" style="color:#43a047; font-size:1.1em;">Điểm danh học sinh theo ngày</h2>
    <div class="d-flex flex-column flex-md-row gap-2 mb-3 attendance-btn-group-mobile">
        <a href="/classes/new" class="btn btn-success {% if mobile %}attendance-btn-mobile{% endif %}">Tạo Lớp mới</a>
        <a href="/attendance/new" class="btn btn-primary {% if mobile %}attendance-btn-mobile{% endif %}">Tạo học sinh mới</a>
        <a href="/attendance/history" class="btn btn-info {% if mobile %}attendance-btn-mobile{% endif %}" {% if session['role'] == 'parent' %}style="display:none;"{% endif %}>Xem lịch sử điểm danh / Xuất hóa đơn</a>
        <a href="/students" class="btn btn-secondary {% if mobile %}attendance-btn-mobile{% endif %}">Danh sách học sinh</a>
        <a href="/bmi-index" class="btn btn-warning text-dark {% if mobile %}attendance-btn-mobile{% endif %}">Chỉ Số BMI</a>
        <div class="d-flex justify-content-end mb-3">
        </div>
    </div>
    <form method="get" action="">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="attendance_date" class="form-label">Chọn ngày điểm danh:</label>
                <input type="date" id="attendance_date" name="attendance_date" class="form-control" value="{{ current_date }}" onchange="this.form.submit()">
            </div>
            <div class="col-md-6">
                <label for="class_name" class="form-label">Lọc theo lớp:</label>
                <select id="class_name" name="class_name" class="form-select" onchange="this.form.submit()">
                    <option value="">Tất cả lớp</option>
                    {% for cname in class_names %}
                    <option value="{{ cname }}" {% if selected_class == cname %}selected{% endif %}>{{ cname }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="attendance_date" value="{{ current_date }}">
        <input type="hidden" name="class_name" value="{{ selected_class }}">
        {% if mobile %}
        <div class="attendance-scroll-hint">Vuốt ngang để xem đủ các trường trong bảng &rarr;</div>
        {% endif %}
        <div class="table-responsive attendance-table-wrapper">
            <table class="table table-bordered align-middle {% if mobile %}attendance-table-mobile{% else %}attendance-table-desktop{% endif %}">
                <thead class="table-success attendance-header-custom">
                    <tr>
                        <th>Họ và tên</th>
                        <th>Mã số học sinh</th>
                        <th>Lớp</th>
                        <th>Ngày sinh</th>
                        <th>Liên hệ phụ huynh</th>
                        <th>Có mặt</th>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr style="background: #f1f8e9;">
                        <td>
                            <span style="color:#1976d2; font-weight:bold; font-size:1.08em;">{{ student.name }}</span>
                            {% if session.get('role') in ['admin', 'teacher'] %}
                                <a href="/students/{{ student.id }}/edit" class="btn btn-warning btn-sm ms-2" title="Sửa thông tin học sinh"><i class="bi bi-pencil-square"></i> Sửa</a>
                            {% endif %}
                        </td>
                        <td>{{ student.student_code }}</td>
                        <td>{{ student.class_name if student.class_name else '' }}</td>
                        <td>{% if student.birth_date %}{{ student.birth_date | datetimeformat('d/m/Y') }}{% endif %}</td>
                        <td>{{ student.parent_contact }}</td>
                        <td>
                            <div class="d-flex flex-column flex-md-row gap-2 attendance-radio-mobile">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="present_{{ student.id }}" id="present_yes_{{ student.id }}" value="yes" {% if student.status == 'Có mặt' %}checked{% endif %}>
                                    <label class="form-check-label" for="present_yes_{{ student.id }}" style="color:#388e3c; font-weight:bold;">Có mặt</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="present_{{ student.id }}" id="present_absent_excused_{{ student.id }}" value="absent_excused" {% if student.status == 'Vắng mặt có phép' %}checked{% endif %}>
                                    <label class="form-check-label" for="present_absent_excused_{{ student.id }}" style="color:#f9a825; font-weight:bold;">Vắng mặt có phép</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="present_{{ student.id }}" id="present_absent_unexcused_{{ student.id }}" value="absent_unexcused" {% if student.status == 'Vắng mặt không phép' %}checked{% endif %}>
                                    <label class="form-check-label" for="present_absent_unexcused_{{ student.id }}" style="color:#d32f2f; font-weight:bold;">Vắng mặt không phép</label>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- Nhận xét trong ngày cho từng học sinh -->
                    <tr>
                        <td colspan="6">
                            <div class="table-responsive student-note-block">
                                <table class="table table-bordered table-sm mb-0 student-note-table">
                                    <thead class="table-light student-note-header-custom">
                                        <tr>
                                            <th style="width:30%">Nội dung</th>
                                            <th>Ghi chú chi tiết</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Ăn sáng</td>
                                            <td>
                                                <select name="breakfast_{{ student.id }}" class="form-select form-select-sm">
                                                    <option value="" {% if not student.breakfast %}selected{% endif %}>--Chọn--</option>
                                                    <option value="Hết" {% if student.breakfast=='Hết' %}selected{% endif %}>Hết</option>
                                                    <option value="1/2" {% if student.breakfast=='1/2' %}selected{% endif %}>1/2</option>
                                                    <option value="Không ăn" {% if student.breakfast=='Không ăn' %}selected{% endif %}>Không ăn</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Ăn trưa</td>
                                            <td>
                                                <select name="lunch_{{ student.id }}" class="form-select form-select-sm">
                                                    <option value="" {% if not student.lunch %}selected{% endif %}>--Chọn--</option>
                                                    <option value="Hết" {% if student.lunch=='Hết' %}selected{% endif %}>Hết</option>
                                                    <option value="1/2" {% if student.lunch=='1/2' %}selected{% endif %}>1/2</option>
                                                    <option value="Không ăn" {% if student.lunch=='Không ăn' %}selected{% endif %}>Không ăn</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Ăn xế</td>
                                            <td>
                                                <select name="snack_{{ student.id }}" class="form-select form-select-sm">
                                                    <option value="" {% if not student.snack %}selected{% endif %}>--Chọn--</option>
                                                    <option value="Hết" {% if student.snack=='Hết' %}selected{% endif %}>Hết</option>
                                                    <option value="1/2" {% if student.snack=='1/2' %}selected{% endif %}>1/2</option>
                                                    <option value="Không ăn" {% if student.snack=='Không ăn' %}selected{% endif %}>Không ăn</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Đi vệ sinh (ỉa)</td>
                                            <td>
                                                <select name="toilet_{{ student.id }}" class="form-select form-select-sm mb-1">
                                                    <option value="" {% if not student.toilet %}selected{% endif %}>--Chọn--</option>
                                                    <option value="Có" {% if student.toilet=='Có' %}selected{% endif %}>Có</option>
                                                    <option value="Không" {% if student.toilet=='Không' %}selected{% endif %}>Không</option>
                                                </select>
                                                <span class="ms-2">Số lần:</span>
                                                <select name="toilet_times_{{ student.id }}" class="form-select form-select-sm d-inline-block" style="width:auto; min-width:60px;">
                                                    <option value="" {% if not student.toilet_times %}selected{% endif %}>--</option>
                                                    {% for i in range(1,6) %}
                                                    <option value="{{ i }}" {% if student.toilet_times==i %}selected{% endif %}>{{ i }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Ghi chú khác</td>
                                            <td>
                                                <input type="text" name="note_{{ student.id }}" class="form-control form-control-sm" value="{{ student.note or '' }}" placeholder="Nhập ghi chú...">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center">Chưa có học sinh nào.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-success {% if mobile %}attendance-btn-mobile{% endif %}">Lưu điểm danh</button>
    </form>
</div>
{% if session['role'] == 'parent' %}
    <script>
        window.location.href = '/attendance/history';
    </script>
{% endif %}
{% endblock %}
