{% extends 'base.html' %}
{% block content %}
<style>
    .curriculum-textarea { min-width:80px; min-height:2.2em; resize:vertical; font-size:1em; transition:all 0.2s; cursor:pointer; }
    .curriculum-textarea:focus { outline:none; }
    @media (max-width: 576px) {
        .curriculum-textarea { min-width:100px; font-size:0.98em; padding:0.35em 0.5em; }
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="mb-4 fw-bold" style="color:#43a047;">Tạo chương trình học mới</h2>
    <form method="POST" id="curriculumForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="week_number" class="form-label">Tuần số <small class="text-muted">(Hiện tại: {{ current_week }}/{{ current_year }})</small></label>
            <div class="d-flex gap-2 align-items-center">
                <input type="number" class="form-control rounded curriculum-textarea" id="week_number" name="week_number" min="1" required>
                <div id="week_range_display" class="text-muted" style="min-width:220px; font-size:0.95em;"></div>
            </div>
        </div>

        <!-- Hidden server-provided values to avoid injecting Jinja directly into JS -->
        <input type="hidden" id="server_week" value="{{ current_week }}">
        <input type="hidden" id="server_year" value="{{ current_year }}">
        <input type="hidden" id="server_week_start" value="{{ current_week_start }}">
        <input type="hidden" id="server_week_end" value="{{ current_week_end }}">

        <script>
        // Auto-fill week number input with current week and show start/end dates
        document.addEventListener('DOMContentLoaded', function() {
            var weekInput = document.getElementById('week_number');
            var serverWeekEl = document.getElementById('server_week');
            var serverYearEl = document.getElementById('server_year');
            var serverStartEl = document.getElementById('server_week_start');
            var serverEndEl = document.getElementById('server_week_end');
            var serverWeek = serverWeekEl ? parseInt(serverWeekEl.value) : null;
            var serverYear = serverYearEl ? parseInt(serverYearEl.value) : null;
            var serverWeekStart = serverStartEl ? serverStartEl.value : '';
            var serverWeekEnd = serverEndEl ? serverEndEl.value : '';

            if (weekInput) {
                if (serverWeek) weekInput.value = serverWeek;
                else {
                    var now = new Date();
                    var onejan = new Date(now.getFullYear(),0,1);
                    var week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay()+1)/7);
                    weekInput.value = week;
                }
            }

            var display = document.getElementById('week_range_display');
            function updateWeekRange() {
                var w = parseInt(weekInput.value) || serverWeek || 1;
                var y = serverYear || new Date().getFullYear();
                // If the server provided start/end for the default week, show them
                if (serverWeek && w === serverWeek && serverWeekStart && serverWeekEnd) {
                    display.textContent = `(${serverWeekStart} - ${serverWeekEnd})`;
                    return;
                }
                // Compute Monday of the ISO week
                function getMondayOfWeek(year, weekNumber) {
                    const jan4 = new Date(year, 0, 4);
                    const jan4Day = jan4.getDay() || 7;
                    const monday = new Date(jan4);
                    monday.setDate(jan4.getDate() - jan4Day + 1 + (weekNumber - 1) * 7);
                    return monday;
                }
                function formatDate(d) {
                    const dd = String(d.getDate()).padStart(2, '0');
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const yy = String(d.getFullYear());
                    return `${dd}/${mm}/${yy}`;
                }
                try {
                    const m = getMondayOfWeek(y, w);
                    const end = new Date(m);
                    end.setDate(m.getDate() + 6);
                    display.textContent = `(${formatDate(m)} - ${formatDate(end)})`;
                } catch (e) {
                    display.textContent = '';
                }
            }
            updateWeekRange();
            if (weekInput) weekInput.addEventListener('input', updateWeekRange);
        });
        </script>
        <div class="mb-3">
            <label for="class_id" class="form-label">Chọn lớp</label>
            <select class="form-select" id="class_id" name="class_id" required>
                <option value="">-- Chọn lớp --</option>
                {% for c in classes %}
                <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Nội dung từng khung giờ</label>
            <div class="table-responsive" style="margin-left:-12px; margin-right:-12px;">
            <table class="table table-bordered align-middle bg-light">
                <thead class="table-success">
                    <tr>
                        <th rowspan="2">Khung giờ</th>
                        <th colspan="6" class="text-center">Thứ</th>
                    </tr>
                    <tr>
                        <th>Thứ 2</th>
                        <th>Thứ 3</th>
                        <th>Thứ 4</th>
                        <th>Thứ 5</th>
                        <th>Thứ 6</th>
                        <th>Thứ 7</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="table-info"><td colspan="7" class="fw-bold text-success text-center">Buổi sáng</td></tr>
                    {% set morning_slots = [
                        ('7-17h', 'morning_0'),
                        ('7-8h', 'morning_1'),
                        ('8h-8h30', 'morning_2'),
                        ('8h30-9h', 'morning_3'),
                        ('9h-9h40', 'morning_4'),
                        ('9h40-10h30', 'morning_5'),
                        ('10h30-14h', 'morning_6')
                    ] %}
                    {% for label, key in morning_slots %}
                    <tr>
                        <td class="fw-bold text-success">{{ label }}</td>
                        {% if key in ['morning_1', 'morning_2', 'morning_6'] %}
                            <td colspan="6">
                                <textarea class="form-control curriculum-textarea" name="merged_{{ key }}" onclick="openPopup(this)">
                                    {% if key == 'morning_1' %}Đón trẻ - STEAM (massage kích thích giác quan) - Ăn sáng{% elif key == 'morning_2' %}Thể dục buổi sáng - Trò chuyện đầu ngày - Kiểm tra thân thể{% elif key == 'morning_6' %}Vệ sinh ăn trưa - ngủ trưa{% endif %}
                                </textarea>
                            </td>
                        {% else %}
                            {% for day in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'] %}
                                {% set day_idx = loop.index0 %}
                                <td>
                                    <textarea class="form-control curriculum-textarea" name="{{ day }}_{{ key }}" onclick="openPopup(this)">
                                        {%- if data and data[day][key] -%}
                                            {{ data[day][key] }}
                                        {%- elif key == 'morning_0' -%}
                                            {%- if day_idx == 1 -%}Toán học{%- elif day_idx == 2 -%}Ngôn Ngữ{%- elif day_idx == 3 -%}Stemax{%- elif day_idx == 4 -%}Trải Nghiệm{%- endif -%}
                                        {%- endif -%}
                                    </textarea>
                                </td>
                            {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                    <tr class="table-info"><td colspan="7" class="fw-bold text-success text-center">Buổi chiều</td></tr>
                    {% set afternoon_slots = [
                        ('14h15-15h', 'afternoon_1'),
                        ('15h-15h30', 'afternoon_2'),
                        ('15h45-16h', 'afternoon_3'),
                        ('16h-17h', 'afternoon_4')
                    ] %}
                    {% for label, key in afternoon_slots %}
                    <tr>
                        <td class="fw-bold text-success">{{ label }}</td>
                        {% if key in ['afternoon_1', 'afternoon_3', 'afternoon_4'] %}
                            <td colspan="6">
                                <textarea class="form-control curriculum-textarea" name="merged_{{ key }}" onclick="openPopup(this)">
                                    {% if key == 'afternoon_1' %}Vệ sinh - uống nước - vận động nhẹ - ăn chiều{% elif key == 'afternoon_3' %}Yoga/dance{% elif key == 'afternoon_4' %}Trả trẻ - trao đổi với phụ huynh{% endif %}
                                </textarea>
                            </td>
                        {% elif key == 'afternoon_2' %}
                            {% for day in ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'] %}
                                <td>
                                    <textarea class="form-control curriculum-textarea" name="{{ day }}_{{ key }}" onclick="openPopup(this)">
                                        {%- if data and data[day][key] -%}
                                            {{ data[day][key] }}
                                        {%- elif day == 'tue' or day == 'thu' -%}
                                            Hoạt động với giáo cụ
                                        {%- elif day == 'wed' or day == 'fri' -%}
                                            Lego time
                                        {%- endif -%}
                                    </textarea>
                                </td>
                            {% endfor %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        <button type="submit" class="btn btn-success">Lưu chương trình</button>
        <a href="{{ url_for('main.curriculum') }}" class="btn btn-outline-secondary ms-2">Quay lại</a>
    </form>
</div>
<!-- Modal nhập liệu -->
<div class="modal fade" id="popupTextareaModal" tabindex="-1" aria-labelledby="popupTextareaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="popupTextareaLabel">Nhập nội dung</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="popupTextarea" class="form-control" rows="7" style="font-size:1.15em;"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="savePopupTextarea()">Lưu</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
<script>
let currentTextarea = null;
function openPopup(textarea) {
    currentTextarea = textarea;
    document.getElementById('popupTextarea').value = textarea.value;
    var modal = new bootstrap.Modal(document.getElementById('popupTextareaModal'));
    modal.show();
    setTimeout(function() { document.getElementById('popupTextarea').focus(); }, 300);
}
function savePopupTextarea() {
    if (currentTextarea) {
        currentTextarea.value = document.getElementById('popupTextarea').value;
        var modalEl = document.getElementById('popupTextareaModal');
        var modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }
}
</script>
{% endblock %}
