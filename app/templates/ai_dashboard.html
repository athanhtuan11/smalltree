{% extends "base.html" %}

{% block title %}AI Dashboard - SMALL TREE{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Mobile Responsive CSS -->
<style>
    /* Mobile Optimization */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* Responsive tabs */
        .nav-tabs {
            flex-wrap: wrap;
        }
        
        .nav-tabs .nav-link {
            font-size: 14px;
            padding: 8px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Responsive cards */
        .card {
            margin-bottom: 15px;
        }
        
        .card-header h5 {
            font-size: 16px;
            margin-bottom: 0;
        }
        
        /* Responsive form elements */
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Responsive buttons */
        .btn {
            font-size: 14px;
            padding: 10px 15px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-group-mobile {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Hide long text on mobile */
        .mobile-hide {
            display: none;
        }
        
        /* Responsive progress bars */
        .progress {
            height: 25px;
        }
        
        /* Responsive list items */
        .list-group-item {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* Responsive info sections */
        .info-section {
            font-size: 13px;
        }
        
        .info-section ul li {
            margin-bottom: 5px;
        }
        
        /* Better spacing for mobile */
        .mt-4 {
            margin-top: 20px !important;
        }
        
        .mb-3 {
            margin-bottom: 15px !important;
        }
        
        /* Responsive text */
        h2 {
            font-size: 24px;
        }
        
        h5 {
            font-size: 16px;
        }
        
        h6 {
            font-size: 14px;
        }
        
        /* Mobile-specific layout */
        .mobile-col {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        /* Responsive textarea */
        textarea.form-control {
            min-height: 80px;
            font-size: 14px;
        }
        
        /* Better touch targets */
        .nav-link {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive alerts */
        .alert {
            font-size: 14px;
            padding: 10px;
        }
    }
    
    /* Small mobile devices */
    @media (max-width: 576px) {
        .nav-tabs .nav-link {
            font-size: 12px;
            padding: 6px 8px;
            max-width: 140px;
        }
        
        .nav-tabs .nav-link i {
            display: none; /* Hide icons on very small screens */
        }
        
        h2 {
            font-size: 20px;
        }
        
        .card-header h5 {
            font-size: 14px;
        }
    }
    
    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .nav-tabs .nav-link {
            font-size: 13px;
            padding: 6px 10px;
        }
    }
</style>

<div class="container mt-4" style="max-width:900px; margin:0 auto;">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-robot"></i> AI Dashboard <span class="mobile-hide">- LLM Farm</span></h2>
            <p class="text-muted">S·ª≠ d·ª•ng AI ƒë·ªÉ h·ªó tr·ª£ qu·∫£n l√Ω m·∫ßm non</p>
        </div>
    </div>

    <!-- AI Features Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-ai" 
                            type="button" role="tab" aria-controls="menu-ai" aria-selected="true">
                        <i class="fas fa-utensils"></i> <span class="d-none d-sm-inline">Menu AI</span><span class="d-sm-none">Menu</span>
                    </button>
                </li>
                <!-- Curriculum AI tab removed -->
            </ul>
            <div class="tab-content" id="aiTabsContent">
                <!-- Menu AI Tab -->
                <div class="tab-pane fade show active" id="menu-ai" role="tabpanel" aria-labelledby="menu-tab">
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-utensils"></i> G·ª£i √Ω th·ª±c ƒë∆°n dinh d∆∞·ª°ng AI</h5>
                                    <small>T·∫°o th·ª±c ƒë∆°n c√¢n b·∫±ng dinh d∆∞·ª°ng t·ª´ nguy√™n li·ªáu c√≥ s·∫µn</small>
                                </div>
                                <div class="card-body">
                                    <form id="menuSuggestionForm">
                                        <div class="mb-3">
                                            <label for="ageGroup" class="form-label">ƒê·ªô tu·ªïi</label>
                                            <select class="form-select" id="ageGroup" name="age_group">
                                                <option value="1-3 tu·ªïi" selected>1-3 tu·ªïi</option>
                                                <option value="3-5 tu·ªïi">3-5 tu·ªïi</option>
                                                <option value="1-5 tu·ªïi">1-5 tu·ªïi (ƒëa ƒë·ªô tu·ªïi)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="availableIngredients" class="form-label">Th·ª±c ph·∫©m c√≥ s·∫µn</label>
                                            <textarea class="form-control" id="availableIngredients" rows="4" 
                                                      placeholder="Nh·∫≠p th·ª±c ph·∫©m c√≥ s·∫µn, m·ªói lo·∫°i m·ªôt d√≤ng...&#10;VD: Th·ªãt heo, C√† r·ªët, C∆°m, Tr·ª©ng g√†, C√°, Rau xanh, Tr√°i c√¢y..."></textarea>
                                            <small class="form-text text-muted">AI s·∫Ω ƒë∆∞a ra g·ª£i √Ω th·ª±c ƒë∆°n dinh d∆∞·ª°ng v√† ph√π h·ª£p t·ª´ c√°c nguy√™n li·ªáu n√†y</small>
                                        </div>
                                        
                                        <!-- Ch·ªçn tu·∫ßn ƒë·ªÉ t·∫°o th·ª±c ƒë∆°n -->
                                        <div class="mb-3">
                                            <label for="targetWeek" class="form-label">Tu·∫ßn c·∫ßn t·∫°o th·ª±c ƒë∆°n</label>
                                            <input type="number" class="form-control" id="targetWeek" name="target_week" 
                                                   min="1" max="53" placeholder="Nh·∫≠p s·ªë tu·∫ßn (1-53)">
                                            <small class="form-text text-muted">Nh·∫≠p s·ªë tu·∫ßn c·∫ßn t·∫°o th·ª±c ƒë∆°n (VD: 38, 39, 40...)</small>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary" id="menuSubmitBtn">
                                                <i class="fas fa-magic"></i> T·∫°o g·ª£i √Ω th·ª±c ƒë∆°n dinh d∆∞·ª°ng
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Menu -->
                                    <div id="menuProgress" class="mt-3" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" style="width: 0%" id="menuProgressBar"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-1" id="menuProgressText">ƒêang kh·ªüi t·∫°o AI...</small>
                                    </div>
                                    
                                    <div id="menuResults" class="mt-3" style="display: none;">
                                        <h6>K·∫øt qu·∫£:</h6>
                                        <ul id="menuList" class="list-group"></ul>
                                        <!-- N√∫t l∆∞u th·ª±c ƒë∆°n tu·∫ßn t·ª´ AI -->
                                        <div class="d-grid mt-3">
                                            <button id="createMenuBtn" class="btn btn-success" type="button">
                                                <i class="fas fa-save"></i> L∆∞u th·ª±c ƒë∆°n tu·∫ßn n√†y
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {% if menu_result and menu_result.prompt %}
                                        {% set prompt_js = menu_result.prompt|tojson|safe %}
                                    {% else %}
                                        {% set prompt_js = '""' %}
                                    {% endif %}
                                    <script>
                                        // Lu√¥n in prompt ra console, k·ªÉ c·∫£ khi kh√¥ng c√≥ menu_result
                                        var prompt = {{ prompt_js }};
                                        console.log("[DEBUG] Prompt AI:", prompt);
                                    </script>
                                    {% if menu_result and menu_result.prompt %}
                                    <div class="alert alert-info mt-3">
                                        <strong>Prompt g·ª£i √Ω cho AI:</strong><br>
                                        <textarea class="form-control" rows="10" readonly style="font-size:0.95em; white-space:pre;">{{ menu_result.prompt }}</textarea>
                                        <small class="text-muted">Copy to√†n b·ªô prompt n√†y v√† g·ª≠i cho AI. L∆∞u √Ω: AI ch·ªâ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë√∫ng c√°c m√≥n trong danh s√°ch, tuy·ªát ƒë·ªëi kh√¥ng t·ª± √Ω th√™m m√≥n m·ªõi.</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Curriculum AI tab content removed -->
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-link"></i> Li√™n k·∫øt nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.menu') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-calendar-alt"></i><br><span class="d-none d-sm-inline">Xem </span>Th·ª±c ƒë∆°n
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.suppliers') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-truck"></i><br><span class="d-none d-sm-inline">Nh√† </span>Cung c·∫•p
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.products') }}" class="btn btn-outline-dark w-100 mb-2">
                                <i class="fas fa-box"></i><br>S·∫£n ph·∫©m
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.dish_list') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-list"></i><br>Danh s√°ch m√≥n ƒÉn
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.create_dish') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-plus-circle"></i><br><span class="d-none d-sm-inline">T·∫°o </span>M√≥n ƒÉn
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
        </div>
        <p class="mt-2">AI ƒëang x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Menu Suggestions
    let currentMenuData = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u data AI
    let selectedWeek = null; // Tu·∫ßn ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ t·∫°o th·ª±c ƒë∆°n
    
    // Initialize week input v·ªõi tu·∫ßn hi·ªán t·∫°i
    function initializeWeekInput() {
        const weekInput = document.getElementById('targetWeek');
        const today = new Date();
        const currentWeek = getWeekNumber(today);
        const currentYear = new Date().getFullYear();
        
        weekInput.value = currentWeek;
        selectedWeek = {week: currentWeek, year: currentYear};
    }
    
    // Helper functions
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    
    function formatDate(date) {
        return date.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'});
    }
    
    // Initialize week input
    initializeWeekInput();
    
    // Week input change event
    document.getElementById('targetWeek').addEventListener('change', function(e) {
        const weekNumber = parseInt(e.target.value);
        const currentYear = new Date().getFullYear();
        
        if (weekNumber >= 1 && weekNumber <= 53) {
            selectedWeek = {week: weekNumber, year: currentYear};
            console.log('[DEBUG] Selected week:', selectedWeek);
        } else {
            alert('Vui l√≤ng nh·∫≠p s·ªë tu·∫ßn t·ª´ 1 ƒë·∫øn 53');
            e.target.value = getWeekNumber(new Date()); // Reset v·ªÅ tu·∫ßn hi·ªán t·∫°i
        }
    });
    
    document.getElementById('menuSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('üî• [DEBUG] Form submitted!');
        
        showMenuProgress();
        
        const formData = {
            age_group: document.getElementById('ageGroup').value,
            available_ingredients: document.getElementById('availableIngredients').value,
            count: 5 // Fixed count
        };
        
        console.log('üìù [DEBUG] Form data:', formData);
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        // Fetch with CSRF token
        fetch('/ai/menu-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('üì° [DEBUG] Response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`üö´ ${data.error || 'Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server kh√¥ng tr·∫£ v·ªÅ JSON, c√≥ th·ªÉ b·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng c√≥ quy·ªÅn");
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ [DEBUG] Data received:', data);
            hideMenuProgress();
            if (data.success) {
                currentMenuData = data; // L∆∞u data ƒë·ªÉ t·∫°o menu sau
                displayMenuResults(data.menu);
            } else {
                console.error('‚ùå [DEBUG] Server error:', data.error);
                alert('L·ªói: ' + data.error);
            }
        })
        .catch(error => {
            console.error('üí• [DEBUG] Fetch error:', error);
            hideMenuProgress();
            console.error('Chi ti·∫øt l·ªói:', error);
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('üö´')) {
                // Rate limit or quota errors - show clean message without fallback
                alert(errorMsg.replace('üö´ ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('‚ö†Ô∏è API ƒë√£ h·∫øt quota ho·∫∑c qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
            } else {
                // Show fallback suggestions for network errors only
                const fallbackSuggestions = [
                    "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI",
                    "üîß Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng",
                    "üí° Th·ª≠ l·∫°i sau √≠t ph√∫t"
                ];
                displayMenuResults(fallbackSuggestions);
                alert('‚ö†Ô∏è L·ªói k·∫øt n·ªëi AI: ' + errorMsg);
            }
        });
    });

    // X·ª≠ l√Ω n√∫t t·∫°o th·ª±c ƒë∆°n m·ªõi
    document.getElementById('createMenuBtn').addEventListener('click', function() {
        if (!currentMenuData) {
            alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ª±c ƒë∆°n ƒë·ªÉ t·∫°o. Vui l√≤ng t·∫°o g·ª£i √Ω th·ª±c ƒë∆°n tr∆∞·ªõc.');
            return;
        }
        
        // L·∫•y s·ªë tu·∫ßn t·ª´ input
        const weekInput = document.getElementById('targetWeek');
        const weekNumber = parseInt(weekInput.value);
        const currentYear = new Date().getFullYear();
        
        if (!weekNumber || weekNumber < 1 || weekNumber > 53) {
            alert('Vui l√≤ng nh·∫≠p s·ªë tu·∫ßn h·ª£p l·ªá (1-53).');
            return;
        }
        
        selectedWeek = {week: weekNumber, year: currentYear};
        const confirmCreate = confirm(`B·∫°n c√≥ mu·ªën t·∫°o th·ª±c ƒë∆°n m·ªõi cho tu·∫ßn ${selectedWeek.week}/${selectedWeek.year} t·ª´ k·∫øt qu·∫£ AI n√†y kh√¥ng?`);
        if (!confirmCreate) return;
        
        // Hi·ªÉn th·ªã loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o th·ª±c ƒë∆°n...';
        btn.disabled = true;
        
        // G·ª≠i request t·∫°o menu
        const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
        
        function createMenu(overwrite = false) {
            console.log('[DEBUG] currentMenuData:', currentMenuData);
            console.log('[DEBUG] selectedWeek:', selectedWeek);
            
            const requestData = { 
                menu: currentMenuData.menu,  // Ch·ªâ g·ª≠i menu data, kh√¥ng g·ª≠i to√†n b·ªô response
                overwrite: overwrite,
                target_week: selectedWeek.week,
                target_year: selectedWeek.year
            };
            
            console.log('[DEBUG] requestData to send:', requestData);
            
            fetch('/ai/create-menu-from-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('[DEBUG] Response status:', response.status);
                console.log('[DEBUG] Response headers:', response.headers);
                
                if (response.status === 409) {
                    // Conflict - menu ƒë√£ t·ªìn t·∫°i
                    return response.json().then(data => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        const confirmOverwrite = confirm(
                            `${data.error}\n\nB·∫•m OK ƒë·ªÉ ghi ƒë√® th·ª±c ƒë∆°n hi·ªán c√≥, Cancel ƒë·ªÉ h·ªßy.`
                        );
                        
                        if (confirmOverwrite) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ghi ƒë√® th·ª±c ƒë∆°n...';
                            btn.disabled = true;
                            createMenu(true); // G·ªçi l·∫°i v·ªõi overwrite = true
                        }
                        return null;
                    });
                }
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Not JSON - probably HTML error page
                    return response.text().then(text => {
                        throw new Error(`Server returned HTML instead of JSON: ${text.substring(0, 100)}...`);
                    });
                }
            })
            .then(data => {
                if (data) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    if (data.success) {
                        const message = data.overwritten 
                            ? `‚úÖ ƒê√£ c·∫≠p nh·∫≠t th·ª±c ƒë∆°n tu·∫ßn ${data.week_number} th√†nh c√¥ng!`
                            : `‚úÖ ƒê√£ t·∫°o th·ª±c ƒë∆°n tu·∫ßn ${data.week_number} th√†nh c√¥ng!`;
                        alert(message);
                        // Chuy·ªÉn ƒë·∫øn trang menu
                        window.location.href = '/menu';
                    } else {
                        alert('‚ùå L·ªói t·∫°o th·ª±c ƒë∆°n: ' + data.error);
                    }
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error('L·ªói:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            });
        }
        
        createMenu(); // B·∫Øt ƒë·∫ßu t·∫°o menu
    });



    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    // Progress Bar Functions for Menu
    function showMenuProgress() {
        // ·∫®n k·∫øt qu·∫£ c≈© v√† hi·ªán progress
        document.getElementById('menuResults').style.display = 'none';
        document.getElementById('menuProgress').style.display = 'block';
        document.getElementById('menuSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        
        let progress = 0;
        const messages = [
            'ƒêang kh·ªüi t·∫°o Gemini AI...',
            'ƒêang ph√¢n t√≠ch nguy√™n li·ªáu...',
            'ƒêang t·∫°o th·ª±c ƒë∆°n c√¢n b·∫±ng...',
            'ƒêang ki·ªÉm tra dinh d∆∞·ª°ng...',
            'Ho√†n t·∫•t!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20 + 15; // TƒÉng nhanh h∆°n 15-35%
            if (progress > 95) progress = 95; // G·∫ßn ho√†n t·∫•t
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 500); // TƒÉng t·ªëc ƒë·ªô c·∫≠p nh·∫≠t
        
        // L∆∞u interval ƒë·ªÉ c√≥ th·ªÉ clear sau
        window.menuProgressInterval = interval;
    }

    function hideMenuProgress() {
        // Clear interval v√† ·∫©n progress
        if (window.menuProgressInterval) {
            clearInterval(window.menuProgressInterval);
        }
        
        // Ho√†n th√†nh progress bar
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Ho√†n t·∫•t!';
        
        // ·∫®n sau 500ms
        setTimeout(() => {
            document.getElementById('menuProgress').style.display = 'none';
            document.getElementById('menuSubmitBtn').disabled = false;
        }, 500);
    }

    // Progress Bar Functions for Nutrition
    function showNutritionProgress() {
        document.getElementById('nutritionResults').style.display = 'none';
        document.getElementById('nutritionProgress').style.display = 'block';
        document.getElementById('nutritionSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        
        let progress = 0;
        const messages = [
            'ƒêang kh·ªüi t·∫°o Gemini AI...',
            'ƒêang ph√¢n t√≠ch th√†nh ph·∫ßn...',
            'ƒêang t√≠nh to√°n dinh d∆∞·ª°ng...',
            'ƒêang ƒë√°nh gi√° c√¢n b·∫±ng...',
            'Ho√†n t·∫•t ph√¢n t√≠ch!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 25 + 15; // TƒÉng nhanh 15-40%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 400); // Nhanh h∆°n
        
        window.nutritionProgressInterval = interval;
    }

    function hideNutritionProgress() {
        if (window.nutritionProgressInterval) {
            clearInterval(window.nutritionProgressInterval);
        }
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Ho√†n t·∫•t ph√¢n t√≠ch!';
        
        setTimeout(() => {
            document.getElementById('nutritionProgress').style.display = 'none';
            document.getElementById('nutritionSubmitBtn').disabled = false;
        }, 500);
    }

    function displayMenuResults(suggestions) {
        const resultDiv = document.getElementById('menuResults');
        const listElement = document.getElementById('menuList');
        // const createBtn = document.getElementById('createMenuBtn'); // n√∫t n√†y ƒë√£ b·ªã xo√°

        listElement.innerHTML = '';
        if (suggestions && typeof suggestions === 'object' && !Array.isArray(suggestions)) {
            // N·∫øu l√† object (menu tu·∫ßn), render b·∫£ng menu
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
            const slots = ['morning', 'snack', 'dessert', 'lunch', 'afternoon', 'lateafternoon'];
            const slotNames = ['S√°ng', 'Ph·ª• s√°ng', 'Tr√°ng mi·ªáng', 'Tr∆∞a', 'X·∫ø', 'X·∫ø chi·ªÅu'];
            let html = '<div class="table-responsive"><table class="table table-bordered table-sm align-middle text-center"><thead><tr><th>Th·ª©</th>';
            slotNames.forEach(slot => { html += `<th>${slot}</th>`; });
            html += '</tr></thead><tbody>';
            days.forEach((day, i) => {
                html += `<tr><td class="fw-bold text-success">${dayNames[i]}</td>`;
                slots.forEach(slot => {
                    html += `<td>${suggestions[day] && suggestions[day][slot] ? suggestions[day][slot] : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            // Hi·ªÉn th·ªã b·∫£ng trong listElement
            const li = document.createElement('li');
            li.className = 'list-group-item p-0';
            li.innerHTML = html;
            listElement.appendChild(li);
            
            // Hi·ªÉn th·ªã nutrition tips n·∫øu c√≥
            if (currentMenuData && currentMenuData.suggestions && currentMenuData.suggestions.nutrition_tips) {
                const tipsLi = document.createElement('li');
                tipsLi.className = 'list-group-item';
                tipsLi.innerHTML = `
                    <h6 class="text-primary"><i class="fas fa-lightbulb"></i> G·ª£i √Ω dinh d∆∞·ª°ng:</h6>
                    <ul class="mb-0">
                        ${currentMenuData.suggestions.nutrition_tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                `;
                listElement.appendChild(tipsLi);
            }
        } else if (Array.isArray(suggestions)) {
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = suggestion;
                listElement.appendChild(li);
            });
        } else {
            // N·∫øu kh√¥ng ph·∫£i m·∫£ng, hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            const li = document.createElement('li');
            li.className = 'list-group-item text-danger';
            li.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu th·ª±c ƒë∆°n.';
            listElement.appendChild(li);
        }

        // Kh√¥ng c√≤n n√∫t t·∫°o menu n√™n kh√¥ng c·∫ßn x·ª≠ l√Ω createBtn
        resultDiv.style.display = 'block';
    }

    function displayNutritionResults(analysis) {
        const resultDiv = document.getElementById('nutritionResults');
        const contentDiv = document.getElementById('nutritionContent');
        
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Calo:</strong> ${analysis.calories}</p>
                    <p><strong>Protein:</strong> ${analysis.protein_percent}</p>
                    <p><strong>Carbohydrate:</strong> ${analysis.carb_percent}</p>
                    <p><strong>Ch·∫•t b√©o:</strong> ${analysis.fat_percent}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Vitamin & Kho√°ng ch·∫•t:</strong> ${analysis.vitamins}</p>
                    <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> 
                        <span class="badge ${analysis.overall_score >= 7 ? 'bg-success' : analysis.overall_score >= 5 ? 'bg-warning' : 'bg-danger'}">
                            ${analysis.overall_score}/10
                        </span>
                    </p>
                </div>
            </div>
            <div class="mt-2">
                <strong>G·ª£i √Ω c·∫£i thi·ªán:</strong>
                <p class="text-muted">${analysis.suggestions}</p>
            </div>
        `;
        
        resultDiv.style.display = 'block';
    }

    // Curriculum AI functionality removed

    // ================================
    // URL PARAMETER HANDLING FOR TAB SWITCHING
    // ================================
    
    // Check URL parameters to auto-switch tabs
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'curriculum') {
        // Chuy·ªÉn sang tab Ch∆∞∆°ng tr√¨nh h·ªçc AI
        document.getElementById('menu-tab').classList.remove('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'false');
        document.getElementById('menu-ai').classList.remove('show', 'active');
        document.getElementById('curriculum-tab').classList.add('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'true');
        document.getElementById('curriculum-ai').classList.add('show', 'active');
        document.getElementById('curriculum-ai').classList.add('active');
    } else {
        // M·∫∑c ƒë·ªãnh ho·∫∑c tab=menu ƒë·ªÅu m·ªü Menu AI
        document.getElementById('menu-tab').classList.add('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'true');
        document.getElementById('menu-ai').classList.add('show', 'active');
        document.getElementById('menu-ai').classList.add('active');
        document.getElementById('curriculum-tab').classList.remove('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'false');
        document.getElementById('curriculum-ai').classList.remove('show', 'active');
        document.getElementById('curriculum-ai').classList.remove('active');
    }
    // Clean URL after processing (remove tab parameter)
    if (tabParam) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }


});
</script>
{% endblock %}
