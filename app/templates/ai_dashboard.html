{% extends "base.html" %}

{% block title %}AI Dashboard - LLM Farm{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Mobile Responsive CSS -->
<style>
    /* Mobile Optimization */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* Responsive tabs */
        .nav-tabs {
            flex-wrap: wrap;
        }
        
        .nav-tabs .nav-link {
            font-size: 14px;
            padding: 8px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Responsive cards */
        .card {
            margin-bottom: 15px;
        }
        
        .card-header h5 {
            font-size: 16px;
            margin-bottom: 0;
        }
        
        /* Responsive form elements */
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Responsive buttons */
        .btn {
            font-size: 14px;
            padding: 10px 15px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-group-mobile {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Hide long text on mobile */
        .mobile-hide {
            display: none;
        }
        
        /* Responsive progress bars */
        .progress {
            height: 25px;
        }
        
        /* Responsive list items */
        .list-group-item {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* Responsive info sections */
        .info-section {
            font-size: 13px;
        }
        
        .info-section ul li {
            margin-bottom: 5px;
        }
        
        /* Better spacing for mobile */
        .mt-4 {
            margin-top: 20px !important;
        }
        
        .mb-3 {
            margin-bottom: 15px !important;
        }
        
        /* Responsive text */
        h2 {
            font-size: 24px;
        }
        
        h5 {
            font-size: 16px;
        }
        
        h6 {
            font-size: 14px;
        }
        
        /* Mobile-specific layout */
        .mobile-col {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        /* Responsive textarea */
        textarea.form-control {
            min-height: 80px;
            font-size: 14px;
        }
        
        /* Better touch targets */
        .nav-link {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive alerts */
        .alert {
            font-size: 14px;
            padding: 10px;
        }
    }
    
    /* Small mobile devices */
    @media (max-width: 576px) {
        .nav-tabs .nav-link {
            font-size: 12px;
            padding: 6px 8px;
            max-width: 140px;
        }
        
        .nav-tabs .nav-link i {
            display: none; /* Hide icons on very small screens */
        }
        
        h2 {
            font-size: 20px;
        }
        
        .card-header h5 {
            font-size: 14px;
        }
    }
    
    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .nav-tabs .nav-link {
            font-size: 13px;
            padding: 6px 10px;
        }
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-robot"></i> AI Dashboard <span class="mobile-hide">- LLM Farm</span></h2>
            <p class="text-muted">S·ª≠ d·ª•ng AI ƒë·ªÉ h·ªó tr·ª£ qu·∫£n l√Ω m·∫ßm non</p>
        </div>
    </div>

    <!-- AI Features Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-ai" 
                            type="button" role="tab" aria-controls="menu-ai" aria-selected="true">
                        <i class="fas fa-utensils"></i> <span class="d-none d-sm-inline">Menu AI</span><span class="d-sm-none">Menu</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum-ai" 
                            type="button" role="tab" aria-controls="curriculum-ai" aria-selected="false">
                        <i class="fas fa-graduation-cap"></i> <span class="d-none d-sm-inline">Ch∆∞∆°ng tr√¨nh h·ªçc AI</span><span class="d-sm-none">Ch∆∞∆°ng tr√¨nh</span>
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="aiTabsContent">
                <!-- Menu AI Tab -->
                <div class="tab-pane fade show active" id="menu-ai" role="tabpanel" aria-labelledby="menu-tab">
                    <div class="row mt-3">
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-utensils"></i> G·ª£i √Ω th·ª±c ƒë∆°n AI</h5>
                                </div>
                                <div class="card-body">
                                    <form id="menuSuggestionForm">
                                        <div class="mb-3">
                                            <label for="ageGroup" class="form-label">ƒê·ªô tu·ªïi</label>
                                            <select class="form-select" id="ageGroup" name="age_group">
                                                <option value="1-3 tu·ªïi" selected>1-3 tu·ªïi</option>
                                                <option value="3-5 tu·ªïi">3-5 tu·ªïi</option>
                                                <option value="1-5 tu·ªïi">1-5 tu·ªïi (ƒëa ƒë·ªô tu·ªïi)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="availableIngredients" class="form-label">Th·ª±c ph·∫©m c√≥ s·∫µn</label>
                                            <textarea class="form-control" id="availableIngredients" rows="3" 
                                                      placeholder="Nh·∫≠p th·ª±c ph·∫©m c√≥ s·∫µn, m·ªói lo·∫°i m·ªôt d√≤ng...&#10;VD: Th·ªãt heo, C√† r·ªët, C∆°m, Tr·ª©ng g√†"></textarea>
                                            <small class="form-text text-muted">AI s·∫Ω t·∫°o th·ª±c ƒë∆°n t·ª´ nguy√™n li·ªáu c√≥ s·∫µn</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="dietaryRequirements" class="form-label">Y√™u c·∫ßu ƒë·∫∑c bi·ªát</label>
                                            <input type="text" class="form-control" id="dietaryRequirements" 
                                                   placeholder="VD: kh√¥ng gluten, chay, d·ªã ·ª©ng s·ªØa...">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary" id="menuSubmitBtn">
                                                <i class="fas fa-magic"></i> T·∫°o th·ª±c ƒë∆°n AI
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Menu -->
                                    <div id="menuProgress" class="mt-3" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" style="width: 0%" id="menuProgressBar"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-1" id="menuProgressText">ƒêang kh·ªüi t·∫°o AI...</small>
                                    </div>
                                    
                                    <div id="menuResults" class="mt-3" style="display: none;">
                                        <h6>K·∫øt qu·∫£:</h6>
                                        <ul id="menuList" class="list-group"></ul>
                                        
                                        <!-- N√∫t t·∫°o th·ª±c ƒë∆°n m·ªõi -->
                                        <div class="mt-3 d-grid">
                                            <button type="button" class="btn btn-success" id="createMenuBtn" style="display: none;">
                                                <i class="fas fa-plus"></i> T·∫°o th·ª±c ƒë∆°n m·ªõi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Menu System Info -->
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5><i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n</h5>
                                </div>
                                <div class="card-body info-section">
                                    <h6><i class="fas fa-utensils"></i> Menu AI:</h6>
                                    <ul class="mb-3">
                                        <li>Ch·ªçn ƒë·ªô tu·ªïi tr·∫ª</li>
                                        <li>Nh·∫≠p nguy√™n li·ªáu c√≥ s·∫µn</li>
                                        <li>AI t·∫°o th·ª±c ƒë∆°n chi ti·∫øt (36 b·ªØa)</li>
                                        <li>B·∫•m "T·∫°o th·ª±c ƒë∆°n m·ªõi" ƒë·ªÉ l∆∞u</li>
                                    </ul>
                                    
                                    <h6><i class="fas fa-calendar-week"></i> Th·ª±c ƒë∆°n tu·∫ßn:</h6>
                                    <ul class="mb-3">
                                        <li><strong>6 ng√†y:</strong> Th·ª© 2 ‚Üí Th·ª© 7</li>
                                        <li><strong>6 khung gi·ªù/ng√†y</strong></li>
                                        <li><strong>T·ªïng:</strong> 36 b·ªØa ƒÉn</li>
                                    </ul>
                                    
                                    <h6 class="d-none d-md-block"><i class="fas fa-brain"></i> Gemini AI:</h6>
                                    <ul class="d-none d-md-block">
                                        <li><strong>Version:</strong> gemini-1.5-pro</li>
                                        <li><strong>Kh·∫£ nƒÉng:</strong> T·∫°o th·ª±c ƒë∆°n c√¢n b·∫±ng dinh d∆∞·ª°ng</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Curriculum AI Tab -->
                <div class="tab-pane fade" id="curriculum-ai" role="tabpanel" aria-labelledby="curriculum-tab">
                    <div class="row mt-3">
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="fas fa-graduation-cap"></i> Ch∆∞∆°ng tr√¨nh h·ªçc AI</h5>
                                </div>
                                <div class="card-body">
                                    <form id="curriculumSuggestionForm">
                                        <div class="mb-3">
                                            <label for="curriculumAgeGroup" class="form-label">ƒê·ªô tu·ªïi</label>
                                            <select class="form-select" id="curriculumAgeGroup" name="age_group">
                                                <option value="1-2 tu·ªïi">1-2 tu·ªïi</option>
                                                <option value="2-3 tu·ªïi" selected>2-3 tu·ªïi</option>
                                                <option value="3-4 tu·ªïi">3-4 tu·ªïi</option>
                                                <option value="4-5 tu·ªïi">4-5 tu·ªïi</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="weekNumber" class="form-label">Tu·∫ßn s·ªë</label>
                                            <input type="number" class="form-control" id="weekNumber" name="week_number" 
                                                   min="1" max="53" value="1" placeholder="Nh·∫≠p s·ªë tu·∫ßn (1-53)">
                                        </div>
                                        <div class="mb-3">
                                            <label for="themes" class="form-label">Ch·ªß ƒë·ªÅ tu·∫ßn <span class="text-muted">(t√πy ch·ªçn)</span></label>
                                            <input type="text" class="form-control" id="themes" name="themes" 
                                                   placeholder="VD: ƒê·ªông v·∫≠t, M√†u s·∫Øc, S·ªë ƒë·∫øm...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="specialFocus" class="form-label">Tr·ªçng t√¢m ƒë·∫∑c bi·ªát <span class="text-muted">(t√πy ch·ªçn)</span></label>
                                            <input type="text" class="form-control" id="specialFocus" name="special_focus" 
                                                   placeholder="VD: Ph√°t tri·ªÉn ng√¥n ng·ªØ, K·ªπ nƒÉng v·∫≠n ƒë·ªông...">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success" id="curriculumSubmitBtn">
                                                <i class="fas fa-brain"></i> T·∫°o ch∆∞∆°ng tr√¨nh AI
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Curriculum -->
                                    <div id="curriculumProgressContainer" style="display: none;" class="mt-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                 id="curriculumProgressBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="curriculumProgressText">ƒêang t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Curriculum Results -->
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5><i class="fas fa-list-alt"></i> K·∫øt qu·∫£</h5>
                                </div>
                                <div class="card-body">
                                    <div id="curriculumResults" class="d-none">
                                        <div class="mb-3">
                                            <h6><i class="fas fa-info-circle"></i> Th√¥ng tin tu·∫ßn:</h6>
                                            <div id="curriculumWeekInfo"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6><i class="fas fa-calendar-week"></i> Ho·∫°t ƒë·ªông t·ª´ng ng√†y:</h6>
                                            <div id="curriculumActivities" style="max-height: 250px; overflow-y: auto;"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6><i class="fas fa-tools"></i> V·∫≠t li·ªáu c·∫ßn thi·∫øt:</h6>
                                            <div id="curriculumMaterials"></div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary" id="createCurriculumBtn" style="display: none;">
                                                <i class="fas fa-plus"></i> T·∫°o ch∆∞∆°ng tr√¨nh h·ªçc
                                            </button>
                                        </div>
                                        
                                        <div id="curriculumCreateResult" class="mt-3" style="display: none;"></div>
                                    </div>
                                    
                                    <div id="curriculumPlaceholder">
                                        <p class="text-muted"><i class="fas fa-arrow-up d-md-none"></i><i class="fas fa-arrow-left d-none d-md-inline"></i> S·ª≠ d·ª•ng form ƒë·ªÉ t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc AI</p>
                                        <p><small>AI t·∫°o ch∆∞∆°ng tr√¨nh chi ti·∫øt cho 5 ng√†y (Th·ª© 2-6) v·ªõi ho·∫°t ƒë·ªông ph√π h·ª£p ƒë·ªô tu·ªïi.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-link"></i> Li√™n k·∫øt nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.menu') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-calendar-alt"></i><br><span class="d-none d-sm-inline">Xem </span>Th·ª±c ƒë∆°n
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.new_menu') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-plus"></i><br><span class="d-none d-sm-inline">T·∫°o </span>Th·ª±c ƒë∆°n
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.curriculum') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-graduation-cap"></i><br>Ch∆∞∆°ng tr√¨nh
                                <small class="d-block text-muted d-none d-sm-block">ü§ñ C√≥ AI</small>
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.new_curriculum') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-plus-circle"></i><br><span class="d-none d-sm-inline">T·∫°o </span>CT m·ªõi
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.suppliers') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-truck"></i><br><span class="d-none d-sm-inline">Nh√† </span>Cung c·∫•p
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.products') }}" class="btn btn-outline-dark w-100 mb-2">
                                <i class="fas fa-box"></i><br>S·∫£n ph·∫©m
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
        </div>
        <p class="mt-2">AI ƒëang x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Menu Suggestions
    let currentMenuData = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u data AI
    
    document.getElementById('menuSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('üî• [DEBUG] Form submitted!');
        
        showMenuProgress();
        
        const formData = {
            age_group: document.getElementById('ageGroup').value,
            available_ingredients: document.getElementById('availableIngredients').value,
            dietary_requirements: document.getElementById('dietaryRequirements').value,
            count: 5 // Fixed count
        };
        
        console.log('üìù [DEBUG] Form data:', formData);
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        // Fetch with CSRF token
        fetch('/ai/menu-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('üì° [DEBUG] Response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`üö´ ${data.error || 'Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server kh√¥ng tr·∫£ v·ªÅ JSON, c√≥ th·ªÉ b·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng c√≥ quy·ªÅn");
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ [DEBUG] Data received:', data);
            hideMenuProgress();
            if (data.success) {
                currentMenuData = data; // L∆∞u data ƒë·ªÉ t·∫°o menu sau
                displayMenuResults(data.suggestions);
            } else {
                console.error('‚ùå [DEBUG] Server error:', data.error);
                alert('L·ªói: ' + data.error);
            }
        })
        .catch(error => {
            console.error('üí• [DEBUG] Fetch error:', error);
            hideMenuProgress();
            console.error('Chi ti·∫øt l·ªói:', error);
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('üö´')) {
                // Rate limit or quota errors - show clean message without fallback
                alert(errorMsg.replace('üö´ ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('‚ö†Ô∏è API ƒë√£ h·∫øt quota ho·∫∑c qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
            } else {
                // Show fallback suggestions for network errors only
                const fallbackSuggestions = [
                    "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI",
                    "üîß Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng",
                    "üí° Th·ª≠ l·∫°i sau √≠t ph√∫t"
                ];
                displayMenuResults(fallbackSuggestions);
                alert('‚ö†Ô∏è L·ªói k·∫øt n·ªëi AI: ' + errorMsg);
            }
        });
    });

    // X·ª≠ l√Ω n√∫t t·∫°o th·ª±c ƒë∆°n m·ªõi
    document.getElementById('createMenuBtn').addEventListener('click', function() {
        if (!currentMenuData) {
            alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ª±c ƒë∆°n ƒë·ªÉ t·∫°o. Vui l√≤ng t·∫°o g·ª£i √Ω th·ª±c ƒë∆°n tr∆∞·ªõc.');
            return;
        }
        
        const confirmCreate = confirm('B·∫°n c√≥ mu·ªën t·∫°o th·ª±c ƒë∆°n m·ªõi cho tu·∫ßn hi·ªán t·∫°i t·ª´ k·∫øt qu·∫£ AI n√†y kh√¥ng?');
        if (!confirmCreate) return;
        
        // Hi·ªÉn th·ªã loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o th·ª±c ƒë∆°n...';
        btn.disabled = true;
        
        // G·ª≠i request t·∫°o menu
        const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
        
        function createMenu(overwrite = false) {
            const requestData = { ...currentMenuData, overwrite: overwrite };
            
            fetch('/ai/create-menu-from-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.status === 409) {
                    // Conflict - menu ƒë√£ t·ªìn t·∫°i
                    return response.json().then(data => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        const confirmOverwrite = confirm(
                            `${data.error}\n\nB·∫•m OK ƒë·ªÉ ghi ƒë√® th·ª±c ƒë∆°n hi·ªán c√≥, Cancel ƒë·ªÉ h·ªßy.`
                        );
                        
                        if (confirmOverwrite) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ghi ƒë√® th·ª±c ƒë∆°n...';
                            btn.disabled = true;
                            createMenu(true); // G·ªçi l·∫°i v·ªõi overwrite = true
                        }
                        return null;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    if (data.success) {
                        const message = data.overwritten 
                            ? `‚úÖ ƒê√£ c·∫≠p nh·∫≠t th·ª±c ƒë∆°n tu·∫ßn ${data.week_number} th√†nh c√¥ng!`
                            : `‚úÖ ƒê√£ t·∫°o th·ª±c ƒë∆°n tu·∫ßn ${data.week_number} th√†nh c√¥ng!`;
                        alert(message);
                        // Chuy·ªÉn ƒë·∫øn trang menu
                        window.location.href = '/menu';
                    } else {
                        alert('‚ùå L·ªói t·∫°o th·ª±c ƒë∆°n: ' + data.error);
                    }
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error('L·ªói:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            });
        }
        
        createMenu(); // B·∫Øt ƒë·∫ßu t·∫°o menu
    });



    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    // Progress Bar Functions for Menu
    function showMenuProgress() {
        // ·∫®n k·∫øt qu·∫£ c≈© v√† hi·ªán progress
        document.getElementById('menuResults').style.display = 'none';
        document.getElementById('menuProgress').style.display = 'block';
        document.getElementById('menuSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        
        let progress = 0;
        const messages = [
            'ƒêang kh·ªüi t·∫°o Gemini AI...',
            'ƒêang ph√¢n t√≠ch nguy√™n li·ªáu...',
            'ƒêang t·∫°o th·ª±c ƒë∆°n c√¢n b·∫±ng...',
            'ƒêang ki·ªÉm tra dinh d∆∞·ª°ng...',
            'Ho√†n t·∫•t!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20 + 15; // TƒÉng nhanh h∆°n 15-35%
            if (progress > 95) progress = 95; // G·∫ßn ho√†n t·∫•t
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 500); // TƒÉng t·ªëc ƒë·ªô c·∫≠p nh·∫≠t
        
        // L∆∞u interval ƒë·ªÉ c√≥ th·ªÉ clear sau
        window.menuProgressInterval = interval;
    }

    function hideMenuProgress() {
        // Clear interval v√† ·∫©n progress
        if (window.menuProgressInterval) {
            clearInterval(window.menuProgressInterval);
        }
        
        // Ho√†n th√†nh progress bar
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Ho√†n t·∫•t!';
        
        // ·∫®n sau 500ms
        setTimeout(() => {
            document.getElementById('menuProgress').style.display = 'none';
            document.getElementById('menuSubmitBtn').disabled = false;
        }, 500);
    }

    // Progress Bar Functions for Nutrition
    function showNutritionProgress() {
        document.getElementById('nutritionResults').style.display = 'none';
        document.getElementById('nutritionProgress').style.display = 'block';
        document.getElementById('nutritionSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        
        let progress = 0;
        const messages = [
            'ƒêang kh·ªüi t·∫°o Gemini AI...',
            'ƒêang ph√¢n t√≠ch th√†nh ph·∫ßn...',
            'ƒêang t√≠nh to√°n dinh d∆∞·ª°ng...',
            'ƒêang ƒë√°nh gi√° c√¢n b·∫±ng...',
            'Ho√†n t·∫•t ph√¢n t√≠ch!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 25 + 15; // TƒÉng nhanh 15-40%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 400); // Nhanh h∆°n
        
        window.nutritionProgressInterval = interval;
    }

    function hideNutritionProgress() {
        if (window.nutritionProgressInterval) {
            clearInterval(window.nutritionProgressInterval);
        }
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Ho√†n t·∫•t ph√¢n t√≠ch!';
        
        setTimeout(() => {
            document.getElementById('nutritionProgress').style.display = 'none';
            document.getElementById('nutritionSubmitBtn').disabled = false;
        }, 500);
    }

    function displayMenuResults(suggestions) {
        const resultDiv = document.getElementById('menuResults');
        const listElement = document.getElementById('menuList');
        const createBtn = document.getElementById('createMenuBtn');
        
        listElement.innerHTML = '';
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = suggestion;
            listElement.appendChild(li);
        });
        
        // Hi·ªÉn th·ªã n√∫t t·∫°o menu n·∫øu c√≥ d·ªØ li·ªáu AI h·ª£p l·ªá
        if (currentMenuData && currentMenuData.success) {
            createBtn.style.display = 'block';
        } else {
            createBtn.style.display = 'none';
        }
        
        resultDiv.style.display = 'block';
    }

    function displayNutritionResults(analysis) {
        const resultDiv = document.getElementById('nutritionResults');
        const contentDiv = document.getElementById('nutritionContent');
        
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Calo:</strong> ${analysis.calories}</p>
                    <p><strong>Protein:</strong> ${analysis.protein_percent}</p>
                    <p><strong>Carbohydrate:</strong> ${analysis.carb_percent}</p>
                    <p><strong>Ch·∫•t b√©o:</strong> ${analysis.fat_percent}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Vitamin & Kho√°ng ch·∫•t:</strong> ${analysis.vitamins}</p>
                    <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> 
                        <span class="badge ${analysis.overall_score >= 7 ? 'bg-success' : analysis.overall_score >= 5 ? 'bg-warning' : 'bg-danger'}">
                            ${analysis.overall_score}/10
                        </span>
                    </p>
                </div>
            </div>
            <div class="mt-2">
                <strong>G·ª£i √Ω c·∫£i thi·ªán:</strong>
                <p class="text-muted">${analysis.suggestions}</p>
            </div>
        `;
        
        resultDiv.style.display = 'block';
    }

    // ================================
    // CURRICULUM AI FUNCTIONALITY
    // ================================
    let currentCurriculumData = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u data Curriculum AI
    
    // Curriculum AI Form Handler
    document.getElementById('curriculumSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('üéì [DEBUG] Curriculum form submitted!');
        
        const formData = {
            age_group: document.getElementById('curriculumAgeGroup').value,
            week_number: parseInt(document.getElementById('weekNumber').value),
            themes: document.getElementById('themes').value,
            special_focus: document.getElementById('specialFocus').value
        };
        
        console.log('üìö [DEBUG] Curriculum form data:', formData);
        
        showCurriculumProgress();
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        fetch('/ai/curriculum-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('üéØ [DEBUG] Curriculum response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`üö´ ${data.error || 'Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server kh√¥ng tr·∫£ v·ªÅ JSON, c√≥ th·ªÉ b·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng c√≥ quy·ªÅn");
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ [DEBUG] Curriculum data received:', data);
            hideCurriculumProgress();
            
            if (data.success) {
                currentCurriculumData = data.curriculum_data; // L∆∞u data ƒë·ªÉ t·∫°o curriculum sau
                displayCurriculumResults(data.curriculum_data);
            } else {
                console.error('‚ùå [DEBUG] Curriculum server error:', data.error);
                alert('L·ªói: ' + data.error);
            }
        })
        .catch(error => {
            console.error('üí• [DEBUG] Curriculum fetch error:', error);
            hideCurriculumProgress();
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('üö´')) {
                // Rate limit or quota errors - show clean message
                alert(errorMsg.replace('üö´ ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('‚ö†Ô∏è API ƒë√£ h·∫øt quota ho·∫∑c qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
            } else {
                alert('‚ö†Ô∏è L·ªói k·∫øt n·ªëi AI: ' + errorMsg);
            }
        });
    });

    // Create Curriculum Button Handler
    document.getElementById('createCurriculumBtn').addEventListener('click', function() {
        if (!currentCurriculumData) {
            alert('Kh√¥ng c√≥ d·ªØ li·ªáu ch∆∞∆°ng tr√¨nh h·ªçc ƒë·ªÉ t·∫°o. Vui l√≤ng t·∫°o g·ª£i √Ω ch∆∞∆°ng tr√¨nh h·ªçc tr∆∞·ªõc.');
            return;
        }
        
        const confirmCreate = confirm('B·∫°n c√≥ mu·ªën t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc m·ªõi t·ª´ k·∫øt qu·∫£ AI n√†y kh√¥ng?');
        if (!confirmCreate) return;
        
        // Hi·ªÉn th·ªã loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o ch∆∞∆°ng tr√¨nh...';
        btn.disabled = true;
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        fetch('/ai/create-curriculum-from-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                curriculum_data: currentCurriculumData
            })
        })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (data.success) {
                const resultDiv = document.getElementById('curriculumCreateResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc th√†nh c√¥ng!
                        <br><small>Tu·∫ßn ${currentCurriculumData.week_number} - ${currentCurriculumData.age_group}</small>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // Optionally redirect to curriculum page
                setTimeout(() => {
                    if (confirm('Chuy·ªÉn ƒë·∫øn trang ch∆∞∆°ng tr√¨nh h·ªçc ƒë·ªÉ xem k·∫øt qu·∫£?')) {
                        window.location.href = '/curriculum';
                    }
                }, 2000);
            } else {
                alert('‚ùå L·ªói t·∫°o ch∆∞∆°ng tr√¨nh h·ªçc: ' + data.error);
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error('L·ªói:', error);
            alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
        });
    });

    // Curriculum Progress Functions
    function showCurriculumProgress() {
        const progressContainer = document.getElementById('curriculumProgressContainer');
        const resultsContainer = document.getElementById('curriculumResults');
        const placeholder = document.getElementById('curriculumPlaceholder');
        const submitBtn = document.getElementById('curriculumSubmitBtn');
        
        // Hide results and show progress
        resultsContainer.classList.add('d-none');
        placeholder.style.display = 'none';
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';
        
        const progressBar = document.getElementById('curriculumProgressBar');
        const progressText = document.getElementById('curriculumProgressText');
        
        let progress = 0;
        const messages = [
            'Kh·ªüi t·∫°o Gemini AI...',
            'Ph√¢n t√≠ch ƒë·ªô tu·ªïi...',
            'T·∫°o ho·∫°t ƒë·ªông gi√°o d·ª•c...',
            'C√¢n b·∫±ng n·ªôi dung...',
            'Ho√†n thi·ªán ch∆∞∆°ng tr√¨nh...'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 18 + 12; // TƒÉng 12-30%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 600); // Slow interval cho curriculum
        
        window.curriculumProgressInterval = interval;
    }

    function hideCurriculumProgress() {
        if (window.curriculumProgressInterval) {
            clearInterval(window.curriculumProgressInterval);
        }
        
        const progressBar = document.getElementById('curriculumProgressBar');
        const progressText = document.getElementById('curriculumProgressText');
        const submitBtn = document.getElementById('curriculumSubmitBtn');
        
        progressBar.style.width = '100%';
        progressText.textContent = 'Ho√†n th√†nh!';
        
        setTimeout(() => {
            document.getElementById('curriculumProgressContainer').style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-brain"></i> T·∫°o ch∆∞∆°ng tr√¨nh h·ªçc t·ª´ AI';
        }, 800);
    }

    function displayCurriculumResults(curriculumData) {
        console.log('üìä [DEBUG] Displaying curriculum results:', curriculumData);
        
        // Show week info
        document.getElementById('curriculumWeekInfo').innerHTML = `
            <div class="card bg-light">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong><i class="fas fa-calendar-week"></i> Tu·∫ßn ${curriculumData.week_number}</strong><br>
                            <span class="badge bg-primary">${curriculumData.age_group}</span>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Ch·ªß ƒë·ªÅ:</strong> ${curriculumData.themes || 'Kh√¥ng c√≥ ch·ªß ƒë·ªÅ ƒë·∫∑c bi·ªát'}<br>
                                <strong>Tr·ªçng t√¢m:</strong> ${curriculumData.special_focus || 'Ph√°t tri·ªÉn to√†n di·ªán'}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Display daily activities
        const activitiesContainer = document.getElementById('curriculumActivities');
        activitiesContainer.innerHTML = '';
        
        if (curriculumData.daily_activities && curriculumData.daily_activities.length > 0) {
            curriculumData.daily_activities.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mb-3';
                dayDiv.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white py-2">
                            <strong><i class="fas fa-calendar-day"></i> ${day.day}</strong>
                        </div>
                        <div class="card-body p-2">
                            ${day.activities && day.activities.length > 0 ? 
                                day.activities.map(activity => `
                                    <div class="border-bottom pb-2 mb-2 last:border-0">
                                        <div class="d-flex align-items-start">
                                            <span class="badge bg-info me-2">${activity.time}</span>
                                            <div class="flex-grow-1">
                                                <strong>${activity.activity}</strong><br>
                                                <small class="text-muted">${activity.description}</small>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') 
                                : '<p class="text-muted">Ch∆∞a c√≥ ho·∫°t ƒë·ªông cho ng√†y n√†y</p>'
                            }
                        </div>
                    </div>
                `;
                activitiesContainer.appendChild(dayDiv);
            });
        } else {
            activitiesContainer.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫°t ƒë·ªông h√†ng ng√†y</p>';
        }
        
        // Display materials
        const materialsContainer = document.getElementById('curriculumMaterials');
        if (curriculumData.materials && curriculumData.materials.length > 0) {
            materialsContainer.innerHTML = `
                <div class="card bg-light">
                    <div class="card-body p-2">
                        <ul class="mb-0">
                            ${curriculumData.materials.map(material => `<li><i class="fas fa-check text-success"></i> ${material}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        } else {
            materialsContainer.innerHTML = '<p class="text-muted"><i class="fas fa-info-circle"></i> Kh√¥ng c√≥ v·∫≠t li·ªáu ƒë·∫∑c bi·ªát</p>';
        }
        
        // Show results container and create button
        document.getElementById('curriculumResults').classList.remove('d-none');
        document.getElementById('createCurriculumBtn').style.display = 'block';
        
        // Hide placeholder
        document.getElementById('curriculumPlaceholder').style.display = 'none';
    }

    // ================================
    // URL PARAMETER HANDLING FOR TAB SWITCHING
    // ================================
    
    // Check URL parameters to auto-switch tabs
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'curriculum') {
        // Switch to curriculum tab
        console.log('üéØ [TAB SWITCH] Auto-switching to Curriculum AI tab');
        
        // Deactivate menu tab
        document.getElementById('menu-tab').classList.remove('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'false');
        document.getElementById('menu-ai').classList.remove('show', 'active');
        
        // Activate curriculum tab
        document.getElementById('curriculum-tab').classList.add('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'true');
        document.getElementById('curriculum-ai').classList.add('show', 'active');
        
        console.log('‚úÖ [TAB SWITCH] Successfully switched to Curriculum AI tab');
        
    } else if (tabParam === 'menu') {
        // Ensure menu tab is active (default behavior but explicit)
        console.log('üéØ [TAB SWITCH] Staying on Menu AI tab (default)');
        
        // Activate menu tab (redundant but explicit)
        document.getElementById('menu-tab').classList.add('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'true');
        document.getElementById('menu-ai').classList.add('show', 'active');
        
        // Deactivate curriculum tab
        document.getElementById('curriculum-tab').classList.remove('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'false');
        document.getElementById('curriculum-ai').classList.remove('show', 'active');
        
        console.log('‚úÖ [TAB SWITCH] Menu AI tab is active');
    }
    
    // Clean URL after processing (remove tab parameter)
    if (tabParam) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }


});
</script>
{% endblock %}
