{% extends "base.html" %}

{% block title %}AI Dashboard - LLM Farm{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Mobile Responsive CSS -->
<style>
    /* Mobile Optimization */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* Responsive tabs */
        .nav-tabs {
            flex-wrap: wrap;
        }
        
        .nav-tabs .nav-link {
            font-size: 14px;
            padding: 8px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Responsive cards */
        .card {
            margin-bottom: 15px;
        }
        
        .card-header h5 {
            font-size: 16px;
            margin-bottom: 0;
        }
        
        /* Responsive form elements */
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Responsive buttons */
        .btn {
            font-size: 14px;
            padding: 10px 15px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-group-mobile {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Hide long text on mobile */
        .mobile-hide {
            display: none;
        }
        
        /* Responsive progress bars */
        .progress {
            height: 25px;
        }
        
        /* Responsive list items */
        .list-group-item {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* Responsive info sections */
        .info-section {
            font-size: 13px;
        }
        
        .info-section ul li {
            margin-bottom: 5px;
        }
        
        /* Better spacing for mobile */
        .mt-4 {
            margin-top: 20px !important;
        }
        
        .mb-3 {
            margin-bottom: 15px !important;
        }
        
        /* Responsive text */
        h2 {
            font-size: 24px;
        }
        
        h5 {
            font-size: 16px;
        }
        
        h6 {
            font-size: 14px;
        }
        
        /* Mobile-specific layout */
        .mobile-col {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        /* Responsive textarea */
        textarea.form-control {
            min-height: 80px;
            font-size: 14px;
        }
        
        /* Better touch targets */
        .nav-link {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive alerts */
        .alert {
            font-size: 14px;
            padding: 10px;
        }
    }
    
    /* Small mobile devices */
    @media (max-width: 576px) {
        .nav-tabs .nav-link {
            font-size: 12px;
            padding: 6px 8px;
            max-width: 140px;
        }
        
        .nav-tabs .nav-link i {
            display: none; /* Hide icons on very small screens */
        }
        
        h2 {
            font-size: 20px;
        }
        
        .card-header h5 {
            font-size: 14px;
        }
    }
    
    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .nav-tabs .nav-link {
            font-size: 13px;
            padding: 6px 10px;
        }
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-robot"></i> AI Dashboard <span class="mobile-hide">- LLM Farm</span></h2>
            <p class="text-muted">Sử dụng AI để hỗ trợ quản lý mầm non</p>
        </div>
    </div>

    <!-- AI Features Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-ai" 
                            type="button" role="tab" aria-controls="menu-ai" aria-selected="true">
                        <i class="fas fa-utensils"></i> <span class="d-none d-sm-inline">Menu AI</span><span class="d-sm-none">Menu</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum-ai" 
                            type="button" role="tab" aria-controls="curriculum-ai" aria-selected="false">
                        <i class="fas fa-graduation-cap"></i> <span class="d-none d-sm-inline">Chương trình học AI</span><span class="d-sm-none">Chương trình</span>
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="aiTabsContent">
                <!-- Menu AI Tab -->
                <div class="tab-pane fade show active" id="menu-ai" role="tabpanel" aria-labelledby="menu-tab">
                    <div class="row mt-3">
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-utensils"></i> Gợi ý thực đơn AI</h5>
                                </div>
                                <div class="card-body">
                                    <form id="menuSuggestionForm">
                                        <div class="mb-3">
                                            <label for="ageGroup" class="form-label">Độ tuổi</label>
                                            <select class="form-select" id="ageGroup" name="age_group">
                                                <option value="1-3 tuổi" selected>1-3 tuổi</option>
                                                <option value="3-5 tuổi">3-5 tuổi</option>
                                                <option value="1-5 tuổi">1-5 tuổi (đa độ tuổi)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="availableIngredients" class="form-label">Thực phẩm có sẵn</label>
                                            <textarea class="form-control" id="availableIngredients" rows="3" 
                                                      placeholder="Nhập thực phẩm có sẵn, mỗi loại một dòng...&#10;VD: Thịt heo, Cà rốt, Cơm, Trứng gà"></textarea>
                                            <small class="form-text text-muted">AI sẽ tạo thực đơn từ nguyên liệu có sẵn</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="dietaryRequirements" class="form-label">Yêu cầu đặc biệt</label>
                                            <input type="text" class="form-control" id="dietaryRequirements" 
                                                   placeholder="VD: không gluten, chay, dị ứng sữa...">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary" id="menuSubmitBtn">
                                                <i class="fas fa-magic"></i> Tạo thực đơn AI
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Menu -->
                                    <div id="menuProgress" class="mt-3" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" style="width: 0%" id="menuProgressBar"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-1" id="menuProgressText">Đang khởi tạo AI...</small>
                                    </div>
                                    
                                    <div id="menuResults" class="mt-3" style="display: none;">
                                        <h6>Kết quả:</h6>
                                        <ul id="menuList" class="list-group"></ul>
                                        
                                        <!-- Nút tạo thực đơn mới -->
                                        <div class="mt-3 d-grid">
                                            <button type="button" class="btn btn-success" id="createMenuBtn" style="display: none;">
                                                <i class="fas fa-plus"></i> Tạo thực đơn mới
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Menu System Info -->
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5><i class="fas fa-info-circle"></i> Hướng dẫn</h5>
                                </div>
                                <div class="card-body info-section">
                                    <h6><i class="fas fa-utensils"></i> Menu AI:</h6>
                                    <ul class="mb-3">
                                        <li>Chọn độ tuổi trẻ</li>
                                        <li>Nhập nguyên liệu có sẵn</li>
                                        <li>AI tạo thực đơn chi tiết (36 bữa)</li>
                                        <li>Bấm "Tạo thực đơn mới" để lưu</li>
                                    </ul>
                                    
                                    <h6><i class="fas fa-calendar-week"></i> Thực đơn tuần:</h6>
                                    <ul class="mb-3">
                                        <li><strong>6 ngày:</strong> Thứ 2 → Thứ 7</li>
                                        <li><strong>6 khung giờ/ngày</strong></li>
                                        <li><strong>Tổng:</strong> 36 bữa ăn</li>
                                    </ul>
                                    
                                    <h6 class="d-none d-md-block"><i class="fas fa-brain"></i> Gemini AI:</h6>
                                    <ul class="d-none d-md-block">
                                        <li><strong>Version:</strong> gemini-1.5-pro</li>
                                        <li><strong>Khả năng:</strong> Tạo thực đơn cân bằng dinh dưỡng</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Curriculum AI Tab -->
                <div class="tab-pane fade" id="curriculum-ai" role="tabpanel" aria-labelledby="curriculum-tab">
                    <div class="row mt-3">
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="fas fa-graduation-cap"></i> Chương trình học AI</h5>
                                </div>
                                <div class="card-body">
                                    <form id="curriculumSuggestionForm">
                                        <div class="mb-3">
                                            <label for="curriculumAgeGroup" class="form-label">Độ tuổi</label>
                                            <select class="form-select" id="curriculumAgeGroup" name="age_group">
                                                <option value="1-2 tuổi">1-2 tuổi</option>
                                                <option value="2-3 tuổi" selected>2-3 tuổi</option>
                                                <option value="3-4 tuổi">3-4 tuổi</option>
                                                <option value="4-5 tuổi">4-5 tuổi</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="weekNumber" class="form-label">Tuần số</label>
                                            <input type="number" class="form-control" id="weekNumber" name="week_number" 
                                                   min="1" max="53" value="1" placeholder="Nhập số tuần (1-53)">
                                        </div>
                                        <div class="mb-3">
                                            <label for="themes" class="form-label">Chủ đề tuần <span class="text-muted">(tùy chọn)</span></label>
                                            <input type="text" class="form-control" id="themes" name="themes" 
                                                   placeholder="VD: Động vật, Màu sắc, Số đếm...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="specialFocus" class="form-label">Trọng tâm đặc biệt <span class="text-muted">(tùy chọn)</span></label>
                                            <input type="text" class="form-control" id="specialFocus" name="special_focus" 
                                                   placeholder="VD: Phát triển ngôn ngữ, Kỹ năng vận động...">
                                        </div>
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-success" id="curriculumSubmitBtn">
                                                <i class="fas fa-brain"></i> Tạo chương trình AI
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Curriculum -->
                                    <div id="curriculumProgressContainer" style="display: none;" class="mt-3">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                                 id="curriculumProgressBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted mt-1 d-block" id="curriculumProgressText">Đang tạo chương trình học...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Curriculum Results -->
                        <div class="col-lg-6 col-12 mobile-col">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5><i class="fas fa-list-alt"></i> Kết quả</h5>
                                </div>
                                <div class="card-body">
                                    <div id="curriculumResults" class="d-none">
                                        <div class="mb-3">
                                            <h6><i class="fas fa-info-circle"></i> Thông tin tuần:</h6>
                                            <div id="curriculumWeekInfo"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6><i class="fas fa-calendar-week"></i> Hoạt động từng ngày:</h6>
                                            <div id="curriculumActivities" style="max-height: 250px; overflow-y: auto;"></div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h6><i class="fas fa-tools"></i> Vật liệu cần thiết:</h6>
                                            <div id="curriculumMaterials"></div>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button class="btn btn-primary" id="createCurriculumBtn" style="display: none;">
                                                <i class="fas fa-plus"></i> Tạo chương trình học
                                            </button>
                                        </div>
                                        
                                        <div id="curriculumCreateResult" class="mt-3" style="display: none;"></div>
                                    </div>
                                    
                                    <div id="curriculumPlaceholder">
                                        <p class="text-muted"><i class="fas fa-arrow-up d-md-none"></i><i class="fas fa-arrow-left d-none d-md-inline"></i> Sử dụng form để tạo chương trình học AI</p>
                                        <p><small>AI tạo chương trình chi tiết cho 5 ngày (Thứ 2-6) với hoạt động phù hợp độ tuổi.</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-link"></i> Liên kết nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.menu') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-calendar-alt"></i><br><span class="d-none d-sm-inline">Xem </span>Thực đơn
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.new_menu') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-plus"></i><br><span class="d-none d-sm-inline">Tạo </span>Thực đơn
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.curriculum') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-graduation-cap"></i><br>Chương trình
                                <small class="d-block text-muted d-none d-sm-block">🤖 Có AI</small>
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.new_curriculum') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-plus-circle"></i><br><span class="d-none d-sm-inline">Tạo </span>CT mới
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.suppliers') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-truck"></i><br><span class="d-none d-sm-inline">Nhà </span>Cung cấp
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.products') }}" class="btn btn-outline-dark w-100 mb-2">
                                <i class="fas fa-box"></i><br>Sản phẩm
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang xử lý...</span>
        </div>
        <p class="mt-2">AI đang xử lý yêu cầu của bạn...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Menu Suggestions
    let currentMenuData = null; // Biến toàn cục để lưu data AI
    
    document.getElementById('menuSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('🔥 [DEBUG] Form submitted!');
        
        showMenuProgress();
        
        const formData = {
            age_group: document.getElementById('ageGroup').value,
            available_ingredients: document.getElementById('availableIngredients').value,
            dietary_requirements: document.getElementById('dietaryRequirements').value,
            count: 5 // Fixed count
        };
        
        console.log('📝 [DEBUG] Form data:', formData);
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        // Fetch with CSRF token
        fetch('/ai/menu-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('📡 [DEBUG] Response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`🚫 ${data.error || 'Quá nhiều yêu cầu. Vui lòng thử lại sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server không trả về JSON, có thể bạn chưa đăng nhập hoặc không có quyền");
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ [DEBUG] Data received:', data);
            hideMenuProgress();
            if (data.success) {
                currentMenuData = data; // Lưu data để tạo menu sau
                displayMenuResults(data.suggestions);
            } else {
                console.error('❌ [DEBUG] Server error:', data.error);
                alert('Lỗi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('💥 [DEBUG] Fetch error:', error);
            hideMenuProgress();
            console.error('Chi tiết lỗi:', error);
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('🚫')) {
                // Rate limit or quota errors - show clean message without fallback
                alert(errorMsg.replace('🚫 ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('⚠️ API đã hết quota hoặc quá tải. Vui lòng thử lại sau.');
            } else {
                // Show fallback suggestions for network errors only
                const fallbackSuggestions = [
                    "❌ Không thể kết nối với AI",
                    "🔧 Vui lòng kiểm tra kết nối mạng",
                    "💡 Thử lại sau ít phút"
                ];
                displayMenuResults(fallbackSuggestions);
                alert('⚠️ Lỗi kết nối AI: ' + errorMsg);
            }
        });
    });

    // Xử lý nút tạo thực đơn mới
    document.getElementById('createMenuBtn').addEventListener('click', function() {
        if (!currentMenuData) {
            alert('Không có dữ liệu thực đơn để tạo. Vui lòng tạo gợi ý thực đơn trước.');
            return;
        }
        
        const confirmCreate = confirm('Bạn có muốn tạo thực đơn mới cho tuần hiện tại từ kết quả AI này không?');
        if (!confirmCreate) return;
        
        // Hiển thị loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo thực đơn...';
        btn.disabled = true;
        
        // Gửi request tạo menu
        const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
        
        function createMenu(overwrite = false) {
            const requestData = { ...currentMenuData, overwrite: overwrite };
            
            fetch('/ai/create-menu-from-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.status === 409) {
                    // Conflict - menu đã tồn tại
                    return response.json().then(data => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        const confirmOverwrite = confirm(
                            `${data.error}\n\nBấm OK để ghi đè thực đơn hiện có, Cancel để hủy.`
                        );
                        
                        if (confirmOverwrite) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang ghi đè thực đơn...';
                            btn.disabled = true;
                            createMenu(true); // Gọi lại với overwrite = true
                        }
                        return null;
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    if (data.success) {
                        const message = data.overwritten 
                            ? `✅ Đã cập nhật thực đơn tuần ${data.week_number} thành công!`
                            : `✅ Đã tạo thực đơn tuần ${data.week_number} thành công!`;
                        alert(message);
                        // Chuyển đến trang menu
                        window.location.href = '/menu';
                    } else {
                        alert('❌ Lỗi tạo thực đơn: ' + data.error);
                    }
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error('Lỗi:', error);
                alert('❌ Lỗi kết nối: ' + error.message);
            });
        }
        
        createMenu(); // Bắt đầu tạo menu
    });



    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    // Progress Bar Functions for Menu
    function showMenuProgress() {
        // Ẩn kết quả cũ và hiện progress
        document.getElementById('menuResults').style.display = 'none';
        document.getElementById('menuProgress').style.display = 'block';
        document.getElementById('menuSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        
        let progress = 0;
        const messages = [
            'Đang khởi tạo Gemini AI...',
            'Đang phân tích nguyên liệu...',
            'Đang tạo thực đơn cân bằng...',
            'Đang kiểm tra dinh dưỡng...',
            'Hoàn tất!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20 + 15; // Tăng nhanh hơn 15-35%
            if (progress > 95) progress = 95; // Gần hoàn tất
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 500); // Tăng tốc độ cập nhật
        
        // Lưu interval để có thể clear sau
        window.menuProgressInterval = interval;
    }

    function hideMenuProgress() {
        // Clear interval và ẩn progress
        if (window.menuProgressInterval) {
            clearInterval(window.menuProgressInterval);
        }
        
        // Hoàn thành progress bar
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Hoàn tất!';
        
        // Ẩn sau 500ms
        setTimeout(() => {
            document.getElementById('menuProgress').style.display = 'none';
            document.getElementById('menuSubmitBtn').disabled = false;
        }, 500);
    }

    // Progress Bar Functions for Nutrition
    function showNutritionProgress() {
        document.getElementById('nutritionResults').style.display = 'none';
        document.getElementById('nutritionProgress').style.display = 'block';
        document.getElementById('nutritionSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        
        let progress = 0;
        const messages = [
            'Đang khởi tạo Gemini AI...',
            'Đang phân tích thành phần...',
            'Đang tính toán dinh dưỡng...',
            'Đang đánh giá cân bằng...',
            'Hoàn tất phân tích!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 25 + 15; // Tăng nhanh 15-40%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 400); // Nhanh hơn
        
        window.nutritionProgressInterval = interval;
    }

    function hideNutritionProgress() {
        if (window.nutritionProgressInterval) {
            clearInterval(window.nutritionProgressInterval);
        }
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Hoàn tất phân tích!';
        
        setTimeout(() => {
            document.getElementById('nutritionProgress').style.display = 'none';
            document.getElementById('nutritionSubmitBtn').disabled = false;
        }, 500);
    }

    function displayMenuResults(suggestions) {
        const resultDiv = document.getElementById('menuResults');
        const listElement = document.getElementById('menuList');
        const createBtn = document.getElementById('createMenuBtn');
        
        listElement.innerHTML = '';
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = suggestion;
            listElement.appendChild(li);
        });
        
        // Hiển thị nút tạo menu nếu có dữ liệu AI hợp lệ
        if (currentMenuData && currentMenuData.success) {
            createBtn.style.display = 'block';
        } else {
            createBtn.style.display = 'none';
        }
        
        resultDiv.style.display = 'block';
    }

    function displayNutritionResults(analysis) {
        const resultDiv = document.getElementById('nutritionResults');
        const contentDiv = document.getElementById('nutritionContent');
        
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Calo:</strong> ${analysis.calories}</p>
                    <p><strong>Protein:</strong> ${analysis.protein_percent}</p>
                    <p><strong>Carbohydrate:</strong> ${analysis.carb_percent}</p>
                    <p><strong>Chất béo:</strong> ${analysis.fat_percent}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Vitamin & Khoáng chất:</strong> ${analysis.vitamins}</p>
                    <p><strong>Điểm đánh giá:</strong> 
                        <span class="badge ${analysis.overall_score >= 7 ? 'bg-success' : analysis.overall_score >= 5 ? 'bg-warning' : 'bg-danger'}">
                            ${analysis.overall_score}/10
                        </span>
                    </p>
                </div>
            </div>
            <div class="mt-2">
                <strong>Gợi ý cải thiện:</strong>
                <p class="text-muted">${analysis.suggestions}</p>
            </div>
        `;
        
        resultDiv.style.display = 'block';
    }

    // ================================
    // CURRICULUM AI FUNCTIONALITY
    // ================================
    let currentCurriculumData = null; // Biến toàn cục để lưu data Curriculum AI
    
    // Curriculum AI Form Handler
    document.getElementById('curriculumSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('🎓 [DEBUG] Curriculum form submitted!');
        
        const formData = {
            age_group: document.getElementById('curriculumAgeGroup').value,
            week_number: parseInt(document.getElementById('weekNumber').value),
            themes: document.getElementById('themes').value,
            special_focus: document.getElementById('specialFocus').value
        };
        
        console.log('📚 [DEBUG] Curriculum form data:', formData);
        
        showCurriculumProgress();
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        fetch('/ai/curriculum-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('🎯 [DEBUG] Curriculum response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`🚫 ${data.error || 'Quá nhiều yêu cầu. Vui lòng thử lại sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server không trả về JSON, có thể bạn chưa đăng nhập hoặc không có quyền");
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ [DEBUG] Curriculum data received:', data);
            hideCurriculumProgress();
            
            if (data.success) {
                currentCurriculumData = data.curriculum_data; // Lưu data để tạo curriculum sau
                displayCurriculumResults(data.curriculum_data);
            } else {
                console.error('❌ [DEBUG] Curriculum server error:', data.error);
                alert('Lỗi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('💥 [DEBUG] Curriculum fetch error:', error);
            hideCurriculumProgress();
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('🚫')) {
                // Rate limit or quota errors - show clean message
                alert(errorMsg.replace('🚫 ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('⚠️ API đã hết quota hoặc quá tải. Vui lòng thử lại sau.');
            } else {
                alert('⚠️ Lỗi kết nối AI: ' + errorMsg);
            }
        });
    });

    // Create Curriculum Button Handler
    document.getElementById('createCurriculumBtn').addEventListener('click', function() {
        if (!currentCurriculumData) {
            alert('Không có dữ liệu chương trình học để tạo. Vui lòng tạo gợi ý chương trình học trước.');
            return;
        }
        
        const confirmCreate = confirm('Bạn có muốn tạo chương trình học mới từ kết quả AI này không?');
        if (!confirmCreate) return;
        
        // Hiển thị loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo chương trình...';
        btn.disabled = true;
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        fetch('/ai/create-curriculum-from-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                curriculum_data: currentCurriculumData
            })
        })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            if (data.success) {
                const resultDiv = document.getElementById('curriculumCreateResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Đã tạo chương trình học thành công!
                        <br><small>Tuần ${currentCurriculumData.week_number} - ${currentCurriculumData.age_group}</small>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // Optionally redirect to curriculum page
                setTimeout(() => {
                    if (confirm('Chuyển đến trang chương trình học để xem kết quả?')) {
                        window.location.href = '/curriculum';
                    }
                }, 2000);
            } else {
                alert('❌ Lỗi tạo chương trình học: ' + data.error);
            }
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error('Lỗi:', error);
            alert('❌ Lỗi kết nối: ' + error.message);
        });
    });

    // Curriculum Progress Functions
    function showCurriculumProgress() {
        const progressContainer = document.getElementById('curriculumProgressContainer');
        const resultsContainer = document.getElementById('curriculumResults');
        const placeholder = document.getElementById('curriculumPlaceholder');
        const submitBtn = document.getElementById('curriculumSubmitBtn');
        
        // Hide results and show progress
        resultsContainer.classList.add('d-none');
        placeholder.style.display = 'none';
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';
        
        const progressBar = document.getElementById('curriculumProgressBar');
        const progressText = document.getElementById('curriculumProgressText');
        
        let progress = 0;
        const messages = [
            'Khởi tạo Gemini AI...',
            'Phân tích độ tuổi...',
            'Tạo hoạt động giáo dục...',
            'Cân bằng nội dung...',
            'Hoàn thiện chương trình...'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 18 + 12; // Tăng 12-30%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 600); // Slow interval cho curriculum
        
        window.curriculumProgressInterval = interval;
    }

    function hideCurriculumProgress() {
        if (window.curriculumProgressInterval) {
            clearInterval(window.curriculumProgressInterval);
        }
        
        const progressBar = document.getElementById('curriculumProgressBar');
        const progressText = document.getElementById('curriculumProgressText');
        const submitBtn = document.getElementById('curriculumSubmitBtn');
        
        progressBar.style.width = '100%';
        progressText.textContent = 'Hoàn thành!';
        
        setTimeout(() => {
            document.getElementById('curriculumProgressContainer').style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-brain"></i> Tạo chương trình học từ AI';
        }, 800);
    }

    function displayCurriculumResults(curriculumData) {
        console.log('📊 [DEBUG] Displaying curriculum results:', curriculumData);
        
        // Show week info
        document.getElementById('curriculumWeekInfo').innerHTML = `
            <div class="card bg-light">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong><i class="fas fa-calendar-week"></i> Tuần ${curriculumData.week_number}</strong><br>
                            <span class="badge bg-primary">${curriculumData.age_group}</span>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Chủ đề:</strong> ${curriculumData.themes || 'Không có chủ đề đặc biệt'}<br>
                                <strong>Trọng tâm:</strong> ${curriculumData.special_focus || 'Phát triển toàn diện'}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Display daily activities
        const activitiesContainer = document.getElementById('curriculumActivities');
        activitiesContainer.innerHTML = '';
        
        if (curriculumData.daily_activities && curriculumData.daily_activities.length > 0) {
            curriculumData.daily_activities.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mb-3';
                dayDiv.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white py-2">
                            <strong><i class="fas fa-calendar-day"></i> ${day.day}</strong>
                        </div>
                        <div class="card-body p-2">
                            ${day.activities && day.activities.length > 0 ? 
                                day.activities.map(activity => `
                                    <div class="border-bottom pb-2 mb-2 last:border-0">
                                        <div class="d-flex align-items-start">
                                            <span class="badge bg-info me-2">${activity.time}</span>
                                            <div class="flex-grow-1">
                                                <strong>${activity.activity}</strong><br>
                                                <small class="text-muted">${activity.description}</small>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') 
                                : '<p class="text-muted">Chưa có hoạt động cho ngày này</p>'
                            }
                        </div>
                    </div>
                `;
                activitiesContainer.appendChild(dayDiv);
            });
        } else {
            activitiesContainer.innerHTML = '<p class="text-muted">Không có dữ liệu hoạt động hàng ngày</p>';
        }
        
        // Display materials
        const materialsContainer = document.getElementById('curriculumMaterials');
        if (curriculumData.materials && curriculumData.materials.length > 0) {
            materialsContainer.innerHTML = `
                <div class="card bg-light">
                    <div class="card-body p-2">
                        <ul class="mb-0">
                            ${curriculumData.materials.map(material => `<li><i class="fas fa-check text-success"></i> ${material}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        } else {
            materialsContainer.innerHTML = '<p class="text-muted"><i class="fas fa-info-circle"></i> Không có vật liệu đặc biệt</p>';
        }
        
        // Show results container and create button
        document.getElementById('curriculumResults').classList.remove('d-none');
        document.getElementById('createCurriculumBtn').style.display = 'block';
        
        // Hide placeholder
        document.getElementById('curriculumPlaceholder').style.display = 'none';
    }

    // ================================
    // URL PARAMETER HANDLING FOR TAB SWITCHING
    // ================================
    
    // Check URL parameters to auto-switch tabs
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'curriculum') {
        // Switch to curriculum tab
        console.log('🎯 [TAB SWITCH] Auto-switching to Curriculum AI tab');
        
        // Deactivate menu tab
        document.getElementById('menu-tab').classList.remove('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'false');
        document.getElementById('menu-ai').classList.remove('show', 'active');
        
        // Activate curriculum tab
        document.getElementById('curriculum-tab').classList.add('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'true');
        document.getElementById('curriculum-ai').classList.add('show', 'active');
        
        console.log('✅ [TAB SWITCH] Successfully switched to Curriculum AI tab');
        
    } else if (tabParam === 'menu') {
        // Ensure menu tab is active (default behavior but explicit)
        console.log('🎯 [TAB SWITCH] Staying on Menu AI tab (default)');
        
        // Activate menu tab (redundant but explicit)
        document.getElementById('menu-tab').classList.add('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'true');
        document.getElementById('menu-ai').classList.add('show', 'active');
        
        // Deactivate curriculum tab
        document.getElementById('curriculum-tab').classList.remove('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'false');
        document.getElementById('curriculum-ai').classList.remove('show', 'active');
        
        console.log('✅ [TAB SWITCH] Menu AI tab is active');
    }
    
    // Clean URL after processing (remove tab parameter)
    if (tabParam) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }


});
</script>
{% endblock %}
