{% extends "base.html" %}

{% block title %}AI Dashboard - SMALL TREE{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Mobile Responsive CSS -->
<style>
    /* Mobile Optimization */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* Responsive tabs */
        .nav-tabs {
            flex-wrap: wrap;
        }
        
        .nav-tabs .nav-link {
            font-size: 14px;
            padding: 8px 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Responsive cards */
        .card {
            margin-bottom: 15px;
        }
        
        .card-header h5 {
            font-size: 16px;
            margin-bottom: 0;
        }
        
        /* Responsive form elements */
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Responsive buttons */
        .btn {
            font-size: 14px;
            padding: 10px 15px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-group-mobile {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Hide long text on mobile */
        .mobile-hide {
            display: none;
        }
        
        /* Responsive progress bars */
        .progress {
            height: 25px;
        }
        
        /* Responsive list items */
        .list-group-item {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        /* Responsive info sections */
        .info-section {
            font-size: 13px;
        }
        
        .info-section ul li {
            margin-bottom: 5px;
        }
        
        /* Better spacing for mobile */
        .mt-4 {
            margin-top: 20px !important;
        }
        
        .mb-3 {
            margin-bottom: 15px !important;
        }
        
        /* Responsive text */
        h2 {
            font-size: 24px;
        }
        
        h5 {
            font-size: 16px;
        }
        
        h6 {
            font-size: 14px;
        }
        
        /* Mobile-specific layout */
        .mobile-col {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        /* Responsive textarea */
        textarea.form-control {
            min-height: 80px;
            font-size: 14px;
        }
        
        /* Better touch targets */
        .nav-link {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive alerts */
        .alert {
            font-size: 14px;
            padding: 10px;
        }
    }
    
    /* Small mobile devices */
    @media (max-width: 576px) {
        .nav-tabs .nav-link {
            font-size: 12px;
            padding: 6px 8px;
            max-width: 140px;
        }
        
        .nav-tabs .nav-link i {
            display: none; /* Hide icons on very small screens */
        }
        
        h2 {
            font-size: 20px;
        }
        
        .card-header h5 {
            font-size: 14px;
        }
    }
    
    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .nav-tabs .nav-link {
            font-size: 13px;
            padding: 6px 10px;
        }
    }
</style>

<div class="container mt-4" style="max-width:900px; margin:0 auto;">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-robot"></i> AI Dashboard <span class="mobile-hide">- LLM Farm</span></h2>
            <p class="text-muted">Sử dụng AI để hỗ trợ quản lý mầm non</p>
        </div>
    </div>

    <!-- AI Features Tabs -->
    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="aiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-ai" 
                            type="button" role="tab" aria-controls="menu-ai" aria-selected="true">
                        <i class="fas fa-utensils"></i> <span class="d-none d-sm-inline">Menu AI</span><span class="d-sm-none">Menu</span>
                    </button>
                </li>
                <!-- Curriculum AI tab removed -->
            </ul>
            <div class="tab-content" id="aiTabsContent">
                <!-- Menu AI Tab -->
                <div class="tab-pane fade show active" id="menu-ai" role="tabpanel" aria-labelledby="menu-tab">
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-utensils"></i> Gợi ý thực đơn dinh dưỡng AI</h5>
                                    <small>Tạo thực đơn cân bằng dinh dưỡng từ nguyên liệu có sẵn</small>
                                </div>
                                <div class="card-body">
                                    <form id="menuSuggestionForm">
                                        <div class="mb-3">
                                            <label for="ageGroup" class="form-label">Độ tuổi</label>
                                            <select class="form-select" id="ageGroup" name="age_group">
                                                <option value="1-3 tuổi" selected>1-3 tuổi</option>
                                                <option value="3-5 tuổi">3-5 tuổi</option>
                                                <option value="1-5 tuổi">1-5 tuổi (đa độ tuổi)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="availableIngredients" class="form-label">Thực phẩm có sẵn</label>
                                            <textarea class="form-control" id="availableIngredients" rows="4" 
                                                      placeholder="Nhập thực phẩm có sẵn, mỗi loại một dòng...&#10;VD: Thịt heo, Cà rốt, Cơm, Trứng gà, Cá, Rau xanh, Trái cây..."></textarea>
                                            <small class="form-text text-muted">AI sẽ đưa ra gợi ý thực đơn dinh dưỡng và phù hợp từ các nguyên liệu này</small>
                                        </div>
                                        
                                        <!-- Chọn tuần để tạo thực đơn -->
                                        <div class="mb-3">
                                            <label for="targetWeek" class="form-label">Tuần cần tạo thực đơn</label>
                                            <input type="number" class="form-control" id="targetWeek" name="target_week" 
                                                   min="1" max="53" placeholder="Nhập số tuần (1-53)">
                                            <small class="form-text text-muted">Nhập số tuần cần tạo thực đơn (VD: 38, 39, 40...)</small>
                                        </div>
                                        
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary" id="menuSubmitBtn">
                                                <i class="fas fa-magic"></i> Tạo gợi ý thực đơn dinh dưỡng
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Progress Bar for Menu -->
                                    <div id="menuProgress" class="mt-3" style="display: none;">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="progress">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                         role="progressbar" style="width: 0%" id="menuProgressBar"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-1" id="menuProgressText">Đang khởi tạo AI...</small>
                                    </div>
                                    
                                    <div id="menuResults" class="mt-3" style="display: none;">
                                        <h6>Kết quả:</h6>
                                        <ul id="menuList" class="list-group"></ul>
                                        <!-- Nút lưu thực đơn tuần từ AI -->
                                        <div class="d-grid mt-3">
                                            <button id="createMenuBtn" class="btn btn-success" type="button">
                                                <i class="fas fa-save"></i> Lưu thực đơn tuần này
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {% if menu_result and menu_result.prompt %}
                                        {% set prompt_js = menu_result.prompt|tojson|safe %}
                                    {% else %}
                                        {% set prompt_js = '""' %}
                                    {% endif %}
                                    <script>
                                        // Luôn in prompt ra console, kể cả khi không có menu_result
                                        var prompt = {{ prompt_js }};
                                        console.log("[DEBUG] Prompt AI:", prompt);
                                    </script>
                                    {% if menu_result and menu_result.prompt %}
                                    <div class="alert alert-info mt-3">
                                        <strong>Prompt gợi ý cho AI:</strong><br>
                                        <textarea class="form-control" rows="10" readonly style="font-size:0.95em; white-space:pre;">{{ menu_result.prompt }}</textarea>
                                        <small class="text-muted">Copy toàn bộ prompt này và gửi cho AI. Lưu ý: AI chỉ được sử dụng đúng các món trong danh sách, tuyệt đối không tự ý thêm món mới.</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Curriculum AI tab content removed -->
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-link"></i> Liên kết nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.menu') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-calendar-alt"></i><br><span class="d-none d-sm-inline">Xem </span>Thực đơn
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.suppliers') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-truck"></i><br><span class="d-none d-sm-inline">Nhà </span>Cung cấp
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.products') }}" class="btn btn-outline-dark w-100 mb-2">
                                <i class="fas fa-box"></i><br>Sản phẩm
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.dish_list') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-list"></i><br>Danh sách món ăn
                            </a>
                        </div>
                        <div class="col-6 col-md-2">
                            <a href="{{ url_for('main.create_dish') }}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-plus-circle"></i><br><span class="d-none d-sm-inline">Tạo </span>Món ăn
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang xử lý...</span>
        </div>
        <p class="mt-2">AI đang xử lý yêu cầu của bạn...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// Menu Suggestions
    let currentMenuData = null; // Biến toàn cục để lưu data AI
    let selectedWeek = null; // Tuần được chọn để tạo thực đơn
    
    // Initialize week input với tuần hiện tại
    function initializeWeekInput() {
        const weekInput = document.getElementById('targetWeek');
        const today = new Date();
        const currentWeek = getWeekNumber(today);
        const currentYear = new Date().getFullYear();
        
        weekInput.value = currentWeek;
        selectedWeek = {week: currentWeek, year: currentYear};
    }
    
    // Helper functions
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    
    function formatDate(date) {
        return date.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'});
    }
    
    // Initialize week input
    initializeWeekInput();
    
    // Week input change event
    document.getElementById('targetWeek').addEventListener('change', function(e) {
        const weekNumber = parseInt(e.target.value);
        const currentYear = new Date().getFullYear();
        
        if (weekNumber >= 1 && weekNumber <= 53) {
            selectedWeek = {week: weekNumber, year: currentYear};
            console.log('[DEBUG] Selected week:', selectedWeek);
        } else {
            alert('Vui lòng nhập số tuần từ 1 đến 53');
            e.target.value = getWeekNumber(new Date()); // Reset về tuần hiện tại
        }
    });
    
    document.getElementById('menuSuggestionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('🔥 [DEBUG] Form submitted!');
        
        showMenuProgress();
        
        const formData = {
            age_group: document.getElementById('ageGroup').value,
            available_ingredients: document.getElementById('availableIngredients').value,
            count: 5 // Fixed count
        };
        
        console.log('📝 [DEBUG] Form data:', formData);
        
        // Get CSRF token
        const csrfToken = '{{ csrf_token() }}';
        
        // Fetch with CSRF token
        fetch('/ai/menu-suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            console.log('📡 [DEBUG] Response received:', response.status);
            
            // Handle different status codes properly
            if (response.status === 429) {
                // Rate limit or quota exceeded - handle gracefully
                return response.json().then(data => {
                    throw new Error(`🚫 ${data.error || 'Quá nhiều yêu cầu. Vui lòng thử lại sau.'}`);
                });
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server không trả về JSON, có thể bạn chưa đăng nhập hoặc không có quyền");
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ [DEBUG] Data received:', data);
            hideMenuProgress();
            if (data.success) {
                currentMenuData = data; // Lưu data để tạo menu sau
                displayMenuResults(data.menu);
            } else {
                console.error('❌ [DEBUG] Server error:', data.error);
                alert('Lỗi: ' + data.error);
            }
        })
        .catch(error => {
            console.error('💥 [DEBUG] Fetch error:', error);
            hideMenuProgress();
            console.error('Chi tiết lỗi:', error);
            
            // Enhanced error handling for better UX
            const errorMsg = error.message;
            if (errorMsg.includes('🚫')) {
                // Rate limit or quota errors - show clean message without fallback
                alert(errorMsg.replace('🚫 ', ''));
            } else if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                alert('⚠️ API đã hết quota hoặc quá tải. Vui lòng thử lại sau.');
            } else {
                // Show fallback suggestions for network errors only
                const fallbackSuggestions = [
                    "❌ Không thể kết nối với AI",
                    "🔧 Vui lòng kiểm tra kết nối mạng",
                    "💡 Thử lại sau ít phút"
                ];
                displayMenuResults(fallbackSuggestions);
                alert('⚠️ Lỗi kết nối AI: ' + errorMsg);
            }
        });
    });

    // Xử lý nút tạo thực đơn mới
    document.getElementById('createMenuBtn').addEventListener('click', function() {
        if (!currentMenuData) {
            alert('Không có dữ liệu thực đơn để tạo. Vui lòng tạo gợi ý thực đơn trước.');
            return;
        }
        
        // Lấy số tuần từ input
        const weekInput = document.getElementById('targetWeek');
        const weekNumber = parseInt(weekInput.value);
        const currentYear = new Date().getFullYear();
        
        if (!weekNumber || weekNumber < 1 || weekNumber > 53) {
            alert('Vui lòng nhập số tuần hợp lệ (1-53).');
            return;
        }
        
        selectedWeek = {week: weekNumber, year: currentYear};
        const confirmCreate = confirm(`Bạn có muốn tạo thực đơn mới cho tuần ${selectedWeek.week}/${selectedWeek.year} từ kết quả AI này không?`);
        if (!confirmCreate) return;
        
        // Hiển thị loading
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo thực đơn...';
        btn.disabled = true;
        
        // Gửi request tạo menu
        const csrfToken = document.querySelector('meta[name=csrf-token]').getAttribute('content');
        
        function createMenu(overwrite = false) {
            console.log('[DEBUG] currentMenuData:', currentMenuData);
            console.log('[DEBUG] selectedWeek:', selectedWeek);
            
            const requestData = { 
                menu: currentMenuData.menu,  // Chỉ gửi menu data, không gửi toàn bộ response
                overwrite: overwrite,
                target_week: selectedWeek.week,
                target_year: selectedWeek.year
            };
            
            console.log('[DEBUG] requestData to send:', requestData);
            
            fetch('/ai/create-menu-from-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('[DEBUG] Response status:', response.status);
                console.log('[DEBUG] Response headers:', response.headers);
                
                if (response.status === 409) {
                    // Conflict - menu đã tồn tại
                    return response.json().then(data => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        
                        const confirmOverwrite = confirm(
                            `${data.error}\n\nBấm OK để ghi đè thực đơn hiện có, Cancel để hủy.`
                        );
                        
                        if (confirmOverwrite) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang ghi đè thực đơn...';
                            btn.disabled = true;
                            createMenu(true); // Gọi lại với overwrite = true
                        }
                        return null;
                    });
                }
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    // Not JSON - probably HTML error page
                    return response.text().then(text => {
                        throw new Error(`Server returned HTML instead of JSON: ${text.substring(0, 100)}...`);
                    });
                }
            })
            .then(data => {
                if (data) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    if (data.success) {
                        const message = data.overwritten 
                            ? `✅ Đã cập nhật thực đơn tuần ${data.week_number} thành công!`
                            : `✅ Đã tạo thực đơn tuần ${data.week_number} thành công!`;
                        alert(message);
                        // Chuyển đến trang menu
                        window.location.href = '/menu';
                    } else {
                        alert('❌ Lỗi tạo thực đơn: ' + data.error);
                    }
                }
            })
            .catch(error => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error('Lỗi:', error);
                alert('❌ Lỗi kết nối: ' + error.message);
            });
        }
        
        createMenu(); // Bắt đầu tạo menu
    });



    function showLoading() {
        document.getElementById('loadingIndicator').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loadingIndicator').style.display = 'none';
    }

    // Progress Bar Functions for Menu
    function showMenuProgress() {
        // Ẩn kết quả cũ và hiện progress
        document.getElementById('menuResults').style.display = 'none';
        document.getElementById('menuProgress').style.display = 'block';
        document.getElementById('menuSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        
        let progress = 0;
        const messages = [
            'Đang khởi tạo Gemini AI...',
            'Đang phân tích nguyên liệu...',
            'Đang tạo thực đơn cân bằng...',
            'Đang kiểm tra dinh dưỡng...',
            'Hoàn tất!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20 + 15; // Tăng nhanh hơn 15-35%
            if (progress > 95) progress = 95; // Gần hoàn tất
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 500); // Tăng tốc độ cập nhật
        
        // Lưu interval để có thể clear sau
        window.menuProgressInterval = interval;
    }

    function hideMenuProgress() {
        // Clear interval và ẩn progress
        if (window.menuProgressInterval) {
            clearInterval(window.menuProgressInterval);
        }
        
        // Hoàn thành progress bar
        const progressBar = document.getElementById('menuProgressBar');
        const progressText = document.getElementById('menuProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Hoàn tất!';
        
        // Ẩn sau 500ms
        setTimeout(() => {
            document.getElementById('menuProgress').style.display = 'none';
            document.getElementById('menuSubmitBtn').disabled = false;
        }, 500);
    }

    // Progress Bar Functions for Nutrition
    function showNutritionProgress() {
        document.getElementById('nutritionResults').style.display = 'none';
        document.getElementById('nutritionProgress').style.display = 'block';
        document.getElementById('nutritionSubmitBtn').disabled = true;
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        
        let progress = 0;
        const messages = [
            'Đang khởi tạo Gemini AI...',
            'Đang phân tích thành phần...',
            'Đang tính toán dinh dưỡng...',
            'Đang đánh giá cân bằng...',
            'Hoàn tất phân tích!'
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 25 + 15; // Tăng nhanh 15-40%
            if (progress > 95) progress = 95;
            
            progressBar.style.width = progress + '%';
            
            const messageIndex = Math.floor((progress / 100) * (messages.length - 1));
            progressText.textContent = messages[messageIndex];
        }, 400); // Nhanh hơn
        
        window.nutritionProgressInterval = interval;
    }

    function hideNutritionProgress() {
        if (window.nutritionProgressInterval) {
            clearInterval(window.nutritionProgressInterval);
        }
        
        const progressBar = document.getElementById('nutritionProgressBar');
        const progressText = document.getElementById('nutritionProgressText');
        progressBar.style.width = '100%';
        progressText.textContent = 'Hoàn tất phân tích!';
        
        setTimeout(() => {
            document.getElementById('nutritionProgress').style.display = 'none';
            document.getElementById('nutritionSubmitBtn').disabled = false;
        }, 500);
    }

    function displayMenuResults(suggestions) {
        const resultDiv = document.getElementById('menuResults');
        const listElement = document.getElementById('menuList');
        // const createBtn = document.getElementById('createMenuBtn'); // nút này đã bị xoá

        listElement.innerHTML = '';
        if (suggestions && typeof suggestions === 'object' && !Array.isArray(suggestions)) {
            // Nếu là object (menu tuần), render bảng menu
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayNames = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
            const slots = ['morning', 'snack', 'dessert', 'lunch', 'afternoon', 'lateafternoon'];
            const slotNames = ['Sáng', 'Phụ sáng', 'Tráng miệng', 'Trưa', 'Xế', 'Xế chiều'];
            let html = '<div class="table-responsive"><table class="table table-bordered table-sm align-middle text-center"><thead><tr><th>Thứ</th>';
            slotNames.forEach(slot => { html += `<th>${slot}</th>`; });
            html += '</tr></thead><tbody>';
            days.forEach((day, i) => {
                html += `<tr><td class="fw-bold text-success">${dayNames[i]}</td>`;
                slots.forEach(slot => {
                    html += `<td>${suggestions[day] && suggestions[day][slot] ? suggestions[day][slot] : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            // Hiển thị bảng trong listElement
            const li = document.createElement('li');
            li.className = 'list-group-item p-0';
            li.innerHTML = html;
            listElement.appendChild(li);
            
            // Hiển thị nutrition tips nếu có
            if (currentMenuData && currentMenuData.suggestions && currentMenuData.suggestions.nutrition_tips) {
                const tipsLi = document.createElement('li');
                tipsLi.className = 'list-group-item';
                tipsLi.innerHTML = `
                    <h6 class="text-primary"><i class="fas fa-lightbulb"></i> Gợi ý dinh dưỡng:</h6>
                    <ul class="mb-0">
                        ${currentMenuData.suggestions.nutrition_tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                `;
                listElement.appendChild(tipsLi);
            }
        } else if (Array.isArray(suggestions)) {
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = suggestion;
                listElement.appendChild(li);
            });
        } else {
            // Nếu không phải mảng, hiển thị thông báo lỗi
            const li = document.createElement('li');
            li.className = 'list-group-item text-danger';
            li.textContent = 'Không có dữ liệu thực đơn.';
            listElement.appendChild(li);
        }

        // Không còn nút tạo menu nên không cần xử lý createBtn
        resultDiv.style.display = 'block';
    }

    function displayNutritionResults(analysis) {
        const resultDiv = document.getElementById('nutritionResults');
        const contentDiv = document.getElementById('nutritionContent');
        
        contentDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Calo:</strong> ${analysis.calories}</p>
                    <p><strong>Protein:</strong> ${analysis.protein_percent}</p>
                    <p><strong>Carbohydrate:</strong> ${analysis.carb_percent}</p>
                    <p><strong>Chất béo:</strong> ${analysis.fat_percent}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Vitamin & Khoáng chất:</strong> ${analysis.vitamins}</p>
                    <p><strong>Điểm đánh giá:</strong> 
                        <span class="badge ${analysis.overall_score >= 7 ? 'bg-success' : analysis.overall_score >= 5 ? 'bg-warning' : 'bg-danger'}">
                            ${analysis.overall_score}/10
                        </span>
                    </p>
                </div>
            </div>
            <div class="mt-2">
                <strong>Gợi ý cải thiện:</strong>
                <p class="text-muted">${analysis.suggestions}</p>
            </div>
        `;
        
        resultDiv.style.display = 'block';
    }

    // Curriculum AI functionality removed

    // ================================
    // URL PARAMETER HANDLING FOR TAB SWITCHING
    // ================================
    
    // Check URL parameters to auto-switch tabs
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'curriculum') {
        // Chuyển sang tab Chương trình học AI
        document.getElementById('menu-tab').classList.remove('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'false');
        document.getElementById('menu-ai').classList.remove('show', 'active');
        document.getElementById('curriculum-tab').classList.add('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'true');
        document.getElementById('curriculum-ai').classList.add('show', 'active');
        document.getElementById('curriculum-ai').classList.add('active');
    } else {
        // Mặc định hoặc tab=menu đều mở Menu AI
        document.getElementById('menu-tab').classList.add('active');
        document.getElementById('menu-tab').setAttribute('aria-selected', 'true');
        document.getElementById('menu-ai').classList.add('show', 'active');
        document.getElementById('menu-ai').classList.add('active');
        document.getElementById('curriculum-tab').classList.remove('active');
        document.getElementById('curriculum-tab').setAttribute('aria-selected', 'false');
        document.getElementById('curriculum-ai').classList.remove('show', 'active');
        document.getElementById('curriculum-ai').classList.remove('active');
    }
    // Clean URL after processing (remove tab parameter)
    if (tabParam) {
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }


});
</script>
{% endblock %}
