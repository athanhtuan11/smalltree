{% extends 'base.html' %}
{% block content %}
<!-- Hero Section -->
<div class="bg-dark text-white py-4">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('main.courses') }}" class="text-white-50">Khóa học</a></li>
                <li class="breadcrumb-item"><a href="#" class="text-white-50">{{ course.category }}</a></li>
                <li class="breadcrumb-item active text-white">{{ course.title }}</li>
            </ol>
        </nav>
        
        <div class="row">
            <div class="col-lg-8">
                {% if user_role in ['admin', 'teacher'] and (not instructor or instructor.id == session.get('user_id') or instructor.id == session.get('staff_id')) %}
                <div class="mb-3 d-flex gap-2">
                    <a href="{{ url_for('main.course_curriculum', course_id=course.id) }}" class="btn btn-warning btn-sm">
                        <i class="bi bi-list-ul me-1"></i>Manage Curriculum
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i> Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="archiveCourse({{ course.id }}); return false;">
                                <i class="bi bi-archive me-2"></i>Ẩn khóa học
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteCourse({{ course.id }}); return false;">
                                <i class="bi bi-trash me-2"></i>Xoá khóa học
                            </a></li>
                        </ul>
                    </div>
                </div>
                {% endif %}
                
                <span class="badge bg-warning text-dark mb-2">Bestseller</span>
                <h1 class="mb-2">{{ course.title }}</h1>
                <p class="lead">{{ course.short_description }}</p>
                
                <div class="d-flex align-items-center mb-3 flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                        <span class="text-warning me-1"><strong>{{ course.rating_avg }}</strong></span>
                        {% for i in range(5) %}
                            {% if i < course.rating_avg|int %}
                            <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                            <i class="bi bi-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="ms-2">({{ course.rating_count }} ratings)</span>
                    </div>
                    <div>
                        <i class="bi bi-people me-1"></i>{{ course.enrolled_count }} students
                    </div>
                </div>
                
                <div class="mb-3">
                    <span>Created by </span>
                    <a href="#" class="text-white text-decoration-underline">{{ instructor.name if instructor else 'Unknown' }}</a>
                </div>
                
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div><i class="bi bi-exclamation-circle me-1"></i>Last updated {{ course.updated_at.strftime('%m/%Y') if course.updated_at else 'N/A' }}</div>
                    <div><i class="bi bi-globe me-1"></i>{{ course.language }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- What you'll learn -->
            {% if what_you_learn %}
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="mb-3">What you'll learn</h4>
                    <div class="row">
                        {% for item in what_you_learn %}
                        <div class="col-md-6 mb-2">
                            <i class="bi bi-check2 text-success me-2"></i>{{ item }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Course content -->
            <div class="mb-4">
                <h4 class="mb-3">Course content</h4>
                <p class="text-muted">
                    {{ course.total_lessons }} lectures • {{ (course.total_duration / 60)|round|int }} hours total length
                </p>
                
                {% if sections %}
                <div class="accordion" id="curriculumAccordion">
                    {% for section in sections %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#section{{ section.id }}">
                                <strong>{{ section.title }}</strong>
                                <span class="ms-auto me-2 text-muted small">
                                    {{ section.lessons|length }} lectures
                                </span>
                            </button>
                        </h2>
                        <div id="section{{ section.id }}" 
                             class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                             data-bs-parent="#curriculumAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    {% for lecture in section.lessons %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if lecture.lesson_type == 'video' %}
                                            <i class="bi bi-play-circle me-2"></i>
                                            {% elif lecture.lesson_type == 'quiz' %}
                                            <i class="bi bi-question-circle me-2"></i>
                                            {% elif lecture.lesson_type == 'text' %}
                                            <i class="bi bi-file-text me-2"></i>
                                            {% endif %}
                                            {{ lecture.title }}
                                            {% if lecture.is_preview %}
                                            <span class="badge bg-info ms-2">Preview</span>
                                            {% endif %}
                                        </div>
                                        <span class="text-muted small">{{ (lecture.duration / 60)|round|int }} min</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">Chưa có nội dung.</p>
                {% endif %}
            </div>
            
            <!-- Requirements -->
            {% if requirements %}
            <div class="mb-4">
                <h4 class="mb-3">Requirements</h4>
                <ul>
                    {% for req in requirements %}
                    <li>{{ req }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- Description -->
            <div class="mb-4">
                <h4 class="mb-3">Description</h4>
                <div style="white-space: pre-wrap;">{{ course.description }}</div>
            </div>
            
            <!-- Instructor -->
            <div class="mb-4">
                <h4 class="mb-3">Instructor</h4>
                {% if instructor %}
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="instructor-avatar me-3">
                                {% if instructor.avatar %}
                                <img src="{{ instructor.avatar }}" alt="{{ instructor.name }}" class="rounded-circle" width="80" height="80">
                                {% else %}
                                <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" 
                                     style="width: 80px; height: 80px; font-size: 2rem;">
                                    {{ instructor.name[0] }}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <h5 class="mb-1">{{ instructor.name }}</h5>
                                <p class="text-muted mb-2">{{ instructor.position if instructor.position else 'Instructor' }}</p>
                                <div class="d-flex gap-3 small text-muted">
                                    <div><i class="bi bi-envelope me-1"></i>{{ instructor.email if instructor.email else 'N/A' }}</div>
                                    <div><i class="bi bi-phone me-1"></i>{{ instructor.phone if instructor.phone else 'N/A' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Student feedback -->
            <div class="mb-4">
                <h4 class="mb-3">Student feedback</h4>
                <div class="row align-items-center mb-4">
                    <div class="col-md-3 text-center">
                        <div class="display-3 fw-bold text-warning">{{ course.rating_avg }}</div>
                        <div class="text-warning mb-2">
                            {% for i in range(5) %}
                                {% if i < course.rating_avg|int %}
                                <i class="bi bi-star-fill"></i>
                                {% else %}
                                <i class="bi bi-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="text-muted">Course Rating</div>
                    </div>
                    <div class="col-md-9">
                        {% for stars in [5, 4, 3, 2, 1] %}
                        <div class="d-flex align-items-center mb-2">
                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                <div class="progress-bar bg-warning" style="width: {{ (100 - stars * 10) }}%"></div>
                            </div>
                            <span class="text-warning">
                                {% for i in range(stars) %}<i class="bi bi-star-fill small"></i>{% endfor %}
                            </span>
                            <span class="ms-2 text-muted small">{{ 100 - stars * 10 }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Reviews -->
                {% if reviews %}
                {% for review in reviews %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    {{ review.student[0] }}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ review.student }}</h6>
                                    <small class="text-muted">{{ review.date }}</small>
                                </div>
                                <div class="text-warning mb-2">
                                    {% for i in range(review.rating) %}
                                    <i class="bi bi-star-fill small"></i>
                                    {% endfor %}
                                </div>
                                <p class="mb-0">{{ review.comment }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">Chưa có đánh giá nào.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar - Purchase Card -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 1rem;">
                <div class="position-relative">
                    {% if course.video_preview %}
                    <video class="w-100" controls poster="{{ course.thumbnail }}">
                        <source src="{{ course.video_preview }}" type="video/mp4">
                    </video>
                    {% elif course.thumbnail %}
                    <img src="{{ course.thumbnail }}" class="card-img-top" alt="{{ course.title }}">
                    {% else %}
                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                        <i class="bi bi-play-circle" style="font-size: 4rem; color: #43a047;"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {% if course.price == 0 %}
                        <h3 class="mb-0 text-success">Miễn phí</h3>
                        {% else %}
                        <h3 class="mb-0 text-success">{{ "{:,.0f}".format(course.price) }}đ</h3>
                        {% endif %}
                    </div>
                    
                    {% if is_enrolled %}
                    <a href="{{ url_for('main.course_learn', course_id=course.id) }}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-play-circle me-2"></i>Tiếp tục học
                    </a>
                    {% elif user_role in ['admin', 'teacher'] %}
                    <a href="{{ url_for('main.course_learn', course_id=course.id) }}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-play-circle me-2"></i>Học ngay
                    </a>
                    <a href="{{ url_for('main.course_edit', course_id=course.id) }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="bi bi-pencil me-2"></i>Chỉnh sửa khóa học
                    </a>
                    <a href="{{ url_for('main.admin_enrollments') }}?course_id={{ course.id }}" class="btn btn-outline-success w-100 mb-2">
                        <i class="bi bi-people me-2"></i>Quản lý đăng ký
                    </a>
                    <p class="text-center small text-muted mb-3">
                        Giáo viên/Admin có thể xem tất cả khóa học
                    </p>
                    {% elif user_logged_in %}
                    <button id="enrollBtn" class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#enrollmentModal">
                        <i class="bi bi-pencil-square me-2"></i>Đăng ký học
                    </button>
                    <p class="text-center small text-muted mb-3">
                        Điền form đăng ký và chúng tôi sẽ liên hệ với bạn
                    </p>
                    {% else %}
                    <a href="{{ url_for('main.login') }}" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập để học
                    </a>
                    <button id="enrollBtn" class="btn btn-outline-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#enrollmentModal">
                        <i class="bi bi-pencil-square me-2"></i>Đăng ký học (khách vãng lai)

                    </button>
                    <p class="text-center small text-muted mb-3">
                        Điền form đăng ký và chúng tôi sẽ liên hệ với bạn
                    </p>
                    {% endif %}
                    
                    <div class="text-center mb-3">
                        <small class="text-muted">30-Day Money-Back Guarantee</small>
                    </div>
                    
                    <div class="mb-2">
                        <strong>This course includes:</strong>
                    </div>
                    <ul class="list-unstyled small">
                        <li class="mb-2"><i class="bi bi-play-circle me-2"></i>{{ (course.total_duration / 60)|round|int }} hours on-demand video</li>
                        <li class="mb-2"><i class="bi bi-file-earmark me-2"></i>{{ course.total_lessons }} lectures</li>
                        <li class="mb-2"><i class="bi bi-infinity me-2"></i>Full lifetime access</li>
                        <li class="mb-2"><i class="bi bi-phone me-2"></i>Access on mobile and TV</li>
                        <li class="mb-2"><i class="bi bi-award me-2"></i>Certificate of completion</li>
                    </ul>
                    
                    <div class="d-flex justify-content-between">
                        <a href="#" class="text-decoration-none">
                            <i class="bi bi-heart me-1"></i>Wishlist
                        </a>
                        <a href="#" class="text-decoration-none">
                            <i class="bi bi-share me-1"></i>Share
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #212529;
}

.sticky-top {
    top: 1rem !important;
}

@media (max-width: 991.98px) {
    .sticky-top {
        position: static !important;
    }
}

/* Green Theme - Đồng bộ với Tasks */
.breadcrumb {
    background: transparent;
}

.breadcrumb-item a {
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    transition: color 0.2s;
}

.breadcrumb-item a:hover {
    color: #ffffff;
}

.btn-success {
    background-color: #43a047 !important;
    border-color: #43a047 !important;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-success:hover {
    background-color: #2e7d32 !important;
    border-color: #2e7d32 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(67,160,71,0.3);
}

.btn-outline-success {
    color: #43a047;
    border-color: #43a047;
    font-weight: 600;
}

.btn-outline-success:hover {
    background-color: #43a047;
    border-color: #43a047;
    color: white;
}

.text-success {
    color: #43a047 !important;
}

.bg-success {
    background-color: #43a047 !important;
}

.card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.accordion-button:not(.collapsed) {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.accordion-button:focus {
    border-color: #43a047;
    box-shadow: 0 0 0 0.2rem rgba(67,160,71,0.15);
}
</style>

<!-- Enrollment Modal -->
<div class="modal fade" id="enrollmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>Đăng ký khóa học: {{ course.title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="enrollmentForm">
                    <input type="hidden" name="course_id" value="{{ course.id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="student_name" required 
                               placeholder="Nguyễn Văn A">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" name="phone" required 
                               placeholder="0912345678">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" name="email" required 
                               placeholder="example@gmail.com">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ghi chú (tùy chọn)</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="Thời gian học mong muốn, câu hỏi khác..."></textarea>
                    </div>
                    
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle me-2"></i>
                        Sau khi gửi form, chúng tôi sẽ liên hệ với bạn trong 24h để xác nhận và hướng dẫn thanh toán.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" onclick="submitEnrollment()">
                    <i class="bi bi-send me-2"></i>Gửi đăng ký
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Handle preview lectures
document.querySelectorAll('.list-group-item').forEach(item => {
    const previewBadge = item.querySelector('.badge.bg-info');
    if (previewBadge) {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function() {
            alert('Preview functionality will be implemented');
        });
    }
});

// Submit enrollment form
async function submitEnrollment() {
    const form = document.getElementById('enrollmentForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Convert to JSON
    const data = {
        course_id: formData.get('course_id'),
        student_name: formData.get('student_name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        notes: formData.get('notes')
    };
    
    // Disable submit button
    const submitBtn = event.target;
    const originalHTML = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';
    
    try {
        const response = await fetch('/api/courses/enrollment-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('enrollmentModal'));
            modal.hide();
            
            // Show success message
            alert('✅ Đăng ký thành công! Chúng tôi sẽ liên hệ với bạn trong 24h.');
            
            // Reset form
            form.reset();
        } else {
            alert('❌ ' + (result.message || 'Có lỗi xảy ra. Vui lòng thử lại!'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Có lỗi xảy ra. Vui lòng thử lại!');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
    }
}

// Delete course
async function deleteCourse(courseId) {
    if (!confirm('⚠️ Bạn có chắc chắn muốn XOÁ khóa học này?\n\nHành động này không thể hoàn tác!')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/courses/${courseId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Đã xoá khóa học thành công!');
            window.location.href = '/courses';
        } else {
            alert('❌ ' + (data.message || 'Có lỗi xảy ra'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Có lỗi xảy ra. Vui lòng thử lại!');
    }
}

// Archive course
async function archiveCourse(courseId) {
    if (!confirm('Ẩn khóa học này? Học sinh sẽ không thể xem được khóa học.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/courses/${courseId}/archive`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Đã ẩn khóa học thành công!');
            location.reload();
        } else {
            alert('❌ ' + (data.message || 'Có lỗi xảy ra'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Có lỗi xảy ra. Vui lòng thử lại!');
    }
}
</script>
{% endblock %}
