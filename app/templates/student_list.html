{% extends 'base.html' %}
{% block title %}Danh sách học sinh{% endblock %}
{% block content %}
<style>
    .student-table-mobile { font-size:0.85em; }
    .student-table-desktop { font-size:1em; }
    .student-table-mobile td, .student-table-mobile th { padding:0.18em 0.08em; }
    .student-table-wrapper { border:1.5px solid #c8e6c9; border-radius:0; box-shadow:none; background:#fff; margin-left:-12px; margin-right:-12px; }
    @media (max-width: 576px) {
        .student-table-wrapper { margin-left:-16px; margin-right:-16px; border-radius:0; }
    }
    .student-inactive { opacity: 0.6; background-color: #f8f9fa !important; }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <div class="d-flex justify-content-between mb-3">
        {% if session.get('role') in ['admin', 'teacher'] %}
        <div>
            <a href="/students/export" class="btn btn-success fw-bold me-2">
                <i class="bi bi-file-earmark-excel"></i> Xuất danh sách Excel
            </a>
            <a href="/students/export-subsidized" class="btn btn-info fw-bold me-2">
                <i class="bi bi-file-earmark-text"></i> DS miễn giảm học phí
            </a>
            {% if show_all %}
                <a href="/students" class="btn btn-outline-secondary fw-bold">
                    <i class="bi bi-eye"></i> Chỉ xem đang học
                </a>
            {% else %}
                <a href="/students?show_all=true" class="btn btn-outline-primary fw-bold">
                    <i class="bi bi-eye-slash"></i> Xem tất cả
                </a>
            {% endif %}
        </div>
        {% else %}
        <div></div>
        {% endif %}
        <a href="/attendance" class="btn btn-secondary fw-bold">Quay lại điểm danh</a>
    </div>
    <h2 class="mb-4">Danh sách học sinh đã đăng ký</h2>
    <div class="table-responsive student-table-wrapper">
    <table class="table table-bordered table-hover {% if mobile %}student-table-mobile{% else %}student-table-desktop{% endif %}">
        <thead class="table-success">
            <tr>
                <th>STT</th>
                <th style="width: 70px;">Avatar</th>
                <th>Họ và tên</th>
                <th>Mã số học sinh</th>
                <th>Lớp</th>
                <th>Ngày sinh</th>
                <th>Liên hệ phụ huynh</th>
                {% if session.get('role') in ['admin', 'teacher'] %}
                <th>Thao tác</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr {% if not student.is_active %}class="student-inactive"{% endif %}>
                <td>{{ loop.index }}</td>
                <td class="text-center">
                    {% if student.avatar %}
                        <img src="{{ student.avatar|image_url }}?v={{ range(1000, 9999) | random }}" 
                             alt="{{ student.name }}" 
                             class="rounded-circle border border-success avatar-student-list" 
                             onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}';">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default_avatar.png') }}" 
                             alt="{{ student.name }}" 
                             class="rounded-circle border border-secondary avatar-student-list" 
                             style="opacity: 0.7;">
                    {% endif %}
                </td>
                <td>
                    {{ student.name }}
                    {% if not student.is_active %}
                        <span class="badge bg-warning ms-1">Đã nghỉ</span>
                    {% endif %}
                </td>
                <td>{% if student.student_code == 'Ẩn' %}<span title="Chỉ admin mới xem được">Ẩn</span>{% else %}{{ student.student_code }}{% endif %}</td>
                <td>{% if student.class_name == 'Ẩn' %}<span title="Chỉ admin mới xem được">Ẩn</span>{% else %}{{ student.class_name }}{% endif %}</td>
                <td>{% if student.birth_date %}{{ student.birth_date | datetimeformat('d/m/Y') }}{% endif %}</td>
                <td>
                    {% if student.father_name or student.mother_name %}
                        <div style="font-size:0.85em;">
                            {% if student.father_name %}
                                <div><strong>Bố:</strong> {{ student.father_name }}{% if student.father_phone %} - {{ student.father_phone }}{% endif %}</div>
                            {% endif %}
                            {% if student.mother_name %}
                                <div><strong>Mẹ:</strong> {{ student.mother_name }}{% if student.mother_phone %} - {{ student.mother_phone }}{% endif %}</div>
                            {% endif %}
                        </div>
                    {% elif student.parent_contact and student.parent_contact != 'Ẩn' %}
                        {{ student.parent_contact }}
                    {% elif student.parent_contact == 'Ẩn' %}
                        <span title="Chỉ admin mới xem được">Ẩn</span>
                    {% else %}
                        <span class="text-muted">Chưa có</span>
                    {% endif %}
                </td>
                {% if session.get('role') in ['admin', 'teacher'] %}
                <td>
                    <a href="/students/{{ student.id }}/edit" class="btn btn-warning btn-sm me-1" title="Chỉnh sửa thông tin"><i class="bi bi-pencil-square"></i></a>
                    
                    <form action="/students/{{ student.id }}/toggle" method="post" style="display:inline;" onsubmit="return confirm('{% if student.is_active %}Bạn có chắc muốn ẩn học sinh này?{% else %}Bạn có chắc muốn hiện lại học sinh này?{% endif %}');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn {% if student.is_active %}btn-secondary{% else %}btn-success{% endif %} btn-sm me-1" 
                                title="{% if student.is_active %}Ẩn học sinh{% else %}Hiện lại học sinh{% endif %}">
                            <i class="bi {% if student.is_active %}bi-eye-slash{% else %}bi-eye{% endif %}"></i>
                        </button>
                    </form>
                    
                    <form action="/students/{{ student.id }}/delete" method="post" style="display:inline;" onsubmit="return confirm('Bạn có chắc muốn xóa vĩnh viễn học sinh này? Hành động này không thể hoàn tác!');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger btn-sm" title="Xóa vĩnh viễn"><i class="bi bi-trash"></i></button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center">Chưa có học sinh nào.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
{% endblock %}
