{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-primary">Sửa món ăn</h2>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="name" class="form-label">Tên món ăn</label>
            <input type="text" class="form-control" id="name" name="name" value="{{ dish.name }}" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Mô tả</label>
            <textarea class="form-control" id="description" name="description" rows="2">{{ dish.description }}</textarea>
        </div>
        <div class="mb-3">
            <label style="font-size: 0.9em;">Dùng cho bữa nào:</label>
            <div>
                {% set meal_labels = {'morning':'Sáng','snack':'Phụ sáng','dessert':'Tráng miệng','lunch':'Trưa','afternoon':'Xế','lateafternoon':'Xế chiều'} %}
                {% for meal in ['morning','snack','dessert','lunch','afternoon','lateafternoon'] %}
                    <span style="margin-right:6px;">
                        <input type="checkbox" name="meal_times" value="{{ meal }}" {% if dish.meal_times and meal in dish.meal_times %}checked{% endif %}>
                        <label style="margin-left:2px;">{{ meal_labels[meal] }}</label>
                    </span>
                {% endfor %}
            </div>
        </div>
        <h5>Nguyên liệu</h5>
        <div id="ingredients-list">
            {% for ing in ingredients %}
            <div class="row mb-2 ingredient-row">
                <div class="col-md-6">
                    <select name="ingredient_id" class="form-select" required>
                        <option value="">-- Chọn nguyên liệu --</option>
                        {% for p in products %}
                        <option value="{{ p.id }}" {% if p.id == ing.product_id %}selected{% endif %}>{{ p.name }} ({{ p.unit }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" min="0" name="quantity" class="form-control" value="{{ ing.quantity }}" placeholder="Khối lượng" required>
                </div>
                <div class="col-md-3">
                    <select name="unit" class="form-select ingredient-unit" required>
                        <option value="">-- Đơn vị --</option>
                        {% for u in product_units %}
                        <option value="{{ u }}" {% if (ing.product.unit if ing.product else ing.unit) == u %}selected{% endif %}>{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-remove-ingredient">&times;</button>
                </div>
            </div>
            {% endfor %}
            {% if not ingredients %}
            <div class="row mb-2 ingredient-row">
                <div class="col-md-6">
                    <select name="ingredient_id" class="form-select" required>
                        <option value="">-- Chọn nguyên liệu --</option>
                        {% for p in products %}
                        <option value="{{ p.id }}">{{ p.name }} ({{ p.unit }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" min="0" name="quantity" class="form-control" placeholder="Khối lượng" required>
                </div>
                <div class="col-md-3">
                    <select name="unit" class="form-select ingredient-unit" required>
                        <option value="">-- Đơn vị --</option>
                        {% for u in product_units %}
                        <option value="{{ u }}">{{ u }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-remove-ingredient">&times;</button>
                </div>
            </div>
            {% endif %}
        </div>
        </div>
        <button type="button" class="btn btn-secondary mb-3" id="add-ingredient">+ Thêm nguyên liệu</button>
        <br>
        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
        <a href="{{ url_for('main.dish_list') }}" class="btn btn-secondary">Hủy</a>
    </form>
</div>
<script>
    // Khi chọn nguyên liệu, tự động cập nhật đơn vị tương ứng
    // Khi chọn nguyên liệu, tự động chọn đơn vị mặc định theo sản phẩm nếu có
    function updateUnitSelect(row) {
        var select = row.querySelector('select[name="ingredient_id"]');
        var unitSelect = row.querySelector('select[name="unit"]');
        if (!select || !unitSelect) return;
        var selected = select.options[select.selectedIndex];
        var unit = '';
        if (selected && selected.textContent.match(/\(([^)]+)\)$/)) {
            unit = selected.textContent.match(/\(([^)]+)\)$/)[1];
        }
        if (unit) {
            for (var i = 0; i < unitSelect.options.length; i++) {
                if (unitSelect.options[i].value === unit) {
                    unitSelect.selectedIndex = i;
                    break;
                }
            }
        }
    }
    document.querySelectorAll('.ingredient-row').forEach(function(row) {
        var select = row.querySelector('select[name="ingredient_id"]');
        if (select) {
            select.addEventListener('change', function() { updateUnitSelect(row); });
            updateUnitSelect(row);
        }
    });
    document.getElementById('add-ingredient').onclick = function() {
        var row = document.querySelector('.ingredient-row').cloneNode(true);
        row.querySelectorAll('input,select').forEach(function(el) { el.value = ''; });
        document.getElementById('ingredients-list').appendChild(row);
        var select = row.querySelector('select[name="ingredient_id"]');
        if (select) {
            select.addEventListener('change', function() { updateUnitSelect(row); });
            updateUnitSelect(row);
        }
    };
    document.getElementById('ingredients-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-ingredient')) {
            var rows = document.querySelectorAll('.ingredient-row');
            if (rows.length > 1) e.target.closest('.ingredient-row').remove();
        }
    });
</script>
{% endblock %}
