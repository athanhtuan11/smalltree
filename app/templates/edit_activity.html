{% extends 'base.html' %}
{% block content %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .quill-editor { min-height:180px; }
    @media (max-width: 576px) {
        .quill-editor { min-height:120px; }
    }
    .gallery-img-edit { max-height: 120px; object-fit: cover; border-radius: 8px; margin: 4px; }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="fw-bold mb-4" style="color:#43a047;">Chỉnh sửa hoạt động</h2>
    <form method="POST" enctype="multipart/form-data" id="editActivityForm" onsubmit="return submitQuillContent();">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="title" class="form-label">Tiêu đề</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ post.title }}" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Nội dung</label>
            <div id="quillEditor" class="quill-editor bg-white"></div>
            <input type="hidden" name="content" id="content">
        </div>
        <div class="mb-3">
            <label for="background" class="form-label">Chọn hình nền cho bài viết</label>
            <input type="file" class="form-control" id="background" name="background" accept="image/*">
            <div id="preview-bg" class="mt-3" style="display:none;">
                <img id="preview-img" src="#" alt="Preview" style="max-width:100%; border-radius:16px; filter: blur(4px) brightness(0.8);">
            </div>
        </div>
        <div class="mb-3">
            <label for="images" class="form-label">Ảnh hoạt động (có thể chọn nhiều)</label>
            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
        </div>
        {% if post.images and post.images|length > 0 %}
        <div class="mb-3">
            <label class="form-label">Ảnh hoạt động hiện tại</label>
            <div class="d-flex flex-wrap align-items-center">
                {% for img in post.images %}
                <div class="position-relative me-2 mb-2">
                    <img src="{{ url_for('static', filename=img.filepath) }}" class="gallery-img-edit shadow">
                    <form method="POST" action="{{ url_for('main.delete_activity_image', image_id=img.id, id=post.id) }}" style="position:absolute;top:2px;right:2px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-danger" style="padding:2px 6px; font-size:0.9em;" onclick="return confirm('Xoá ảnh này?');">&times;</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-success">Lưu thay đổi</button>
        <a href="{{ url_for('main.activities') }}" class="btn btn-secondary ms-2">Quay lại</a>
    </form>
</div>
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
var quill = new Quill('#quillEditor', {
    theme: 'snow',
    placeholder: 'Nhập nội dung hoạt động...',
    modules: {
        toolbar: [
            [{ header: [1, 2, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ list: 'ordered'}, { list: 'bullet' }],
            ['link', 'image'],
            ['clean']
        ]
    }
});
quill.root.innerHTML = `{{ post.description|safe }}`;
function submitQuillContent() {
    document.getElementById('content').value = quill.root.innerHTML;
    return true;
}
// Xem trước ảnh khi chọn file mới
const bgInput = document.getElementById('background');
const previewBg = document.getElementById('preview-bg');
const previewImg = document.getElementById('preview-img');
if(bgInput) {
    bgInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                previewImg.src = ev.target.result;
                previewBg.style.display = 'block';
            }
            reader.readAsDataURL(e.target.files[0]);
        } else {
            previewBg.style.display = 'none';
            previewImg.src = '#';
        }
    });
}
</script>
{% endblock %}
