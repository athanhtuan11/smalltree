{% extends 'base.html' %}
{% block title %}Chỉnh sửa học sinh{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Chỉnh sửa thông tin học sinh</h2>
    <form method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="name" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="name" name="name" value="{{ student.name }}" required>
        </div>
        <div class="mb-3">
            <label for="student_code" class="form-label">Mã số học sinh</label>
            <input type="text" class="form-control" id="student_code" name="student_code" value="{{ student.student_code }}" readonly>
        </div>
        <div class="mb-3">
            <label for="class_name" class="form-label">Lớp</label>
            <select class="form-select" id="class_name" name="class_name" required>
                {% for c in classes %}
                <option value="{{ c.name }}" {% if student.class_name == c.name %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="birth_date" class="form-label">Ngày sinh</label>
            <input type="text" class="form-control" id="birth_date" name="birth_date" placeholder="dd/mm/yyyy" autocomplete="off">
            <div class="form-text text-primary" id="birth_date_display">
                {% if student.birth_date %}Hiển thị: {{ student.birth_date | datetimeformat('d/m/Y') }}{% endif %}
            </div>
            <!-- Flatpickr datepicker -->
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
            <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
            <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Lấy ngày sinh từ server (có thể là yyyy-mm-dd hoặc chuỗi)
                var serverBirth = "{{ student.birth_date|default('') }}";
                var input = document.getElementById('birth_date');
                // Chuyển yyyy-mm-dd sang dd/mm/yyyy nếu có
                function toDMY(dateStr) {
                    if (!dateStr) return '';
                    if (dateStr.includes('/')) return dateStr;
                    var parts = dateStr.split('-');
                    if (parts.length === 3) return parts[2] + '/' + parts[1] + '/' + parts[0];
                    return dateStr;
                }
                input.value = toDMY(serverBirth);
                flatpickr(input, {
                    dateFormat: "d/m/Y",
                    locale: "vn",
                    allowInput: true,
                    defaultDate: toDMY(serverBirth) || null
                });
                // Khi submit form, chuyển dd/mm/yyyy về yyyy-mm-dd
                input.form && input.form.addEventListener('submit', function(e) {
                    var val = input.value;
                    if (val && val.includes('/')) {
                        var parts = val.split('/');
                        if (parts.length === 3) {
                            input.value = parts[2] + '-' + parts[1] + '-' + parts[0];
                        }
                    }
                });
            });
            </script>
        </div>
        <div class="mb-3">
            <label for="parent_contact" class="form-label">Liên hệ phụ huynh</label>
            <input type="text" class="form-control" id="parent_contact" name="parent_contact" value="{{ student.parent_contact }}">
        </div>
        <div class="mb-3">
            <label for="avatar" class="form-label">Ảnh đại diện học sinh</label>
            <div class="mb-2">
                <img id="avatar-preview" 
                     src="{% if student.avatar %}{{ url_for('static', filename=student.avatar) }}{% else %}{{ url_for('static', filename='images/default_avatar.png') }}{% endif %}" 
                     alt="avatar" 
                     class="rounded-circle border" 
                     style="width:80px;height:80px;object-fit:cover;">
                <small class="d-block text-muted mt-1">
                    {% if student.avatar %}Current: {{ student.avatar }}{% else %}No avatar set{% endif %}
                </small>
            </div>
            <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*" onchange="previewAvatar(this)">
            <small class="text-muted">Để trống nếu không muốn thay đổi ảnh đại diện.</small>
        </div>
        <button type="submit" class="btn btn-success" onclick="markForReload()">Lưu thay đổi</button>
        <a href="/students" class="btn btn-secondary ms-2">Quay lại</a>
    </form>
</div>

<script>
function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function markForReload() {
    // Only mark for reload if avatar file is selected
    const avatarInput = document.getElementById('avatar');
    if (avatarInput && avatarInput.files && avatarInput.files.length > 0) {
        localStorage.setItem('forceAvatarReload', 'true');
        console.log('Avatar file selected, marked for reload');
    }
}

// Add cache busting on page load if avatar exists
document.addEventListener('DOMContentLoaded', function() {
    const avatarPreview = document.getElementById('avatar-preview');
    if (avatarPreview) {
        // Check if we need to force reload
        const forceReload = localStorage.getItem('forceAvatarReload');
        if (forceReload) {
            localStorage.removeItem('forceAvatarReload');
            // Force reload with timestamp
            const currentSrc = avatarPreview.src;
            if (currentSrc.includes('images/students/')) {
                avatarPreview.src = currentSrc.split('?')[0] + '?v=' + Date.now();
                console.log('Force avatar reload:', avatarPreview.src);
            }
        } else {
            const currentSrc = avatarPreview.src;
            // Only add timestamp if it's a student avatar (not default_avatar.png)
            if (currentSrc.includes('images/students/') && !currentSrc.includes('?v=')) {
                avatarPreview.src = currentSrc + '?v=' + Date.now();
                console.log('Avatar cache busting applied:', avatarPreview.src);
            }
        }
    }
});
</script>
{% endblock %}
