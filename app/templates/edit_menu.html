{% extends 'base.html' %}
{% block content %}
<style>
    .menu-textarea { min-width:80px; min-height:2.2em; resize:vertical; font-size:1em; transition:all 0.2s; cursor:pointer; }
    .menu-textarea:focus { outline:none; }
    .dish-checkbox { margin-right: 8px; }
    .dish-item { margin-bottom: 5px; padding: 2px; border-radius: 3px; }
    .dish-item:hover { background-color: #f8f9fa; }
    .meal-section { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    .menu-cell-btn { 
        min-height: 50px; 
        white-space: normal; 
        text-align: left; 
        padding: 8px 12px;
        line-height: 1.3;
        font-size: 0.9em;
    }
    @media (max-width: 576px) {
        .menu-textarea { min-width:100px; font-size:0.98em; padding:0.35em 0.5em; }
        .meal-section { max-height: 200px; }
        .menu-cell-btn { font-size: 0.85em; padding: 6px 8px; }
    }
</style>
<div class="container-fluid mt-4 mb-4 px-0">
    <h2 class="fw-bold mb-4" style="color:#43a047;">Chỉnh sửa thực đơn tuần {{ week.week_number }}</h2>
    <form method="POST" id="editMenuForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="week_number" class="form-label fw-bold">Tuần</label>
                <input type="number" class="form-control" id="week_number" name="week_number" value="{{ week.week_number }}" min="1" required>
            </div>
        </div>
        <div class="table-responsive" style="margin-left:-12px; margin-right:-12px;">
            <table class="table table-bordered align-middle bg-light">
                <thead class="table-success">
                    <tr>
                        <th rowspan="2">Thứ</th>
                        <th colspan="6" class="text-center">Khung giờ</th>
                    </tr>
                    <tr>
                        <th>Sáng</th>
                        <th>Phụ sáng</th>
                        <th>Tráng miệng</th>
                        <th>Trưa</th>
                        <th>Xế</th>
                        <th>Xế chiều</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day, label in [('mon', 'Thứ 2'), ('tue', 'Thứ 3'), ('wed', 'Thứ 4'), ('thu', 'Thứ 5'), ('fri', 'Thứ 6'), ('sat', 'Thứ 7')] %}
                    <tr>
                        <td>{{ label }}</td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="morning">Chọn món</button></td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="snack">Chọn món</button></td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="dessert">Chọn món</button></td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="lunch">Chọn món</button></td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="afternoon">Chọn món</button></td>
                        <td><button type="button" class="btn btn-outline-success btn-sm w-100 menu-cell-btn" data-day="{{ day }}" data-meal="lateafternoon">Chọn món</button></td>
                        <!-- Hidden inputs to store selected dishes -->
                        <input type="hidden" name="content_{{ day }}_morning" id="content_{{ day }}_morning" value="{{ data[day]['morning'] if data[day]['morning'] is defined else '' }}">
                        <input type="hidden" name="content_{{ day }}_snack" id="content_{{ day }}_snack" value="{{ data[day]['snack'] if data[day]['snack'] is defined else '' }}">
                        <input type="hidden" name="content_{{ day }}_dessert" id="content_{{ day }}_dessert" value="{{ data[day]['dessert'] if data[day]['dessert'] is defined else '' }}">
                        <input type="hidden" name="content_{{ day }}_lunch" id="content_{{ day }}_lunch" value="{{ data[day]['lunch'] if data[day]['lunch'] is defined else '' }}">
                        <input type="hidden" name="content_{{ day }}_afternoon" id="content_{{ day }}_afternoon" value="{{ data[day]['afternoon'] if data[day]['afternoon'] is defined else '' }}">
                        <input type="hidden" name="content_{{ day }}_lateafternoon" id="content_{{ day }}_lateafternoon" value="{{ data[day]['lateafternoon'] if data[day]['lateafternoon'] is defined else '' }}">
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-success mt-3">Lưu thay đổi</button>
        <a href="{{ url_for('main.menu') }}" class="btn btn-secondary mt-3 ms-2">Quay lại</a>
    </form>
</div>

<!-- Modal chọn món ăn -->
<div class="modal fade" id="dishSelectionModal" tabindex="-1" aria-labelledby="dishSelectionLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="dishSelectionLabel">Chọn món ăn cho <span id="mealTimeTitle"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" id="dishSearch" class="form-control" placeholder="Tìm kiếm món ăn..." onkeyup="filterDishes()">
        </div>
        <div id="dishList" class="meal-section">
          <!-- Danh sách món ăn sẽ được load ở đây -->
        </div>
        <div id="selectedDishesPreview" class="mt-3">
          <strong>Món đã chọn:</strong>
          <div id="selectedDishesText" class="mt-2 p-2 bg-light rounded" style="min-height: 40px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" onclick="saveDishSelection()">Lưu</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>
<script>
let currentDay = null;
let currentMeal = null;
let selectedDishes = {};

// Dữ liệu món ăn (sẽ được load từ server)
const dishes = [
    {% for dish in dishes %}
    {
        id: {{ dish.id }},
        name: "{{ dish.name }}",
        description: "{{ dish.description or '' }}",
        meal_times: {{ dish.meal_times|tojson }},
        is_active: {{ dish.is_active|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Mapping meal types
const mealTypeMapping = {
    'morning': 'Sáng',
    'snack': 'Phụ sáng', 
    'dessert': 'Tráng miệng',
    'lunch': 'Trưa',
    'afternoon': 'Xế',
    'lateafternoon': 'Xế chiều'
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize selectedDishes object
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const meals = ['morning', 'snack', 'dessert', 'lunch', 'afternoon', 'lateafternoon'];
    
    days.forEach(day => {
        selectedDishes[day] = {};
        meals.forEach(meal => {
            selectedDishes[day][meal] = [];
            
            // Pre-populate with existing data
            const hiddenInput = document.getElementById(`content_${day}_${meal}`);
            if (hiddenInput && hiddenInput.value) {
                const dishNames = hiddenInput.value.split(', ').filter(name => name.trim());
                dishNames.forEach(name => {
                    const dish = dishes.find(d => d.name === name.trim());
                    if (dish) {
                        selectedDishes[day][meal].push({id: dish.id, name: dish.name});
                    }
                });
            }
        });
    });
    
    // Update all buttons to show current data
    updateAllButtons();
    
    // Add click event listeners to all menu cell buttons
    document.querySelectorAll('.menu-cell-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentDay = this.dataset.day;
            currentMeal = this.dataset.meal;
            openDishSelectionModal();
        });
    });
});

function updateAllButtons() {
    const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const meals = ['morning', 'snack', 'dessert', 'lunch', 'afternoon', 'lateafternoon'];
    
    days.forEach(day => {
        meals.forEach(meal => {
            const button = document.querySelector(`[data-day="${day}"][data-meal="${meal}"]`);
            const selected = selectedDishes[day][meal];
            
            if (selected.length > 0) {
                // Hiển thị tên món, ngắn gọn nếu quá dài
                const dishNames = selected.map(d => d.name).join(', ');
                button.textContent = dishNames.length > 30 ? dishNames.substring(0, 30) + '...' : dishNames;
                button.classList.remove('btn-outline-success');
                button.classList.add('btn-success');
                button.style.whiteSpace = 'normal';
                button.style.textAlign = 'left';
            } else {
                button.textContent = 'Chọn món';
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-success');
            }
        });
    });
}

function openDishSelectionModal() {
    document.getElementById('mealTimeTitle').textContent = mealTypeMapping[currentMeal];
    
    // Load dishes for this meal type
    loadDishesForMeal(currentMeal);
    
    // Show currently selected dishes
    updateSelectedDishesPreview();
    
    var modal = new bootstrap.Modal(document.getElementById('dishSelectionModal'));
    modal.show();
}

function loadDishesForMeal(mealType) {
    const dishList = document.getElementById('dishList');
    dishList.innerHTML = '';
    
    // Filter dishes that are active and suitable for this meal
    const suitableDishes = dishes.filter(dish => 
        dish.is_active && 
        (dish.meal_times.length === 0 || dish.meal_times.includes(mealType))
    );
    
    if (suitableDishes.length === 0) {
        dishList.innerHTML = '<p class="text-muted">Chưa có món ăn nào cho bữa này. Vui lòng thêm món ăn trong <a href="/dish-list" target="_blank">Danh sách món ăn</a>.</p>';
        return;
    }
    
    suitableDishes.forEach(dish => {
        const isSelected = selectedDishes[currentDay][currentMeal].some(d => d.id === dish.id);
        const dishItem = document.createElement('div');
        dishItem.className = 'dish-item';
        dishItem.innerHTML = `
            <div class="form-check">
                <input class="form-check-input dish-checkbox" type="checkbox" 
                       id="dish_${dish.id}" value="${dish.id}" 
                       ${isSelected ? 'checked' : ''} 
                       onchange="toggleDishSelection(${dish.id}, '${dish.name}', this.checked)">
                <label class="form-check-label" for="dish_${dish.id}">
                    <strong>${dish.name}</strong>
                    ${dish.description ? '<br><small class="text-muted">' + dish.description + '</small>' : ''}
                </label>
            </div>
        `;
        dishList.appendChild(dishItem);
    });
}

function toggleDishSelection(dishId, dishName, isChecked) {
    if (isChecked) {
        // Add dish to selection
        if (!selectedDishes[currentDay][currentMeal].some(d => d.id === dishId)) {
            selectedDishes[currentDay][currentMeal].push({id: dishId, name: dishName});
        }
    } else {
        // Remove dish from selection
        selectedDishes[currentDay][currentMeal] = selectedDishes[currentDay][currentMeal].filter(d => d.id !== dishId);
    }
    updateSelectedDishesPreview();
}

function updateSelectedDishesPreview() {
    const selectedDishesText = document.getElementById('selectedDishesText');
    const selected = selectedDishes[currentDay][currentMeal];
    
    if (selected.length === 0) {
        selectedDishesText.textContent = 'Chưa chọn món nào';
    } else {
        selectedDishesText.textContent = selected.map(d => d.name).join(', ');
    }
}

function saveDishSelection() {
    // Update hidden input
    const hiddenInput = document.getElementById(`content_${currentDay}_${currentMeal}`);
    const selected = selectedDishes[currentDay][currentMeal];
    hiddenInput.value = selected.map(d => d.name).join(', ');
    
    // Update button text
    const button = document.querySelector(`[data-day="${currentDay}"][data-meal="${currentMeal}"]`);
    if (selected.length > 0) {
        // Hiển thị tên món, ngắn gọn nếu quá dài
        const dishNames = selected.map(d => d.name).join(', ');
        button.textContent = dishNames.length > 30 ? dishNames.substring(0, 30) + '...' : dishNames;
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
        button.style.whiteSpace = 'normal';
        button.style.textAlign = 'left';
    } else {
        button.textContent = 'Chọn món';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    }
    
    // Close modal
    var modalEl = document.getElementById('dishSelectionModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
}

function filterDishes() {
    const searchTerm = document.getElementById('dishSearch').value.toLowerCase();
    const dishItems = document.querySelectorAll('.dish-item');
    
    dishItems.forEach(item => {
        const dishName = item.querySelector('label').textContent.toLowerCase();
        if (dishName.includes(searchTerm)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
